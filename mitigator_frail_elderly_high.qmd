# Frail Older People (High Frailty Risk) Cohort {#sec-frail-elderly-high .unnumbered}

```{r}
library("flextable")
library("tidyr")
library("dplyr")
library("ggplot2")
library("StrategyUnitTheme")
library("forcats")
library("ComplexUpset")
library("scales")
library("targets")
library("plotly")
library("patchwork")
library("DT")

source("R/captions.R")
source("R/general.R")
source("R/descriptive_analyses.R")
source("R/comparative_analyses.R")
source("R/Functions for cohort overlap.R")
source("R/Functions for trend analysis.R")
source("R/manipulating_mitigators_and_mechanisms.R")

options(scipen = 999)
options(knitr.duplicate.label = "allow")

```

```{r global variables}
cohort <- "frail_elderly_high"
cohort_title <- "Frail Older People (high frailty)"
treatment_type <- "emergency"
treatment_type_title <- format_treatment_for_caption(treatment_type)
activity_type_label<-"admissions/beddays"
```

```{r}
#| output: false
mitigator_summary_table <- readxl::read_excel("summary_mitigators_table.xlsx") |>
  dplyr::mutate(mechanism = snakecase::to_snake_case(mechanism))

mechanisms <- mitigator_summary_table |> 
  dplyr::pull(mechanism) |> 
  unique()

england_age_sex_standardised_rates_episodes <- tar_read(england_age_sex_standardised_rates_episodes) |>
  filter(cohorts == cohort)

england_age_sex_standardised_rates_beddays <- tar_read(england_age_sex_standardised_rates_beddays) |>
  filter(cohorts == cohort)

total_beddays_admissions <- targets::tar_read(total_beddays_admissions)

icb_23_shp <- sf::st_read("https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/Integrated_Care_Boards_April_2023_EN_BGC/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson") |>
  janitor::clean_names() |>
  dplyr::mutate(icb23nm = simplify_icb_name(icb23nm))
```

```{r including_activity_types}
include_admissions <- check_include_admissions(cohort, mitigator_summary_table)
include_beddays <- check_include_beddays(cohort)
include_admissions_and_beddays <- include_admissions & include_beddays
```

This cohort includes older patients with a high level of frailty, specifically, those 75 years of age or over with an emergency admission and a frailty score over 15. The frailty score is calculated from ICD-10 diagnoses recorded for admissions during the previous 2 years and using the risk scores in Gilbert et al (2018), Development and validation of a Hospital Frailty Risk Score focusing on older people in acute care settings using electronic hospital records: an observational study. The Lancet, 391(10132), pp.1775-1782.

```{r}
#| output: asis
knitr::knit_child(
  input = "child-dir/_child-overview.qmd",
  envir = environment(),
  quiet = TRUE
  ) |>
  cat(sep = '\n')
```

## Descriptive Analysis of Mitigable Activity

### Patient Characteristics

In this section, the number and percentage of mitigable activity for the `r cohort_title` cohort are shown by patient characteristics: age, ethnic category, IMD decile and sex. Crude rates per 100,000 population are also provided for context.

Outputs are presented for both admissions and beddays, but patterns are broadly similar across the two.

::: panel-tabset
#### Age
```{r}
patient_characteristic <- "age"
patient_characteristic_col_name <- "age_range"
```

```{r}
#| output: asis
knitr::knit_child(
  input = "child-dir/_child-descriptive_patient-characteristics.qmd",
  envir = environment(),
  quiet = TRUE
  ) |>
  cat(sep = '\n')
```

#### Ethnicity
```{r}
patient_characteristic <- "ethnicity"
patient_characteristic_col_name <- "Ethnic_Category"
```

```{r}
#| output: asis
knitr::knit_child(
  input = "child-dir/_child-descriptive_patient-characteristics.qmd",
  envir = environment(),
  quiet = TRUE
  ) |>
  cat(sep = '\n')
```

#### IMD Decile
```{r}
patient_characteristic <- "imd"
patient_characteristic_col_name <- "imd19_decile"
```

```{r}
#| output: asis
knitr::knit_child(
  input = "child-dir/_child-descriptive_patient-characteristics.qmd",
  envir = environment(),
  quiet = TRUE
  ) |>
  cat(sep = '\n')
```

#### Sex
```{r}
patient_characteristic <- "sex"
patient_characteristic_col_name <- "sex"
```

```{r}
#| output: asis
knitr::knit_child(
  input = "child-dir/_child-descriptive_patient-characteristics.qmd",
  envir = environment(),
  quiet = TRUE
  ) |>
  cat(sep = '\n')
```
:::

### Admission Characteristics

```{r}
#| output: asis
knitr::knit_child(
  input = "child-dir/_child-descriptive_admission-characteristics.qmd",
  envir = environment(),
  quiet = TRUE
  ) |>
  cat(sep = '\n')
```

## Cohort overlap

```{r}
overlap_numbers <- targets::tar_read(total_cohort_numbers_2324)|>
  filter(!!rlang::sym(cohort) == 1)
```

```{r}
#| output: asis
knitr::knit_child(
  input = "child-dir/_child-overlap_number-within-others.qmd",
  envir = environment(),
  quiet = TRUE
  ) |>
  cat(sep = '\n')
```

### Inclusion within other mitigable activity cohorts

```{r}
#| output: asis
knitr::knit_child(
  input = "child-dir/_child-overlap_inclusion-within-others.qmd",
  envir = environment(),
  quiet = TRUE
  ) |>
  cat(sep = '\n')
```

### Most common cohort overlaps

```{r}
#| output: asis
knitr::knit_child(
  input = "child-dir/_child-overlap_most-common.qmd",
  envir = environment(),
  quiet = TRUE
  ) |>
  cat(sep = '\n')
```

## Comparative Analysis

### Integrated Care Board

```{r}
#| output: asis
knitr::knit_child(
                  input = "child-dir/_child-comparative_icb.qmd",
                  envir = environment(),
                  quiet = TRUE
                ) |>
                  cat(sep = '\n')
```

### Local Authority

```{r}
#| output: asis
knitr::knit_child(
                  input = "child-dir/_child-comparative_local-authority.qmd",
                  envir = environment(),
                  quiet = TRUE
                ) |>
                  cat(sep = '\n')
```

## Trend Analysis

```{r}
#| output: asis
knitr::knit_child(
  input = "child-dir/_child-trends_england.qmd",
  envir = environment(),
  quiet = TRUE
  ) |>
  cat(sep = '\n')

```


```{r}
#| output: asis
knitr::knit_child(
  input = "child-dir/_child-trends_icb.qmd",
  envir = environment(),
  quiet = TRUE
  ) |>
  cat(sep = '\n')
```

### Local Authority

```{r}
#| output: asis
knitr::knit_child(
  input = "child-dir/_child-trends_local-authority.qmd",
  envir = environment(),
  quiet = TRUE
  ) |>
  cat(sep = '\n')
```
