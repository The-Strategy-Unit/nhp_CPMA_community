# Total potentially mitigable activity {#sec-summary .unnumbered}

```{r}
library("flextable")
library("tidyr")
library("dplyr")
library("ggplot2")
library("StrategyUnitTheme")
library("forcats")
library("ComplexUpset")
library("scales")
library("targets")
library("plotly")
library("patchwork")
library("readxl")
library("ggVennDiagram")
library("stringr")

source("R/00_general.R")
source("R/02_descriptive-analyses.R")
source("R/03_cohort-overlap.R")
source("R/04_comparative-analyses.R")
source("R/05_trend-analyses.R")
source("R/06_manipulating-mitigators-and-mechanisms.R")
source("R/07_captions.R")

options(scipen = 999)

numbers_over_time<-tar_read(numbers_over_time)
numbers_over_time_total_mitigation<-targets::tar_read(numbers_over_time_total_mitigation)|>
  filter(fyear>"201415")
total_cohort_numbers_2324<-tar_read(total_cohort_numbers_2324)
icb_population_data<-tar_read(icb_population_data)
denominator_over_time<-tar_read(denominator_over_time)
england_age_sex_standardised_rates_beddays_total_mitigation<-tar_read(england_age_sex_standardised_rates_beddays_total_mitigation)
england_age_sex_standardised_rates_episodes_total_mitigation<-tar_read(england_age_sex_standardised_rates_episodes_total_mitigation)
```

```{r global variables}
cohort <- "all"
cohort_title <- "All Mitigation"
treatment_type <- "both"
treatment_type_title <- format_treatment_for_caption(treatment_type)
```

```{r}
number_percentage_over_time <- numbers_over_time_total_mitigation |>
  left_join(denominator_over_time,
            by = c("age_range", "sex", "year", "icb", "icb_2024_name")) |>
  summarise(
    episodes = janitor::round_half_up(sum(episodes, na.rm = TRUE), 0),
    beddays = janitor::round_half_up(sum(beddays, na.rm = TRUE), 0),
    total_episodes = sum(total_episodes_all, na.rm = TRUE),
    total_beddays = sum(total_beddays_all, na.rm = TRUE),
    .by = c(icb, icb_2024_name, year)
  ) |>
  filter(year != "2014/15") |>
  mutate(
    percentage_episodes = janitor::round_half_up((episodes / total_episodes) *
                                                   100, 1),
    percentage_beddays = janitor::round_half_up((beddays / total_beddays) *
                                                  100, 1)
  ) |>
  as.data.frame()
```

The number of admissions and beddays for potentially mitigable activity for England in 2023/24 for each mechanism of mitigation group is presented below. Redirection/Substitution has the greatest number of potentially mitigable admissions and Efficiencies has the greatest number of potentially mitigable beddays.

```{r}
total_mitigator_activity <- numbers_over_time_total_mitigation |>
  filter(year == "2023/24") |>
  summarise(episodes = sum(episodes), beddays = sum(beddays)) |>
  dplyr::mutate(mechanism = "Total potential mitigable activity", 
                .before = "episodes")

total_cohort_numbers_2324 |>
  generate_data_for_mechanism_cohort_overlaps() |>
  gather(key = mechanism, value = value, -episodes, -beddays) |>
  filter(value != 0) |>
  summarise(
    episodes = sum(episodes),
    beddays = sum(beddays),
    .by = mechanism
  ) |>
  mutate(episodes = ifelse(mechanism == "Efficiencies", NA, episodes)) |>
  rbind(total_mitigator_activity) |>
  flextable() |>
  set_header_labels(episodes = "Admissions",
                    beddays = "Beddays",
                    mechanism = "Mechanism of mitigation") |>
  align(part = "header", align = "left") |>
  bg(bg = "#f9bf07", part = "header") |>
  bold(bold = TRUE, part = "header") |>
  fontsize(size = 10, part = "body") |>
  fontsize(size = 11, part = "header") |>
  padding(padding = 2,
          part = "all",
          padding.top = NULL) |>
  autofit() |>
  flextable::hline(i = 4, border = flextable::fp_border_default())
```

Note: The sum of all the admissions and beddays for each mechanism does not add up to the total potential mitigable activity, as much of the activity is included within more than one mechanism of mitigation group and and thus adding the numbers for each group will lead to double counting. The numbers provided for the total potential mitigable activity excludes any double counting as a result of activity being including in multiple mitigator cohorts.

## Overlap between the mechanism of mitigation groups

Many admissions meet the criteria to be included in more than one mechanism of mitigation group. Since these potential mechanism of mitigation groups are not mutually exclusive there is a need to understand which groups overlap and the degree of overlap between the cohorts.

:::panel-tabset

#### Admissions

::: columns
::: {.column width="70%"}
```{r, fig.width=4, fig.height=4}
#| label: fig-overlap_mechanism_cohorts_episodes
#| fig-cap: Venn diagram showing the overlap in admissions between the mechanisms of mitigation groups.

total_cohort_numbers_2324 <- tar_read(total_cohort_numbers_2324)

generate_venn_diagram(total_cohort_numbers_2324, episodes)
```
:::

::: {.column width="30%"}
```{r, fig.width=3, fig.height=4}
#| label: fig-number_of_mechanism_groups_episodes
#| fig-cap: Number of mechanism groups the admissions are a part of.

plotting_barchart_number_of_mechanism_groups(total_cohort_numbers_2324, episodes)
```
:::

Note: Efficiency mitigators do not impact the number of admissions, only the length of stay, hence they do not overlap in terms of admissions with the other cohorts.
:::

The majority of potentially mitigable admissions (57%) are purely for activity in the Redirection/Substitution group where activity could be redirected to perhaps community services. Just over a fifth of potentially mitigable activity (22%) is activity that could be prevented perhaps through public health initiatives.

Almost 80% of potentially mitigable admissions fall into just one mechanism of mitigation group.

#### Beddays

::: columns
::: {.column width="70%"}
```{r, fig.width=7, fig.height=4}
#| label: fig-overlap_mechanism_cohorts_beddays
#| fig-cap: Venn diagram showing the overlap in beddays between the mechanisms of mitigation groups.

generate_venn_diagram(total_cohort_numbers_2324, beddays)
```
:::

::: {.column width="30%"}
```{r, fig.width=3, fig.height=4}
#| label: fig-number_of_mechanism_groups_beddays
#| fig-cap: Number of mechanism groups the beddays are a part of.

plotting_barchart_number_of_mechanism_groups(total_cohort_numbers_2324, beddays)
```
:::
:::

The majority of potentially mitigable beddays are included in multiple mechanism of mitigation groups; with only 28% of potentially mitgable beddays falling within a single mechanism group. 

There is a significant proportion of beddays that fall into both the Redirection/Substitution and Efficiencies mechanism groups (44%).

:::

## Comparative Analysis

This analysis is to explore how total potentially mitigable activity varies by Integrated Care Board and Local Authority.

```{r}
#| output: false
summary_icb_admissions_all <- targets::tar_read(summary_icb_admissions_all)
summary_icb_beddays_all <- targets::tar_read(summary_icb_beddays_all)

icb_23_shp <- sf::st_read("https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/Integrated_Care_Boards_April_2023_EN_BSC/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson") |>
  janitor::clean_names() |>
  dplyr::mutate(icb23nm = simplify_icb_name(icb23nm))

number_icb_admissions_all_map <- summary_icb_admissions_all |>
  get_summary_by_icb_map(icb_23_shp, "total_count")

perc_icb_admissions_all_map <- summary_icb_admissions_all |>
  get_summary_by_icb_map(icb_23_shp, "perc")

rate_icb_admissions_all_map <- summary_icb_admissions_all |>
  get_summary_by_icb_map(icb_23_shp, "value")

number_icb_beddays_all_map <- summary_icb_beddays_all |>
  get_summary_by_icb_map(icb_23_shp, "total_count")

perc_icb_beddays_all_map <- summary_icb_beddays_all |>
  get_summary_by_icb_map(icb_23_shp, "perc")

rate_icb_beddays_all_map <- summary_icb_beddays_all |>
  get_summary_by_icb_map(icb_23_shp, "value")
```

### Integrated Care Board

Potentially mitigable activity varies by Integrated Care Board (ICB). Below the number, percentage and age and sex standardised rates per 100,000 population of mitigable activity are presented by ICB. Bar charts and maps allow for comparisons between ICBs and to spot potential regional differences and a table of these values is also available. In this table columns can be ordered and specific ICBs can be searched for.

::: panel-tabset
#### Number

::: panel-tabset
##### Bars

::: panel-tabset
###### Admissions
```{r}
#| label: fig-number_icb_admissions_all_bar
#| fig-cap: !expr get_caption_by_geography(cohort_title, "number", "admissions")
england_value <- get_england_value(
  "total_count", 
  data = summary_icb_admissions_all)

get_summary_by_icb_bar(
  summary_icb_admissions_all, 
  "total_count", 
  cohort,
  england_value)

rm(england_value)
```

###### Beddays
```{r}
#| label: fig-number_icb_beddays_all_bar
#| fig-cap: !expr get_caption_by_geography(cohort_title, "number", "beddays")
england_value <- get_england_value(
  "total_count", 
  data = summary_icb_beddays_all)

get_summary_by_icb_bar(
  summary_icb_beddays_all, 
  "total_count", 
  cohort,
  england_value)

rm(england_value)
```
:::

##### Map

::: panel-tabset
###### Admissions
```{r}
#| label: fig-number_icb_admissions_all_map
#| fig-cap: !expr get_caption_by_geography(cohort_title, "number", "admissions")
number_icb_admissions_all_map
```

###### Beddays
```{r}
#| label: fig-number_icb_beddays_all_map
#| fig-cap: !expr get_caption_by_geography(cohort_title, "number", "beddays")
number_icb_beddays_all_map
```
:::
:::

#### Percentage of `r treatment_type_title` activity

::: panel-tabset
##### Bars

::: panel-tabset
###### Admissions
```{r}
#| label: fig-perc_icb_admissions_all_bar
#| fig-cap: !expr get_caption_by_geography(cohort_title, "perc", "admissions", treatment_type)
total_beddays_admissions <- targets::tar_read(total_beddays_admissions)

england_value <- get_england_value(
  "perc_total_mitigation",
  activity = "admissions",
  treatment = treatment_type,
  data = number_percentage_over_time)

get_summary_by_icb_bar(
  summary_icb_admissions_all, 
  "perc", 
  cohort,
  england_value)

rm(england_value)
```

###### Beddays
```{r}
#| label: fig-perc_icb_beddays_all_bar
#| fig-cap: !expr get_caption_by_geography(cohort_title, "perc", "beddays", treatment_type)

england_value <- get_england_value(
  "perc_total_mitigation",
  activity = "beddays",
  treatment = treatment_type,
  data = number_percentage_over_time)

get_summary_by_icb_bar(
  summary_icb_beddays_all,
  "perc",
  cohort,
  england_value)

rm(england_value)
```
:::

##### Map

::: panel-tabset
###### Admissions
```{r}
#| label: fig-perc_icb_admissions_all_map
#| fig-cap: !expr get_caption_by_geography(cohort_title, "perc", "admissions", treatment_type)
perc_icb_admissions_all_map
```

###### Beddays
```{r}
#| label: fig-perc_icb_beddays_all_map
#| fig-cap: !expr get_caption_by_geography(cohort_title, "perc", "beddays", treatment_type)
perc_icb_beddays_all_map
```
:::
:::

#### Age and sex standardised rates per 100,000 population

::: panel-tabset
##### Bars

::: panel-tabset
###### Admissions
```{r}
#| label: fig-rate_icb_admissions_all_bar
#| fig-cap: !expr get_caption_by_geography(cohort_title, "SR", "admissions")
england_value <- get_england_value(
  "value",
  data = england_age_sex_standardised_rates_episodes_total_mitigation,
  cohort = cohort)

get_summary_by_icb_bar(
  summary_icb_admissions_all, 
  "value", 
  cohort,
  england_value)

rm(england_value)
```

###### Beddays
```{r}
#| label: fig-rate_icb_beddays_all_bar
#| fig-cap: !expr get_caption_by_geography(cohort_title, "SR", "beddays")
england_value <- get_england_value(
  "value",
  data = england_age_sex_standardised_rates_beddays_total_mitigation,
  cohort = cohort)

get_summary_by_icb_bar(
  summary_icb_beddays_all,
  "value",
  cohort,
  england_value)

rm(england_value)
```
:::

##### Map

::: panel-tabset
###### Admissions
```{r}
#| label: fig-rate_icb_admissions_all_map
#| fig-cap: !expr get_caption_by_geography(cohort_title, "SR", "admissions")
rate_icb_admissions_all_map
```

###### Beddays
```{r}
#| label: fig-rate_icb_beddays_all_map
#| fig-cap: !expr get_caption_by_geography(cohort_title, "SR", "beddays")
rate_icb_beddays_all_map
```
:::
:::

#### Table

::: panel-tabset
###### Admissions
```{r}
#| label: tbl-rate_icb_admissions_all
#| tbl-cap: !expr get_caption_by_geography_table(cohort_title, "admissions", treatment_type, "icb")
get_summary_by_geography_table(
  summary_icb_admissions_all,
  "episodes", 
  treatment_type)
```

###### Beddays
```{r}
#| label: tbl-rate_icb_beddays_all
#| tbl-cap: !expr get_caption_by_geography_table(cohort_title, "beddays", treatment_type, "icb")
get_summary_by_geography_table(
  summary_icb_beddays_all, 
  "beddays", 
  treatment_type)
```
:::
:::

### Local Authority

To explore how potentially mitigable activity may vary between Local Authority (LA) the table below contains the number, percentage and age and sex standardised rates per 100,000 population of mitigable activity by LA. Columns in the table can be ordered and specific LAs can be searched for.

::: panel-tabset

#### Admissions
```{r}
#| label: tbl-rate_la_admissions_all
#| tbl-cap: !expr get_caption_by_geography_table(cohort_title, "admissions", treatment_type, "la")
targets::tar_read(summary_la_admissions_all) |>
  get_summary_by_geography_table("episodes", treatment_type)
```

#### Beddays
```{r}
#| label: tbl-rate_la_beddays_all
#| tbl-cap: !expr get_caption_by_geography_table(cohort_title, "beddays", treatment_type, "la")
targets::tar_read(summary_la_beddays_all) |>
  get_summary_by_geography_table("beddays", treatment_type)
```

:::

### Acute provider

To explore how potentially mitigable activity may vary between by acute NHS providers the table below contains the number, percentage and age and sex standardised rates per 100,000 population of mitigable activity by acute NHS providers. Columns in the table can be ordered and specific providers and the ICB system that the providers are aligned with can be searched for.

::: panel-tabset

#### Admissions
```{r}
#| label: tbl-rate_provider_admissions_all
#| tbl-cap: !expr get_caption_by_geography_table(cohort_title, "admissions", treatment_type, "provider")
targets::tar_read(summary_provider_admissions_all) |>
  get_summary_by_geography_table("episodes", treatment_type)
```

#### Beddays
```{r}
#| label: tbl-rate_provider_beddays_all
#| tbl-cap: !expr get_caption_by_geography_table(cohort_title, "beddays", treatment_type, "provider")
targets::tar_read(summary_provider_beddays_all) |>
  get_summary_by_geography_table("beddays", treatment_type)
```

:::

## Trend Analysis

We aim to understand whether there have been decreases, or increases, in potentially mitigable activity over time. We have considered total mitigable admissions and beddays over the past 9 years in England as a whole and for each ICB, including:

a\) the absolute number of admissions/beddays,

b\) these admissions/beddays as a proportion of total admissions,

c\) the age and sex standardised rates of these admissions/beddays using the England 2021 census population.

To help understand the variability between ICBs we have calculated for each ICB the percentage change between 2018/19 and 2023/24.

### England

::: panel-tabset
#### Number over time

```{r}
# England average numbers and % change
england_average_numbers_episodes <- calculating_england_average_numbers(number_percentage_over_time, episodes)

england_average_numbers_beddays <- calculating_england_average_numbers(number_percentage_over_time, beddays)

# England average percentages and % change
england_average_percentage_beddays <- calculating_england_average_percentage(
  number_percentage_over_time |>
    filter(!is.nan(percentage_episodes)), 
  beddays, 
  total_beddays)

england_average_percentage_episodes <- calculating_england_average_percentage(
  number_percentage_over_time |>  
    filter(!is.nan(percentage_episodes)), 
  episodes, 
  total_episodes)

# England standardised rate and % change
england_average_standardised_episodes_total_mitigation <- calculating_england_average_standardised(england_age_sex_standardised_rates_episodes_total_mitigation)

england_average_standardised_beddays_total_mitigation <- calculating_england_average_standardised(england_age_sex_standardised_rates_beddays_total_mitigation)
```

Over the last 5 years (2018/19 to 2023/24), there has been a `r england_average_numbers_episodes$change` % increase in the percentage of admissions that are for potentially mitigable activity and a `r england_average_numbers_beddays$change` % increase in the percentage of beddays that are for potentially mitigable activity.

::: panel-tabset
#### Admissions

```{r, fig.width=7, fig.height=3}
#| label: fig-number_trends_spells_england_all_mitigators
#| fig-cap: The number of admissions for all mitigable activity in England over the last 9 years.

plot_of_number_over_time(number_percentage_over_time, episodes)
```

#### Beddays

```{r, fig.width=7, fig.height=3}
#| label: fig-number_trends_beddays_england_all_mitigators
#| fig-cap: The number of beddays for all mitigable activity cohort in England over the last 9 years. 

plot_of_number_over_time(number_percentage_over_time,  beddays)
```
:::

#### Percentage of total activity

Total mitigable activity as a percentage of total activity (elective and emergency admissions/beddays).

Over the last 5 years (2018/19 to 2023/24), there has been a `r england_average_percentage_episodes$change` % increase in potentially mitigable admissions and a `r england_average_percentage_beddays$change` % increase in potentially mitigable beddays.

::: panel-tabset
#### Admissions

```{r, fig.width=7, fig.height=3}
#| label: fig-percent_trends_spells_england
#| fig-cap: The percentage of admissions for potentially mitigable activity in England over the last 9 years. 

plot_of_percentage_over_time(number_percentage_over_time |> 
                               filter(!is.na(percentage_episodes)),
                             episodes, 
                             total_episodes)
```

#### Beddays

```{r, fig.width=7, fig.height=3}
#| label: fig-percent_trends_beddays_england
#| fig-cap: The percentage of beddays for potentially mitigable activity in England over the last 9 years. 

plot_of_percentage_over_time(number_percentage_over_time |>
                               filter(!is.na(percentage_beddays)),  
                             beddays, 
                             total_beddays)
```
:::

#### Age and sex standardised rates per 100,000 population

Over the last 5 years (2018/19 to 2023/24), when accounting for changes in the population age and sex, there has been a `r england_average_standardised_episodes_total_mitigation$change` % decrease in potentially mitigable admissions and a `r england_average_standardised_beddays_total_mitigation$change` % decrease in potentially mitigable beddays. 

This indicates there are trends towards both a reduction in admissions and reduced length of stays for potentially mitigable activity. However, total numbers of admissions and beddays for potentially mitigable activity are increasing due to an aging population.

::: panel-tabset
#### Admissions

```{r, fig.width=7, fig.height=3}
#| label: fig-stardardised_trends_spells_england
#| fig-cap: Age and sex standardised rate of potentially mitigable admissions in England over the last 9 years. 

plot_of_standardised_rates_over_time(
  england_age_sex_standardised_rates_episodes_total_mitigation)
```

#### Beddays

```{r, fig.width=7, fig.height=3}
#| label: fig-stardardised_trends_beddays_england
#| fig-cap: Age and sex standardised rate of potentially mitigable beddays in England over the last 9 years.

plot_of_standardised_rates_over_time(
  england_age_sex_standardised_rates_beddays_total_mitigation)
```
:::
:::

### Integrated Care Board

Total potentially mitigable activity over time is shown for each ICB to demonstrate the patterns of change and the degree of variability between ICBs over time. The percentage change in total potentially mitigable activity between 2018/19 and 2023/24 is compared across ICBs and shown relative to the England average. 

Note: Low numbers of admissions/beddays for Frimley ICB in 2022/23 reflect an issue with data submissions for this period.

::: panel-tabset
#### Number over time

::: panel-tabset
#### Admissions

```{r, fig.width=5, fig.height=3}
#| label: fig-number_trends_spells_icb
#| fig-cap: The number of admissions for all potentially mitigable activity by ICB over the last 9 years. 

number_percentage_over_time_removing_icb_na <- number_percentage_over_time |>
  filter(!is.na(icb_2024_name))

plotting_icb_over_time(
  number_percentage_over_time_removing_icb_na |>
    mutate(activity = episodes),
  'Number'
)
```

<br>

```{r, fig.height=6, fig.width=8}
#| label: fig-percent_change_number_spells
#| fig-cap: The percentage change in the number of potentially mitigable admissions by ICB between 2018/19 and 2023/24. 

plotting_percentage_change_over_time_by_icb(
  number_percentage_over_time |> 
    filter(!is.na(icb_2024_name)),
  episodes,
  icb_2024_name ,
  england_average_numbers_episodes$change
)
```

#### Beddays

```{r, fig.width=5, fig.height=3}
#| label: fig-number_trends_beddays_icb
#| fig-cap: The number of beddays for all potentially mitigable activity by ICB over the last 9 years. 

plotting_icb_over_time(number_percentage_over_time_removing_icb_na |>
                         mutate(activity = beddays),
                       'Number')
```

<br>

```{r, fig.height=6, fig.width=8}
#| label: fig-percent_change_number_beddays
#| fig-cap: The percentage change in the number of potentially mitigable beddays by ICB between 2018/19 and 2023/24. 

plotting_percentage_change_over_time_by_icb(
  number_percentage_over_time |> 
    filter(!is.na(icb_2024_name)),
  beddays,
  icb_2024_name,
  england_average_numbers_beddays$change
)
```
:::

#### Percentage of total activity

Total mitigable activity as a percentage of total elective and emergency admissions/beddays.

::: panel-tabset
#### Admissions

```{r, fig.width=5, fig.height=3}
#| label: fig-percent_trends_spells_icb
#| fig-cap: The percentage of admissions for potentially mitigable activity by ICB over the last 9 years. 

plotting_icb_over_time(
  number_percentage_over_time_removing_icb_na |>
    filter(!is.nan(percentage_episodes)) |>
    mutate(activity = percentage_episodes),
  'Percentage'
)
```

<br>

```{r, fig.height=6, fig.width=8}
#| label: fig-percent_change_percent_spells
#| fig-cap: The percentage change in the proportion emergency admissions that are for potentially mitigable admissions by ICB between 2018/19 and 2023/24. 

plotting_percentage_change_over_time_by_icb(
  number_percentage_over_time_removing_icb_na,
  percentage_episodes,
  icb_2024_name,
  england_average_percentage_episodes$change
)
```

#### Beddays

```{r, fig.width=5, fig.height=3}
#| label: fig-percent_trends_beddays_icb
#| fig-cap: The percentage of beddays for potentially mitigable activity by ICB over the last 9 years. 

plotting_icb_over_time(
  number_percentage_over_time_removing_icb_na |>
    filter(!is.nan(percentage_beddays)) |>
    mutate(activity = percentage_beddays),
  'Percentage'
)
```

<br>

```{r, fig.height=6, fig.width=8}
#| label: fig-percent_change_percent_beddays
#| fig-cap: The percentage change in the proportion emergency beddays that are for potentially mitigable beddays by ICB between 2018/19 and 2023/24. 

plotting_percentage_change_over_time_by_icb(
  number_percentage_over_time_removing_icb_na,
  percentage_beddays,
  icb_2024_name,
  england_average_percentage_beddays$change
)
```
:::

#### Age and sex standardised rates per 100,000 population

::: panel-tabset
#### Admissions

```{r, fig.width=5, fig.height=3}
#| label: fig-stardardised_trends_spells_icb
#| fig-cap: Age and sex standardised rate of potentially mitigable admissions by ICB over the last 9 years. 

icb_age_sex_standardised_rates_episodes_total_mitigation <- tar_read(icb_age_sex_standardised_rates_episodes_total_mitigation)

plotting_icb_over_time(
  (
    icb_age_sex_standardised_rates_episodes_total_mitigation |>
      mutate(activity = value)
  ),
  'Standardised rate per 100,000'
)
```

<br>

```{r, fig.height=6, fig.width=8}
#| label: fig-percent_change_standardised_spells
#| fig-cap: The percentage change in the standardised rate of potentially mitigable admissions by ICB between 2018/19 and 2023/24. 

plotting_percentage_change_over_time_by_icb(
  icb_age_sex_standardised_rates_episodes_total_mitigation,
  value,
  icb_2024_name,
  england_average_standardised_episodes_total_mitigation$change
)
```

#### Beddays

```{r, fig.width=5, fig.height=3}
#| label: fig-stardardised_trends_beddays_icb
#| fig-cap: Age and sex standardised rate of potentially mitigable beddays by ICB over the last 9 years.

icb_age_sex_standardised_rates_beddays_total_mitigation <- tar_read(icb_age_sex_standardised_rates_beddays_total_mitigation)

plotting_icb_over_time(
  (
    icb_age_sex_standardised_rates_beddays_total_mitigation |>
      mutate(activity = value)
  ),
  'Standardised rate per 100,000'
)
```

<br>

```{r, fig.height=6, fig.width=8}
#| label: fig-percent_change_standardised_beddays
#| fig-cap: The percentage change in the standardised rate of potentially mitigable beddays by ICB between 2018/19 and 2023/24. 

plotting_percentage_change_over_time_by_icb(
  icb_age_sex_standardised_rates_beddays_total_mitigation,
  value,
  icb_2024_name,
  england_average_standardised_beddays_total_mitigation$change
)
```
:::
:::

#### Change in standardised rate over the last 5 years, relative to the starting rate in 2018/19, by ICB.

This chart shows the percentage change in the age and sex standardised rate per 100,000 population for each ICB (between 2018/19 and 2023/24) relative to it's starting rate in 2018/19, to help demonstrate performance across ICBs. 

Those ICBs in the lower left quadrant (shaded in green) could be considered as performing well; they already had relatively low standardised rates of admissions/beddays in 2018/19 and have continued to make further decreases over the last five years.

::: panel-tabset
#### Admissions

```{r, fig.width=5, fig.height=4}
#| label: fig-activity_vs_rate_of_change_episodes
#| fig-cap: The standardised rate of potentially mitigable admissions (in 2018/19) versus the percentage change in admissions between 2018/19 and 2023/24 for ICBs. 

plotting_total_activity_vs_percentage_change(icb_age_sex_standardised_rates_episodes_total_mitigation)
```

#### Beddays

```{r, fig.width=5, fig.height=4}
#| label: fig-activity_vs_rate_of_change_beddays
#| fig-cap: The standardised rate of potentially mitigable beddays (in 2018/19) versus the percentage change in beddays between 2018/19 and 2023/24 for ICBs. 
 
plotting_total_activity_vs_percentage_change(icb_age_sex_standardised_rates_beddays_total_mitigation)
```
:::


### Local Authority

::: panel-tabset

#### Admissions
```{r}
#| label: table-local_authority_over_time_episodes
#| tbl-cap: Table of the standardised rate of all potentially mitigable admissions by Local Authority over the last 5 years, including the percentage change between 2018/19 and 2023/24.  

la_age_sex_standardised_rates_episodes_total_mitigation <- tar_read(la_age_sex_standardised_rates_episodes_total_mitigation)

la_episode_table <- generating_la_or_provider_table(
  la_age_sex_standardised_rates_episodes_total_mitigation,
  cohort)

DT::datatable(la_episode_table)
```


#### Beddays
```{r}
#| label: table_local_authority_over_time_beddays
#| tbl-cap: Table of the standardised rate of all potentially mitigable beddays by Local Authority over the last 5 years, including the percentage change between 2018/19 and 2023/24.  

la_age_sex_standardised_rates_beddays_total_mitigation <- tar_read(la_age_sex_standardised_rates_beddays_total_mitigation)

la_beddays_table <- generating_la_or_provider_table(
  la_age_sex_standardised_rates_beddays_total_mitigation,
  cohort)

DT::datatable(la_beddays_table)
```

:::

### Acute provider

::: panel-tabset

#### Admissions
```{r}
#| label: table-provider_over_time_episodes
#| tbl-cap: Table of the standardised rate of all potentially mitigable admissions by acute NHS provider over the last 5 years, including the percentage change between 2018/19 and 2023/24.  

provider_age_sex_standardised_rates_episodes_total_mitigation <- tar_read(provider_age_sex_standardised_rates_episodes_total_mitigation)

provider_episode_table <- generating_la_or_provider_table(
  provider_age_sex_standardised_rates_episodes_total_mitigation,
  cohort)

DT::datatable(provider_episode_table)
```


#### Beddays
```{r}
#| label: table_provider_over_time_beddays
#| tbl-cap: Table of the standardised rate of all potentially mitigable beddays by acute NHS provider over the last 5 years, including the percentage change between 2018/19 and 2023/24.  

provider_age_sex_standardised_rates_beddays_total_mitigation <- tar_read(provider_age_sex_standardised_rates_beddays_total_mitigation)

provider_beddays_table <- generating_la_or_provider_table(
  provider_age_sex_standardised_rates_beddays_total_mitigation,
  cohort)

DT::datatable(provider_beddays_table)
```

:::
