# Frail Elderly Cohort (high frailty)

```{r}
library("flextable")
library("tidyr")
library("dplyr")
library("ggplot2")
library("StrategyUnitTheme")
library("forcats")
library("ComplexUpset")
library("scales")
library("targets")
library("plotly")

source("R/general.R")
source("R/descriptive_analyses.R")
source("R/Functions for cohort overlap.R")
source("R/Functions for trend analysis.R")

options(scipen = 999)
```

This cohort includes elderly patients with a high level of frailty, specifically, those 75 years of age or over with an emergency admission and a frailty score over 15. The frailty score is calculated from ICD-10 diagnoses recorded for admissions during the previous 2 years and using the risk scores in Gilbert et al (2018), Development and validation of a Hospital Frailty Risk Score focusing on older people in acute care settings using electronic hospital records: an observational study. The Lancet, 391(10132), pp.1775-1782.


## Descriptive Analysis of Mitigable Activity

```{r}
#| label: tbl-perc_frail
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24.
targets::tar_read(total_beddays_episodes_frail) |>
  get_table_perc()
```

### Patient Characteristics

::: panel-tabset

### Admissions

::: panel-tabset

### Age

::: panel-tabset

#### Perc

```{r}
#| label: tbl-perc_frail_age_spells
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by age.
targets::tar_read(perc_frail_age_spells) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_age_spells
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by age.
targets::tar_read(perc_frail_age_spells) |>
  get_perc_spells_by_group_plot("age_range")
```

#### Rates per 100,000

```{r}
#| label: tbl-rate_frail_age_spells
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by age.
targets::tar_read(rates_frail_age_spells) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_frail_age_spells
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by age.
targets::tar_read(rates_frail_age_spells) |>
  get_rates_by_group_plot("age_range")
```

:::

### Ethnicity

::: panel-tabset

#### Perc

```{r}
#| label: tbl-perc_frail_ethnicity_spells
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by ethnic category.
targets::tar_read(perc_frail_ethnicity_spells) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_ethnicity_spells
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by ethnic category.
targets::tar_read(perc_frail_ethnicity_spells) |>
  get_perc_spells_by_group_plot("Ethnic_Category")
```

#### Rates per 100,000

```{r}
#| label: tbl-rate_frail_ethnicity_spells
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by ethnic category.
targets::tar_read(rates_frail_ethnicity_spells) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_frail_ethnicity_spells
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by ethnic category.
targets::tar_read(rates_frail_ethnicity_spells) |>
  get_rates_by_group_plot("Ethnic_Category")
```

:::

### IMD

::: panel-tabset

#### Perc

```{r}
#| label: tbl-perc_frail_imd_spells
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by IMD decile.
targets::tar_read(perc_frail_imd_spells) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_imd_spells
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by IMD decile.
targets::tar_read(perc_frail_imd_spells) |>
  get_perc_spells_by_group_plot("imd19_decile")
```

#### Rates per 100,000

```{r}
#| label: tbl-rate_frail_imd_spells
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by IMD decile.
targets::tar_read(rates_frail_imd_spells) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_frail_imd_spells
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by IMD decile.
targets::tar_read(rates_frail_imd_spells) |>
  get_rates_by_group_plot("imd19_decile")
```

:::

### Sex

::: panel-tabset

#### Perc

```{r}
#| label: tbl-perc_frail_sex_spells
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by sex.
targets::tar_read(perc_frail_sex_spells) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_sex_spells
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by sex.
targets::tar_read(perc_frail_sex_spells) |>
  get_perc_spells_by_group_plot("sex")
```

#### Rates per 100,000

```{r}
#| label: tbl-rate_frail_sex_spells
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by sex.
targets::tar_read(rates_frail_sex_spells) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_frail_sex_spells
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by sex.
targets::tar_read(rates_frail_sex_spells) |>
  get_rates_by_group_plot("sex")
```

:::

:::

### Beddays

::: panel-tabset

### Age

::: panel-tabset

#### Perc

```{r}
#| label: tbl-perc_frail_age_beddays
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by age.
targets::tar_read(perc_frail_age_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_age_beddays
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by age.
targets::tar_read(perc_frail_age_beddays) |>
  get_perc_spells_by_group_plot("age_range")
```

#### Rates per 100,000

```{r}
#| label: tbl-rate_frail_age_beddays
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by age.
targets::tar_read(rates_frail_age_beddays) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_frail_age_beddays
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by age.
targets::tar_read(rates_frail_age_beddays) |>
  get_rates_by_group_plot("age_range")
```

:::

### Ethnicity

::: panel-tabset

#### Perc

```{r}
#| label: tbl-perc_frail_ethnicity_beddays
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by ethnic category.
targets::tar_read(perc_frail_ethnicity_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_ethnicity_beddays
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by ethnic category.
targets::tar_read(perc_frail_ethnicity_beddays) |>
  get_perc_spells_by_group_plot("Ethnic_Category")
```

#### Rates per 100,000

```{r}
#| label: tbl-rate_frail_ethnicity_beddays
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by ethnic category.
targets::tar_read(rates_frail_ethnicity_beddays) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_frail_ethnicity_beddays
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by ethnic category.
targets::tar_read(rates_frail_ethnicity_beddays) |>
  get_rates_by_group_plot("Ethnic_Category")
```

:::

### IMD

::: panel-tabset

#### Perc

```{r}
#| label: tbl-perc_frail_imd_beddays
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by IMD decile.
targets::tar_read(perc_frail_imd_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_imd_beddays
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by IMD decile.
targets::tar_read(perc_frail_imd_beddays) |>
  get_perc_spells_by_group_plot("imd19_decile")
```

#### Rates per 100,000

```{r}
#| label: tbl-rate_frail_imd_beddays
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by IMD decile.
targets::tar_read(rates_frail_imd_beddays) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_frail_imd_beddays
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by IMD decile.
targets::tar_read(rates_frail_imd_beddays) |>
  get_rates_by_group_plot("imd19_decile")
```

:::

### Sex

::: panel-tabset

#### Perc

```{r}
#| label: tbl-perc_frail_sex_beddays
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by sex.
targets::tar_read(perc_frail_sex_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_sex_beddays
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by sex.
targets::tar_read(perc_frail_sex_beddays) |>
  get_perc_spells_by_group_plot("sex")
```

#### Rates per 100,000

```{r}
#| label: tbl-rate_frail_sex_beddays
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by sex.
targets::tar_read(rates_frail_sex_beddays) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_frail_sex_beddays
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by sex.
targets::tar_read(rates_frail_sex_beddays) |>
  get_rates_by_group_plot("sex")
```

:::

:::

:::

### Admission Characteristics

:::panel-tabset

#### LOS

```{r}
#| label: tbl-perc_frail_los_spells
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by length of stay.
targets::tar_read(perc_frail_los_spells) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_los_spells
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by length of stay.
targets::tar_read(perc_frail_los_spells) |>
  get_perc_spells_by_group_plot("los_range")
```

#### Specialty

```{r}
#| label: tbl-perc_frail_mainspecf
#| tbl-cap: Top ten specialties of mitigable activity for Frail and Elderly Admissions in 2023-24.
# targets::tar_read(frail_specialties_top_ten) |>
#   get_table_perc() 
```

```{r}
#| label: fig-perc_frail_mainspecf
#| fig-cap: Top ten specialties of mitigable activity for Frail and Elderly Admissions in 2023-24.
# targets::tar_read(frail_specialties_top_ten) |>
#   ggplot2::ggplot(ggplot2::aes(perc, 
#                                reorder(specialty, perc),
#                                fill = 'bars_color')) + 
#   ggplot2::geom_col() +
#   ggplot2::scale_fill_manual(values = c('bars_color' = "#f9bf07"), 
#                              guide = 'none') +
#   StrategyUnitTheme::su_theme() +
#   ggplot2::labs(x = "Percentage of mitigable spells", 
#                 y = "Specialty")
```

:::

