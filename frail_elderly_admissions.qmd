# Frail Elderly Cohort (high frailty)

```{r}
library("flextable")
library("tidyr")
library("dplyr")
library("ggplot2")
library("StrategyUnitTheme")
library("forcats")
library("ComplexUpset")
library("scales")
library("targets")
library("plotly")
library("patchwork")

source("R/general.R")
source("R/descriptive_analyses.R")
source("R/Functions for cohort overlap.R")
source("R/Functions for trend analysis.R")

options(scipen = 999)
```

This cohort includes elderly patients with a high level of frailty, specifically, those 75 years of age or over with an emergency admission and a frailty score over 15. The frailty score is calculated from ICD-10 diagnoses recorded for admissions during the previous 2 years and using the risk scores in Gilbert et al (2018), Development and validation of a Hospital Frailty Risk Score focusing on older people in acute care settings using electronic hospital records: an observational study. The Lancet, 391(10132), pp.1775-1782.


## Descriptive Analysis of Mitigable Activity

```{r}
#| label: tbl-perc_frail
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24.
targets::tar_read(total_beddays_episodes_frail) |>
  get_table_perc()
```

### Patient Characteristics

::: panel-tabset

### Admissions

::: panel-tabset

### Age

::: panel-tabset

#### Perc

```{r}
#| label: tbl-perc_frail_age_admissions
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by age.
targets::tar_read(perc_frail_age_admissions) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_age_admissions
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by age.
targets::tar_read(perc_frail_age_admissions) |>
  get_perc_by_group_plot("age_range")
```

#### Rates per 100,000

```{r}
#| label: tbl-rate_frail_age_admissions
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by age.
targets::tar_read(rates_frail_age_admissions) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_frail_age_admissions
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by age.
targets::tar_read(rates_frail_age_admissions) |>
  get_rates_by_group_plot("age_range")
```

:::

### Ethnicity

::: panel-tabset

#### Perc

```{r}
#| label: tbl-perc_frail_ethnicity_admissions
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by ethnic category.
targets::tar_read(perc_frail_ethnicity_admissions) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_ethnicity_admissions
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by ethnic category.
targets::tar_read(perc_frail_ethnicity_admissions) |>
  get_perc_by_group_plot("Ethnic_Category")
```

#### Rates per 100,000

```{r}
#| label: tbl-rate_frail_ethnicity_admissions
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by ethnic category.
targets::tar_read(rates_frail_ethnicity_admissions) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_frail_ethnicity_admissions
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by ethnic category.
targets::tar_read(rates_frail_ethnicity_admissions) |>
  get_rates_by_group_plot("Ethnic_Category")
```

:::

### IMD

::: panel-tabset

#### Perc

```{r}
#| label: tbl-perc_frail_imd_admissions
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by IMD decile.
targets::tar_read(perc_frail_imd_admissions) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_imd_admissions
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by IMD decile.
targets::tar_read(perc_frail_imd_admissions) |>
  get_perc_by_group_plot("imd19_decile")
```

#### Rates per 100,000

```{r}
#| label: tbl-rate_frail_imd_admissions
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by IMD decile.
targets::tar_read(rates_frail_imd_admissions) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_frail_imd_admissions
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by IMD decile.
targets::tar_read(rates_frail_imd_admissions) |>
  get_rates_by_group_plot("imd19_decile")
```

:::

### Sex

::: panel-tabset

#### Perc

```{r}
#| label: tbl-perc_frail_sex_admissions
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by sex.
targets::tar_read(perc_frail_sex_admissions) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_sex_admissions
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by sex.
targets::tar_read(perc_frail_sex_admissions) |>
  get_perc_by_group_plot("sex")
```

#### Rates per 100,000

```{r}
#| label: tbl-rate_frail_sex_admissions
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by sex.
targets::tar_read(rates_frail_sex_admissions) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_frail_sex_admissions
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by sex.
targets::tar_read(rates_frail_sex_admissions) |>
  get_rates_by_group_plot("sex")
```

:::

:::

### Beddays

::: panel-tabset

### Age

::: panel-tabset

#### Perc

```{r}
#| label: tbl-perc_frail_age_beddays
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by age.
targets::tar_read(perc_frail_age_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_age_beddays
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by age.
targets::tar_read(perc_frail_age_beddays) |>
  get_perc_by_group_plot("age_range")
```

#### Rates per 100,000

```{r}
#| label: tbl-rate_frail_age_beddays
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by age.
targets::tar_read(rates_frail_age_beddays) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_frail_age_beddays
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by age.
targets::tar_read(rates_frail_age_beddays) |>
  get_rates_by_group_plot("age_range")
```

:::

### Ethnicity

::: panel-tabset

#### Perc

```{r}
#| label: tbl-perc_frail_ethnicity_beddays
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by ethnic category.
targets::tar_read(perc_frail_ethnicity_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_ethnicity_beddays
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by ethnic category.
targets::tar_read(perc_frail_ethnicity_beddays) |>
  get_perc_by_group_plot("Ethnic_Category")
```

#### Rates per 100,000

```{r}
#| label: tbl-rate_frail_ethnicity_beddays
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by ethnic category.
targets::tar_read(rates_frail_ethnicity_beddays) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_frail_ethnicity_beddays
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by ethnic category.
targets::tar_read(rates_frail_ethnicity_beddays) |>
  get_rates_by_group_plot("Ethnic_Category")
```

:::

### IMD

::: panel-tabset

#### Perc

```{r}
#| label: tbl-perc_frail_imd_beddays
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by IMD decile.
targets::tar_read(perc_frail_imd_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_imd_beddays
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by IMD decile.
targets::tar_read(perc_frail_imd_beddays) |>
  get_perc_by_group_plot("imd19_decile")
```

#### Rates per 100,000

```{r}
#| label: tbl-rate_frail_imd_beddays
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by IMD decile.
targets::tar_read(rates_frail_imd_beddays) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_frail_imd_beddays
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by IMD decile.
targets::tar_read(rates_frail_imd_beddays) |>
  get_rates_by_group_plot("imd19_decile")
```

:::

### Sex

::: panel-tabset

#### Perc

```{r}
#| label: tbl-perc_frail_sex_beddays
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by sex.
targets::tar_read(perc_frail_sex_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_sex_beddays
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by sex.
targets::tar_read(perc_frail_sex_beddays) |>
  get_perc_by_group_plot("sex")
```

#### Rates per 100,000

```{r}
#| label: tbl-rate_frail_sex_beddays
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by sex.
targets::tar_read(rates_frail_sex_beddays) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_frail_sex_beddays
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by sex.
targets::tar_read(rates_frail_sex_beddays) |>
  get_rates_by_group_plot("sex")
```

:::

:::

:::

### Admission Characteristics

:::panel-tabset

### Admissions

::: panel-tabset

#### LOS

```{r}
#| label: tbl-perc_frail_los_admissions
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by length of stay.
targets::tar_read(perc_frail_los_admissions) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_los_admissions
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by length of stay.
targets::tar_read(perc_frail_los_admissions) |>
  get_perc_by_group_plot("los_range")
```

#### Specialty

```{r}
#| label: tbl-perc_frail_mainspecf_admissions
#| tbl-cap: Top ten specialties of mitigable activity for Frail and Elderly Admissions in 2023-24.
targets::tar_read(frail_specialties_top_ten_admissions) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_mainspecf_admissions
#| fig-cap: Top ten specialties of mitigable activity for Frail and Elderly Admissions in 2023-24.
targets::tar_read(frail_specialties_top_ten_admissions) |>
  ggplot2::ggplot(ggplot2::aes(perc, 
                               reorder(specialty, perc),
                               fill = 'bars_color')) + 
  ggplot2::geom_col() +
  ggplot2::scale_fill_manual(values = c('bars_color' = "#f9bf07"), 
                             guide = 'none') +
  StrategyUnitTheme::su_theme() +
  ggplot2::labs(x = "Percentage of mitigable admissions", 
                y = "Specialty")
```

:::

### Beddays

::: panel-tabset

#### LOS

```{r}
#| label: tbl-perc_frail_los_beddays
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by length of stay.
targets::tar_read(perc_frail_los_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_los_beddays
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by length of stay.
targets::tar_read(perc_frail_los_beddays) |>
  get_perc_by_group_plot("los_range")
```

#### Specialty

```{r}
#| label: tbl-perc_frail_mainspecf_beddays
#| tbl-cap: Top ten specialties of mitigable activity for Frail and Elderly Admissions in 2023-24.
targets::tar_read(frail_specialties_top_ten_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_mainspecf_beddays
#| fig-cap: Top ten specialties of mitigable activity for Frail and Elderly Admissions in 2023-24.
targets::tar_read(frail_specialties_top_ten_beddays) |>
  ggplot2::ggplot(ggplot2::aes(perc, 
                               reorder(specialty, perc),
                               fill = 'bars_color')) + 
  ggplot2::geom_col() +
  ggplot2::scale_fill_manual(values = c('bars_color' = "#f9bf07"), 
                             guide = 'none') +
  StrategyUnitTheme::su_theme() +
  ggplot2::labs(x = "Percentage of mitigable beddays", 
                y = "Specialty")
```

:::

:::

## Cohort overlap

Many of the spells and beddays recorded include activity which falls into more than one mitigator cohort. Therefore we aim to understand which cohorts the Frail Elderly High cohort overlaps with and the extend of that overlap.

### Number and proportion within multiple other cohorts
For the Frail Elderly High activity we show how much of the activity is included in multiple other mitigable cohorts. Due to the definition of this mitigator all of those in this cohort are also in the Emergency Elderly cohort, so none of this group are solely in the Frail Elderly High cohort. One quarter of this cohort are included 5 or more additional mitigator cohorts.

::: panel-tabset

#### Admissions
```{r, fig.width=4, fig.height=4}
#| label: fig-number_of_cohorts_spells
#| fig-cap: The number and percentage of mitigator cohorts that the Frail Elderly spells are a part of (2023/24).

total_cohort_numbers<-targets::tar_read(total_cohort_numbers)|>
  filter(frail_elderly_high==1)


plotting_barchart_number_of_cohorts(total_cohort_numbers, episodes)
```


#### Beddays
```{r, fig.width=4, fig.height=4}
#| label: fig-number_of_cohorts_beddays
#| fig-cap: The number and percentage of mitigator cohorts that the Frail Elderly beddays are a part of (2023/24).

plotting_barchart_number_of_cohorts(total_cohort_numbers, beddays)
```

:::



### Inclusion within other mitigable activity cohorts
This shows whether the activity within the Elderly Frail High activity is also included in other mitigator cohorts, including where this occurs the number and percentage of Elderly Frail High activity that is also included within other mitigator cohorts. 

For example, Elderly Frail High cohort overlaps with all but 2 of the other mitigator cohorts. All the Elderly Frail High cohort activity is also included in the Emergency Elderly cohort, and 63% of this cohort are in the Alcohol Partially Attributable Chronic cohort.

::: panel-tabset

#### Admissions
```{r, fig.width=10, fig.height=6 }
#| label: fig-prop_other_cohorts_frail_spells
#| fig-cap: The number and proportion of Frail Elderly spells that are included in each of the other cohorts (2023/24).

plotting_barchart_summary_of_overlaps(total_cohort_numbers,"frail_elderly_high", episodes)

```

#### Beddays
```{r, fig.width=10, fig.height=6 }
#| label: fig-prop_other_cohorts_frail_beddays
#| fig-cap: The number and proportion of Frail Elderly beddays that are included in each of the other cohorts (2023/24).


plotting_barchart_summary_of_overlaps(total_cohort_numbers,"frail_elderly_high", beddays)

```
:::


### Most common cohort overlaps
These are the most common cohort combinations for the Elderly Frail High cohort. For this cohort there are a very large number of different cohort combinations, so there are many smaller size cohort combinations that are not shown (all combinations together would add to 100%).

::: panel-tabset

#### Admissions

```{r, fig.width=10, fig.height=6}
#| label: upset_plot_frail_elderly_high_episodes
#| fig-cap: The 15 most common mitigator cohort overlaps for Frail Elderly admissions (2023/24).

plot_upset_plot(total_cohort_numbers, episodes)
  
```
#### Beddays

```{r, fig.width=10, fig.height=6}
#| label: upset_plot_frail_elderly_high_bedday
#| fig-cap: The 15 most common mitigator cohort overlaps for Frail Elderly beddays (2023/24).

plot_upset_plot(total_cohort_numbers, beddays)
```

:::


## Trend Analysis

### England

::: panel-tabset
#### Number over time
::: panel-tabset

#### Admissions
```{r, fig.width=7, fig.height=3}
#| label: fig-number_trends_spells_england
#| fig-cap: The total number of admissions for the Frail Elderly High mitigable activity cohort in England over the last 10 years. 
numbers_over_time<-tar_read(numbers_over_time)

plot_of_number_over_time(numbers_over_time, "frail_elderly_high", episodes)

```
#### Beddays

```{r, fig.width=7, fig.height=3}
#| label: fig-number_trends_beddays_england
#| fig-cap: The total number of beddays for the Frail Elderly High mitigable activity cohort in England over the last 10 years. 
plot_of_number_over_time(numbers_over_time, "frail_elderly_high", beddays)

```
:::

#### By proportion of emergency activity 
::: panel-tabset
#### Admissions
```{r, fig.width=7, fig.height=3}
#| label: fig-percent_trends_spells_england
#| fig-cap: The percentage of total emergency admissions that are for Frail Elderly High potentially mitigable activity in England over the last 10 years. 

denominator_over_time<-tar_read(denominator_over_time)

plot_of_percentage_over_time(denominator_over_time, numbers_over_time, "frail_elderly_high", episodes, total_episodes_emergency)

```
#### Beddays
```{r, fig.width=7, fig.height=3}
#| label: fig-percent_trends_beddays_england
#| fig-cap: The percentage of total emergency beddays that are for Frail Elderly High potentially mitigable activity in England over the last 10 years. 

plot_of_percentage_over_time(denominator_over_time, numbers_over_time, "frail_elderly_high", beddays, total_beddays_emergency)

```

:::


#### Standardised rate over time

::: panel-tabset

#### Admissions
```{r, fig.width=7, fig.height=3}
#| label: fig-stardardised_trends_spells_england
#| fig-cap: Age and sex standardised rate of admissions for Frail Elderly High potentially mitigable activity in England over the last 10 years. 

england_age_sex_standardised_rates_episodes<-tar_read(england_age_sex_standardised_rates_episodes)

plot_of_standardised_rates_over_time(england_age_sex_standardised_rates_episodes,"frail_elderly_high")

```

#### Beddays
```{r, fig.width=7, fig.height=3}
#| label: fig-stardardised_trends_beddays_england
#| fig-cap: Age and sex standardised rate of beddays for Frail Elderly High potentially mitigable activity in England over the last 10 years.

england_age_sex_standardised_rates_beddays<-tar_read(england_age_sex_standardised_rates_beddays)

plot_of_standardised_rates_over_time(england_age_sex_standardised_rates_beddays,"frail_elderly_high")

```

:::


:::

### ICB

::: panel-tabset

#### Number over time
::: panel-tabset

#### Admissions
```{r, fig.width=7, fig.height=3}
#| label: fig-number_trends_spells_icb
#| fig-cap: The number of admissions for the Frail Elderly High mitigable activity cohort by ICB over the last 9 years. 

icb_population_data<-tar_read(icb_population_data)

numbers_over_time|>
    filter(cohorts=="frail_elderly_high")|>
    filter(fyear!=201415)|>
    group_by( icb, year)|>
    summarise(activity=sum(episodes))|>
  left_join(tar_read(icb_population_data)[,c("icb24cdh", "icb_2024_name")], by=c("icb"="icb24cdh"))|>
 group_by(icb_2024_name)|>
  highlight_key(~icb_2024_name) |>
plot_ly( x = ~year, y = ~activity, type = 'scatter',  mode = 'lines', text=~icb_2024_name,  line = list(color = "#686f73",  width = 1.5))|>
  highlight(~icb_2024_name, on = "plotly_click", off="plotly_doubleclick", dynamic=TRUE)|>
   layout(
         xaxis = list(title=list(text='Year', font = list(size = 20), standoff = 25), showticklabels = TRUE, showline = TRUE, showgrid = F , linewidth=2),
         yaxis = list(title = 'Number', showline = TRUE, showgrid = F , linewidth=2 ,zeroline = FALSE, tickformat = "digits", anchor="free", shift=100)
         )


```
#### Beddays

```{r, fig.width=7, fig.height=3}
#| label: fig-number_trends_beddays_icb
#| fig-cap: The number of beddays for the Frail Elderly High mitigable activity cohort by ICB over the last 9 years. 


```
:::

#### By proportion of emergency activity 
::: panel-tabset
#### Admissions
```{r, fig.width=7, fig.height=3}
#| label: fig-percent_trends_spells_icb
#| fig-cap: The percentage of total emergency admissions that are for Frail Elderly High potentially mitigable activity by ICB over the last 9 years. 


```
#### Beddays
```{r, fig.width=7, fig.height=3}
#| label: fig-percent_trends_beddays_icb
#| fig-cap: The percentage of total emergency beddays that are for Frail Elderly High potentially mitigable activity by ICB over the last 9 years. 


```

:::


#### Standardised rate over time

::: panel-tabset

#### Admissions


#### Beddays
:::

:::
## Comparative Analysis

### ICB

```{r}
#| output: false
data <- targets::tar_read(perc_frail_icb_admissions) |>
  dplyr::mutate(icb = stringr::str_to_upper(icb))

icb_pop <- targets::tar_read(icb_population_data) |>
  dplyr::filter(fyear == "2023/24") |>
  dplyr::summarise(pop = sum(icb_population), .by = c(icb24cdh, icb_2024_code))

icb_23_shp <- sf::st_read("https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/Integrated_Care_Boards_April_2023_EN_BGC/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson") |>
  janitor::clean_names()

# notes
  # value = number admissions at icb * 100 / population at icb
  # using 2023 icb shapefile
```

```{r}
#| label: fig-perc_frail_icb
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by icb.
icb_23_shp |>
  dplyr::left_join(icb_pop, by = c("icb23cd" = "icb_2024_code")) |>
  dplyr::left_join(data, by = c("icb24cdh" = "icb")) |>
  dplyr::mutate(value = janitor::round_half_up(admissions * 100 /
                                                  pop, 2)) |>
  ggplot2::ggplot() +
  ggplot2::geom_sf(ggplot2::aes(fill = value)) +
  ggplot2::theme_void()
```

