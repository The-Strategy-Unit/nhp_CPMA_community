# Frail Elderly Admissions

```{r}
library("flextable")
library("tidyr")
library("dplyr")
library("ggplot2")
library("StrategyUnitTheme")
library("forcats")
library("ComplexUpset")
library("scales")
library("targets")

source("R/general.R")
source("R/descriptive_analyses.R")
source("R/Functions for cohort overlap.R")

options(scipen = 999)
```

## Descriptive Analysis of Mitigable Activity

```{r}
#| label: tbl-perc_frail
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24.
targets::tar_read(total_beddays_episodes_frail) |>
  get_table_perc()
```

### Patient Characteristics

::: panel-tabset

### Age

::: panel-tabset

#### Perc

```{r}
#| label: tbl-perc_frail_age
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by age.
targets::tar_read(perc_spells_frail_age) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_age
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by age.
targets::tar_read(perc_spells_frail_age) |>
  get_perc_spells_by_group_plot("age_range")
```

#### Rates per 100,000

```{r}
#| label: tbl-rate_frail_age
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by age.
targets::tar_read(rates_per_pop_age_frail) |>
  get_rates_per_pop_table() 
```

```{r}
#| label: fig-rate_frail_age
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by age.
targets::tar_read(rates_per_pop_age_frail) |>
  get_rates_per_pop_plot("age_range")
```

:::

### Ethnicity

::: panel-tabset

#### Perc

```{r}
#| label: tbl-perc_frail_ethnicity
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by ethnic category.
targets::tar_read(perc_spells_frail_ethnicity) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_ethnicity
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by ethnic category.
targets::tar_read(perc_spells_frail_ethnicity) |>
  get_perc_spells_by_group_plot("Ethnic_Category")
```

#### Rates per 100,000

```{r}
#| label: tbl-rate_frail_ethnicity
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by ethnic category.
targets::tar_read(rates_per_pop_ethnicity_frail) |>
  get_rates_per_pop_table() 
```

```{r}
#| label: fig-rate_frail_ethnicity
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by ethnic category.
targets::tar_read(rates_per_pop_ethnicity_frail) |>
  get_rates_per_pop_plot("Ethnic_Category")
```

:::

### IMD

::: panel-tabset

#### Perc


```{r}
#| label: tbl-perc_frail_imd
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by IMD decile.
targets::tar_read(perc_spells_frail_imd) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_imd
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by IMD decile.
targets::tar_read(perc_spells_frail_imd) |>
  dplyr::mutate(imd19_decile = factor(imd19_decile)) |>
  get_perc_spells_by_group_plot("imd19_decile")
```

#### Rates per 100,000

```{r}
#| label: tbl-rate_frail_imd
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by IMD decile.
targets::tar_read(rates_per_pop_imd_frail) |>
  get_rates_per_pop_table() 
```

```{r}
#| label: fig-rate_frail_imd
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by IMD decile.
targets::tar_read(rates_per_pop_imd_frail) |>
  get_rates_per_pop_plot("imd19_decile")
```

:::

### Sex

::: panel-tabset

#### Perc


```{r}
#| label: tbl-perc_frail_sex
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by sex.
targets::tar_read(perc_spells_frail_sex) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_sex
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by sex.
targets::tar_read(perc_spells_frail_sex) |>
  get_perc_spells_by_group_plot("sex")
```

#### Rates per 100,000

```{r}
#| label: tbl-rate_frail_sex
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by sex.
targets::tar_read(rates_per_pop_sex_frail) |>
  get_rates_per_pop_table() 
```

```{r}
#| label: fig-rate_frail_sex
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by sex.
targets::tar_read(rates_per_pop_sex_frail) |>
  get_rates_per_pop_plot("sex")
```

:::

:::

### LOS

```{r}
#| label: tbl-perc_frail_los
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by length of stay.
targets::tar_read(perc_spells_frail_los) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_los
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by length of stay.
targets::tar_read(perc_spells_frail_los) |>
  get_perc_spells_by_group_plot("los_range")
```

### Specialty

```{r}
#| label: tbl-perc_frail_mainspecf
#| tbl-cap: Top 10 specialties of mitigable activity for Frail and Elderly Admissions in 2023-24.
specialty_key <- targets::tar_read(specialty_key) |>
  dplyr::rename(specialty = main_specialty_title,
                specialty_group = group)

frail_specialties <- targets::tar_read(perc_spells_frail_mainspef) |>
  dplyr::left_join(specialty_key, by = c("mainspef" = "dd_code"))

frail_specialties |>
  dplyr::arrange(desc(spells)) |>
  dplyr::slice(1:10) |>
  dplyr::select(specialty, spells, perc) |>
  get_table_perc() 
```

## Trend Analysis

## Comparative Analysis

### ICB

```{r}
#| output: false
data <- targets::tar_read(perc_spells_frail_icb) |>
  dplyr::mutate(icb = stringr::str_to_upper(icb))

icb_pop <- targets::tar_read(icb_population_data) |>
  dplyr::filter(fyear == "2023/24") |>
  dplyr::summarise(pop = sum(icb_population), .by = c(icb24cdh, icb_2024_code))

icb_23_shp <- sf::st_read("https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/Integrated_Care_Boards_April_2023_EN_BGC/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson") |>
  janitor::clean_names()

# notes
  # value = number spells at icb * 100 / population at icb
  # using 2023 icb shapefile
```

```{r}
#| label: fig-perc_frail_icb
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by icb.
icb_23_shp |>
  dplyr::left_join(icb_pop, by = c("icb23cd" = "icb_2024_code")) |>
  dplyr::left_join(data, by = c("icb24cdh" = "icb")) |>
  dplyr::mutate(value = janitor::round_half_up(spells * 100 /
                                                  pop, 2)) |>
  ggplot2::ggplot() +
  ggplot2::geom_sf(ggplot2::aes(fill = value)) +
  ggplot2::theme_void()
```

## Cohort overlap

### Proportion included in other mitigatable activity cohorts
```{r, fig.width=10, fig.height=6 }
#| label: fig-prop_other_cohorts_frail
#| fig-cap: The number and proportion of the Frail Elderly admissions that are included in each of the other cohorts (2023/24).

total_cohort_numbers<-targets::tar_read(total_cohort_numbers)|>
  filter(frail_elderly_high==1)


plotting_barchart_summary_of_overlaps(total_cohort_numbers,"frail_elderly_high", episodes)

```

### Most common cohort overlaps

```{r, fig.width=10, fig.height=6}
#| label: fig-upset_plot_frail
#| fig-cap: The 15 most common mitigator cohort overlaps for the Frail Elderly admissions (2023/24).
plot_upset_plot(total_cohort_numbers, episodes)

```

### Proportion within multiple cohorts
```{r, fig.width=4, fig.height=4}
#| label: fig-number_of_cohorts
#| fig-cap: The number and percentage of mitigator cohorts that the Frail Elderly admissions are a part of (2023/24).

plotting_barchart_number_of_cohorts(total_cohort_numbers, episodes)
```