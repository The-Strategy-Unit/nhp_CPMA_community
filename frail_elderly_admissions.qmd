# Frail Elderly Cohort (high frailty)

```{r}
library("flextable")
library("tidyr")
library("dplyr")
library("ggplot2")
library("StrategyUnitTheme")
library("forcats")
library("ComplexUpset")
library("scales")
library("targets")
library("plotly")

source("R/general.R")
source("R/descriptive_analyses.R")
source("R/Functions for cohort overlap.R")
source("R/Functions for trend analysis.R")

options(scipen = 999)
```

This cohort includes elderly patients with a high level of frailty, specifically, those 75 years of age or over with an emergency admission and a frailty score over 15. The frailty score is calculated from ICD-10 diagnoses recorded for admissions during the previous 2 years and using the risk scores in Gilbert et al (2018), Development and validation of a Hospital Frailty Risk Score focusing on older people in acute care settings using electronic hospital records: an observational study. The Lancet, 391(10132), pp.1775-1782.


## Descriptive Analysis of Mitigable Activity

```{r}
#| label: tbl-perc_frail
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24.
targets::tar_read(total_beddays_episodes_frail) |>
  get_table_perc()
```

### Patient Characteristics

::: panel-tabset

### Admissions

::: panel-tabset

### Age

::: panel-tabset

#### Perc

```{r}
#| label: tbl-perc_frail_spells_age
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by age.
targets::tar_read(perc_frail_spells_age) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_age
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by age.
targets::tar_read(perc_frail_spells_age) |>
  get_perc_spells_by_group_plot("age_range")
```

#### Rates per 100,000

```{r}
#| label: tbl-rate_frail_spellsage
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by age.
targets::tar_read(rates_per_pop_age_frail) |>
  get_rates_per_pop_table() 
```

```{r}
#| label: fig-rate_frail_age
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by age.
targets::tar_read(rates_per_pop_age_frail) |>
  get_rates_per_pop_plot("age_range")
```

:::

### Ethnicity

::: panel-tabset

#### Perc

```{r}
#| label: tbl-perc_frail_spells_ethnicity
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by ethnic category.
targets::tar_read(perc_frail_spells_ethnicity) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_ethnicity
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by ethnic category.
targets::tar_read(perc_frail_spells_ethnicity) |>
  get_perc_spells_by_group_plot("Ethnic_Category")
```

#### Rates per 100,000

```{r}
#| label: tbl-rate_frail_spellsethnicity
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by ethnic category.
targets::tar_read(rates_per_pop_ethnicity_frail) |>
  get_rates_per_pop_table() 
```

```{r}
#| label: fig-rate_frail_ethnicity
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by ethnic category.
targets::tar_read(rates_per_pop_ethnicity_frail) |>
  get_rates_per_pop_plot("Ethnic_Category")
```

:::

### IMD

::: panel-tabset

#### Perc

```{r}
#| label: tbl-perc_frail_spells_imd
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by IMD decile.
targets::tar_read(perc_frail_spells_imd) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_imd
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by IMD decile.
targets::tar_read(perc_frail_spells_imd) |>
  get_perc_spells_by_group_plot("imd19_decile")
```

#### Rates per 100,000

```{r}
#| label: tbl-rate_frail_spellsimd
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by IMD decile.
targets::tar_read(rates_per_pop_imd_frail) |>
  get_rates_per_pop_table() 
```

```{r}
#| label: fig-rate_frail_imd
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by IMD decile.
targets::tar_read(rates_per_pop_imd_frail) |>
  get_rates_per_pop_plot("imd19_decile")
```

:::

### Sex

::: panel-tabset

#### Perc

```{r}
#| label: tbl-perc_frail_spells_sex
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by sex.
targets::tar_read(perc_frail_spells_sex) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_sex
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by sex.
targets::tar_read(perc_frail_spells_sex) |>
  get_perc_spells_by_group_plot("sex")
```

#### Rates per 100,000

```{r}
#| label: tbl-rate_frail_spellssex
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by sex.
targets::tar_read(rates_per_pop_sex_frail) |>
  get_rates_per_pop_table() 
```

```{r}
#| label: fig-rate_frail_sex
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by sex.
targets::tar_read(rates_per_pop_sex_frail) |>
  get_rates_per_pop_plot("sex")
```

:::

:::

### Beddays

::: panel-tabset

### Age

::: panel-tabset

#### Perc

```{r}
#| label: tbl-perc_frail_beddays_age
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by age.
targets::tar_read(perc_frail_beddays_age) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_beddays_age
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by age.
targets::tar_read(perc_frail_beddays_age) |>
  get_perc_spells_by_group_plot("age_range")
```

#### Rates per 100,000

```{r}
#| label: tbl-rate_frail_beddays_age
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by age.
targets::tar_read(rates_per_pop_age_frail) |>
  get_rates_per_pop_table() 
```

```{r}
#| label: fig-rate_frail_beddays_age
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by age.
targets::tar_read(rates_per_pop_age_frail) |>
  get_rates_per_pop_plot("age_range")
```

:::

### Ethnicity

::: panel-tabset

#### Perc

```{r}
#| label: tbl-perc_frail_beddays_ethnicity
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by ethnic category.
targets::tar_read(perc_frail_beddays_ethnicity) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_beddays_ethnicity
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by ethnic category.
targets::tar_read(perc_frail_beddays_ethnicity) |>
  get_perc_spells_by_group_plot("Ethnic_Category")
```

#### Rates per 100,000

```{r}
#| label: tbl-rate_frail_beddays_ethnicity
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by ethnic category.
targets::tar_read(rates_per_pop_ethnicity_frail) |>
  get_rates_per_pop_table() 
```

```{r}
#| label: fig-rate_frail_beddays_ethnicity
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by ethnic category.
targets::tar_read(rates_per_pop_ethnicity_frail) |>
  get_rates_per_pop_plot("Ethnic_Category")
```

:::

### IMD

::: panel-tabset

#### Perc

```{r}
#| label: tbl-perc_frail_beddays_imd
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by IMD decile.
targets::tar_read(perc_frail_beddays_imd) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_beddays_imd
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by IMD decile.
targets::tar_read(perc_frail_beddays_imd) |>
  get_perc_spells_by_group_plot("imd19_decile")
```

#### Rates per 100,000

```{r}
#| label: tbl-rate_frail_beddays_imd
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by IMD decile.
targets::tar_read(rates_per_pop_imd_frail) |>
  get_rates_per_pop_table() 
```

```{r}
#| label: fig-rate_frail_beddays_imd
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by IMD decile.
targets::tar_read(rates_per_pop_imd_frail) |>
  get_rates_per_pop_plot("imd19_decile")
```

:::

### Sex

::: panel-tabset

#### Perc

```{r}
#| label: tbl-perc_frail_beddays_sex
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by sex.
targets::tar_read(perc_frail_beddays_sex) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_beddays_sex
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by sex.
targets::tar_read(perc_frail_beddays_sex) |>
  get_perc_spells_by_group_plot("sex")
```

#### Rates per 100,000

```{r}
#| label: tbl-rate_frail_beddays_sex
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by sex.
targets::tar_read(rates_per_pop_sex_frail) |>
  get_rates_per_pop_table() 
```

```{r}
#| label: fig-rate_frail_beddays_sex
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by sex.
targets::tar_read(rates_per_pop_sex_frail) |>
  get_rates_per_pop_plot("sex")
```

:::

:::

:::

### Admission Characteristics

:::panel-tabset

#### LOS

```{r}
#| label: tbl-perc_frail_los
#| tbl-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by length of stay.
targets::tar_read(perc_frail_spells_los) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_los
#| fig-cap: Mitigable activity for Frail and Elderly Admissions in 2023-24 by length of stay.
targets::tar_read(perc_frail_spells_los) |>
  get_perc_spells_by_group_plot("los_range")
```

#### Specialty

```{r}
#| label: tbl-perc_frail_mainspecf
#| tbl-cap: Top ten specialties of mitigable activity for Frail and Elderly Admissions in 2023-24.
targets::tar_read(frail_specialties_top_ten) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_mainspecf
#| fig-cap: Top ten specialties of mitigable activity for Frail and Elderly Admissions in 2023-24.
targets::tar_read(frail_specialties_top_ten) |>
  ggplot2::ggplot(ggplot2::aes(perc, 
                               reorder(specialty, perc),
                               fill = 'bars_color')) + 
  ggplot2::geom_col() +
  ggplot2::scale_fill_manual(values = c('bars_color' = "#f9bf07"), 
                             guide = 'none') +
  StrategyUnitTheme::su_theme() +
  ggplot2::labs(x = "Percentage of mitigable spells", 
                y = "Specialty")
```

:::

