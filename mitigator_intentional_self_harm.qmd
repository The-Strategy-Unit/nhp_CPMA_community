## Intentional Self Harm Admissions {#sec-intentional_self_harm .unnumbered}

```{r packages_and_options}
library("flextable")
library("tidyr")
library("dplyr")
library("ggplot2")
library("StrategyUnitTheme")
library("forcats")
library("ComplexUpset")
library("scales")
library("targets")
library("plotly")
library("patchwork")
library("DT")

source("R/00_general.R")
source("R/02_descriptive-analyses.R")
source("R/03_cohort-overlap.R")
source("R/04_comparative-analyses.R")
source("R/05_trend-analyses.R")
source("R/06_manipulating-mitigators-and-mechanisms.R")
source("R/07_captions.R")

options(scipen = 999)
options(knitr.duplicate.label = "allow")

knitr::knit_hooks$set(crop = knitr::hook_pdfcrop)
```

```{r global_variables}
cohort <- "intentional_self_harm"
cohort_title <- "Intentional Self Harm Admissions"

treatment_type <- "emergency"
cohort_group <- "cohort"
treatment_type_title <- format_treatment_for_caption("emergency")
```

```{r data}
#| output: false
mitigator_summary_table <- readxl::read_excel("reference/summary_mitigators_table.xlsx") |>
  dplyr::mutate(mechanism = snakecase::to_snake_case(mechanism))

england_age_sex_standardised_rates_episodes <- tar_read(england_age_sex_standardised_rates_episodes) |>
    filter(cohorts == cohort)

england_age_sex_standardised_rates_beddays <- tar_read(england_age_sex_standardised_rates_beddays) |>
    filter(cohorts == cohort)

total_beddays_admissions <- targets::tar_read(total_beddays_admissions)

icb_23_shp <- sf::st_read("https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/Integrated_Care_Boards_April_2023_EN_BSC/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson") |>
    janitor::clean_names() |>
    dplyr::mutate(icb23nm = simplify_icb_name(icb23nm))
```

```{r including_activity_types}
include_admissions <- check_include_admissions(cohort, mitigator_summary_table)
include_beddays <- check_include_beddays(cohort)
include_admissions_and_beddays <- include_admissions & include_beddays
activity_type_label <- get_activity_type_label(include_admissions, include_beddays)
```

`r get_mitigator_description(cohort)`

```{r}
#| output: asis
knitr::knit_child(
      input = "child-dir/_child-02_descriptive_overview.qmd",
      envir = environment(),
      quiet = TRUE
    ) |>
      cat(sep = '\n')
```

## Descriptive Analysis

### Patient Characteristics

```{r}
#| output: asis
knitr::knit_child(
              input = "child-dir/_child-02_descriptive_patient-characteristics.qmd",
              envir = environment(),
              quiet = TRUE
             ) |>
            cat(sep = '\n')
```

### Admission Characteristics

```{r}
#| output: asis
knitr::knit_child(
    input = "child-dir/_child-02_descriptive_admission-characteristics.qmd",
    envir = environment(),
    quiet = TRUE
  ) |>
  cat(sep = '\n')
```

## Cohort overlap


```{r}
overlap_numbers <- targets::tar_read(total_cohort_numbers_2324) |>
    filter(!!rlang::sym(cohort) == 1)
```

```{r}
#| output: asis
knitr::knit_child(
      input = "child-dir/_child-03_overlap_number-within-others.qmd",
      envir = environment(),
      quiet = TRUE
      ) |>
    cat(sep = '\n')
```

### Inclusion within other mitigable activity cohorts

```{r}
#| output: asis
knitr::knit_child(
        input = "child-dir/_child-03_overlap_inclusion-within-others.qmd",
        envir = environment(),
        quiet = TRUE
        ) |>
      cat(sep = '\n')
```

### Most common cohort overlaps

```{r}
#| output: asis
knitr::knit_child(
      input = "child-dir/_child-03_overlap_most-common.qmd",
      envir = environment(),
      quiet = TRUE
      ) |>
    cat(sep = '\n')
```

## Comparative Analysis

```{r}
#| output: asis
knitr::knit_child(
                  input = "child-dir/_child-04_comparative.qmd",
                  envir = environment(),
                  quiet = TRUE
                ) |>
                  cat(sep = '\n')
```

## Trend Analysis


```{r}
#| output: asis
knitr::knit_child(
    input = "child-dir/_child-05_trends_england.qmd",
    envir = environment(),
    quiet = TRUE
    ) |>
  cat(sep = '\n')
```

### Integrated Care Board

```{r}
#| output: asis
knitr::knit_child(
    input = "child-dir/_child-05_trends_icb.qmd",
    envir = environment(),
    quiet = TRUE
    ) |>
  cat(sep = '\n')
```

### Local Authority

```{r}
#| output: asis
geography <- "la"

knitr::knit_child(
    input = "child-dir/_child-05_trends_local-authority.qmd",
    envir = environment(),
    quiet = TRUE
    ) |>
  cat(sep = '\n')
```

### Acute Provider

```{r}
#| output: asis
geography <- "provider"

knitr::knit_child(
    input = "child-dir/_child-05_trends_local-authority.qmd",
    envir = environment(),
    quiet = TRUE
    ) |>
  cat(sep = '\n')
```

