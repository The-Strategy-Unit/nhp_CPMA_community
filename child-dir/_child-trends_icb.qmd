Note: Low numbers of `r activity_type_label` for Frimley ICB in 2022/23 reflect an issue with data submissions for this period. 

```{r}
standardised_rates_episodes <- tar_read(icb_age_sex_standardised_rates_episodes) |>
  filter(cohorts == cohort)

standardised_rates_beddays <- tar_read(icb_age_sex_standardised_rates_beddays) |>
  filter(cohorts == cohort)
```

::: panel-tabset
#### Number over time

```{r}
#| output: asis
#| eval: !expr include_admissions_and_beddays
cat("::: panel-tabset")
cat("\n")
cat("##### Admissions")
```

```{r, fig.width=5, fig.height=3}
#| eval: !expr include_admissions
#| label: fig-number_trends_spells_icb
#| fig-cap: !expr get_caption_trends(cohort_title, "number", cohort_group, "admissions", "icb") 
plotting_icb_over_time(number_percentage_over_time |> 
                         filter(!is.na(icb_2024_name)) |>
                         mutate(activity = episodes)|>
                         arrange(year),
                       'Number')
```

<br>

```{r, fig.height=6, fig.width=8}
#| eval: !expr include_admissions
#| label: fig-percent_change_number_spells
#| fig-cap: !expr get_caption_trends_percentage_change(cohort_title, "number",cohort_group, "admissions")

england_average_numbers_episodes <- calculating_england_average_numbers(number_percentage_over_time, episodes)

plotting_percentage_change_over_time_by_icb(
  number_percentage_over_time |> filter(!is.na(icb_2024_name)),
  episodes,
  icb_2024_name ,
  england_average_numbers_episodes$change,
  1.6,
  1.3
)
```

```{r}
#| output: asis
#| eval: !expr include_admissions_and_beddays
cat("##### Beddays")
```

```{r, fig.width=5, fig.height=3}
#| eval: !expr include_beddays
#| label: fig-number_trends_beddays_icb
#| fig-cap: !expr get_caption_trends(cohort_title, "number", cohort_group, "beddays", "icb")
plotting_icb_over_time(number_percentage_over_time |> 
                         filter(!is.na(icb_2024_name)) |>
                         mutate(activity = beddays)|>
                         arrange(year),
                       'Number')
```

<br>

```{r, fig.height=6, fig.width=8}
#| eval: !expr include_beddays
#| label: fig-percent_change_number_beddays
#| fig-cap: !expr get_caption_trends_percentage_change(cohort_title, "number",cohort_group, "beddays") 

england_average_numbers_beddays <- calculating_england_average_numbers(number_percentage_over_time, beddays)

plotting_percentage_change_over_time_by_icb(
  number_percentage_over_time |> filter(!is.na(icb_2024_name)),
  beddays,
  icb_2024_name,
  england_average_numbers_beddays$change,
  1.6,
  1.3
)
```

```{r}
#| output: asis
#| eval: !expr include_admissions_and_beddays
cat(":::")
```

#### Percentage of `r treatment_type_title` activity

`r cohort_title` as a percentage of `r treatment_type_title` activity.

```{r}
#| output: asis
#| eval: !expr include_admissions_and_beddays
cat("::: panel-tabset")
cat("\n")
cat("##### Admissions")
```

```{r, fig.width=5, fig.height=3}
#| eval: !expr include_admissions
#| label: fig-percent_trends_spells_icb
#| fig-cap: !expr get_caption_trends(cohort_title, "percentage", cohort_group, "admissions", "icb")
plotting_icb_over_time(
 number_percentage_over_time |> 
 filter(!is.na(icb_2024_name)) |>
    mutate(activity = percentage_episodes)|>
    filter(!is.na(activity))|>
   arrange(year),
  'Percentage'
)
```

<br>

```{r, fig.height=6, fig.width=8}
#| eval: !expr include_admissions
#| label: fig-percent_change_percent_spells
#| fig-cap: !expr get_caption_trends_percentage_change(cohort_title, "prop", cohort_group, "admissions", treatment_type) 

england_average_percentage_episodes <- calculating_england_average_percentage(
  number_percentage_over_time |> 
    filter(!is.na(total_episodes)),
  episodes,
  total_episodes)

plotting_percentage_change_over_time_by_icb(
  number_percentage_over_time |> filter(!is.na(icb_2024_name)),
  percentage_episodes,
  icb_2024_name,
  england_average_percentage_episodes$change,
  1.6,
  1.3
)
```

```{r}
#| output: asis
#| eval: !expr include_admissions_and_beddays
cat("##### Beddays")
```

```{r, fig.width=5, fig.height=3}
#| eval: !expr include_beddays
#| label: fig-percent_trends_beddays_icb
#| fig-cap: !expr get_caption_trends(cohort_title, "percentage", cohort_group, "beddays", "icb")


plotting_icb_over_time(
  number_percentage_over_time |> 
    filter(!is.na(icb_2024_name)) |>
    mutate(activity = percentage_beddays) |>
    filter(!is.na(activity))|>
    arrange(year),
  'Percentage'
)
```

<br>

```{r, fig.height=6, fig.width=8}
#| eval: !expr include_beddays
#| label: fig-percent_change_percent_beddays
#| fig-cap: !expr get_caption_trends_percentage_change(cohort_title, "prop", cohort_group, "beddays", treatment_type) 

england_average_percentage_beddays <- calculating_england_average_percentage(
  number_percentage_over_time |>
    filter(!is.na(percentage_beddays)),
  beddays,
  total_beddays)

plotting_percentage_change_over_time_by_icb(
  number_percentage_over_time |> filter(!is.na(icb_2024_name)),
  percentage_beddays,
  icb_2024_name,
  england_average_percentage_beddays$change,
  1.6,
  1.3
)
```

```{r}
#| output: asis
#| eval: !expr include_admissions_and_beddays
cat(":::")
```

#### Age and sex standardised rates per 100,000 population

```{r}
#| output: asis
#| eval: !expr include_admissions_and_beddays
cat("::: panel-tabset")
cat("\n")
cat("##### Admissions")
```

```{r, fig.width=5, fig.height=3}
#| eval: !expr include_admissions
#| label: fig-stardardised_trends_spells_icb
#| fig-cap: !expr get_caption_trends(cohort_title, "SR", cohort_group, "admissions", "icb")
plotting_icb_over_time(
  (standardised_rates_episodes |>
      mutate(activity = value)
  ),
  'Standardised rate per 100,000'
)
```

<br>

```{r, fig.height=6, fig.width=8}
#| eval: !expr include_admissions
#| label: fig-percent_change_standardised_spells
#| fig-cap: !expr get_caption_trends_percentage_change(cohort_title, "SR",cohort_group, "admissions") 

england_average_standardised_episodes <- calculating_england_average_standardised(england_age_sex_standardised_rates_episodes)

plotting_percentage_change_over_time_by_icb(
  standardised_rates_episodes,
  value,
  icb_2024_name,
  england_average_standardised_episodes$change,
  1.6,
  1.7
)
```

```{r}
#| output: asis
#| eval: !expr include_admissions_and_beddays
cat("##### Beddays")
```

```{r, fig.width=5, fig.height=3}
#| eval: !expr include_beddays
#| label: fig-stardardised_trends_beddays_icb
#| fig-cap: !expr get_caption_trends(cohort_title, "SR", cohort_group, "beddays", "icb")
plotting_icb_over_time(
  (standardised_rates_beddays |>
      mutate(activity = value)
  ),
  'Standardised rate per 100,000'
)
```

<br>

```{r, fig.height=6, fig.width=8}
#| eval: !expr include_beddays
#| label: fig-percent_change_standardised_beddays
#| fig-cap: !expr get_caption_trends_percentage_change(cohort_title, "SR", cohort_group,"beddays") 
england_average_standardised_beddays <- calculating_england_average_standardised(england_age_sex_standardised_rates_beddays)

plotting_percentage_change_over_time_by_icb(
  standardised_rates_beddays,
  value,
  icb_2024_name,
  england_average_standardised_beddays$change,
  1.6,
  1.6
)
```

```{r}
#| output: asis
#| eval: !expr include_admissions_and_beddays
cat(":::")
```
:::

#### Change in standardised rate over the last 5 years, relative to the starting rate in 2018/19, by ICB.

The percentage change in the age and sex standardised rate of `r activity_type_label` per 100,000 population for each ICB (between 2018/19 and 2023/24) is plotted relative to it's starting rate in 2018/19, to help demonstrate differences across ICBs. 

Any ICBs in the lower left quadrant (shaded in green) can be considered to be performing well; they already had relatively low standardised rates of `r activity_type_label` in 2018/19 and have continued to make further decreases over the last five years.

```{r}
#| output: asis
#| eval: !expr include_admissions_and_beddays
cat("::: panel-tabset")
cat("\n")
cat("##### Admissions")
```

```{r, fig.width=5, fig.height=4}
#| eval: !expr include_admissions
#| label: fig-activity_vs_rate_of_change_episodes_icb
#| fig-cap: !expr get_caption_activity_vs_perc_change(cohort_title,  cohort_group, "admissions") 


plotting_total_activity_vs_percentage_change(
  standardised_rates_episodes)

```

```{r}
#| output: asis
#| eval: !expr include_admissions_and_beddays
cat("##### Beddays")
```

```{r, fig.width=5, fig.height=4}
#| eval: !expr include_beddays
#| label: fig-activity_vs_rate_of_change_beddays_icb
#| fig-cap: !expr get_caption_activity_vs_perc_change(cohort_title,  cohort_group, "beddays")
plotting_total_activity_vs_percentage_change(
  standardised_rates_beddays)

```

```{r}
#| output: asis
#| eval: !expr include_admissions_and_beddays
cat(":::")
```
