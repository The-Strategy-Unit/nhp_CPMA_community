Potentially mitigable activity varies by Integrated Care Board (ICB). Below the number, percentage and age and sex standardised rates per 100,000 population of mitigable activity are presented by ICB. Bar charts and maps allow for comparisons between ICBs and to spot potential regional differences and a table of these values is also available. In this table columns can be ordered and specific ICBs can be searched for.

```{r}
#| output: false
summary_icb_admissions <- targets::tar_read_raw(glue::glue("summary_icb_admissions_{cohort}"))

summary_icb_beddays <- targets::tar_read_raw(glue::glue("summary_icb_beddays_{cohort}"))

if (include_admissions) {
  standardised_rates_admissions <- england_age_sex_standardised_rates_episodes
  
  number_icb_map_admissions <- summary_icb_admissions |>
    get_summary_by_icb_map(icb_23_shp, "total_count")
  
  perc_icb_map_admissions <- summary_icb_admissions |>
    get_summary_by_icb_map(icb_23_shp, "perc")
  
  rate_icb_map_admissions <- summary_icb_admissions |>
    get_summary_by_icb_map(icb_23_shp, "value")
}

if (include_beddays) {
  standardised_rates_beddays <- england_age_sex_standardised_rates_beddays
  
  number_icb_map_beddays <- summary_icb_beddays |>
    get_summary_by_icb_map(icb_23_shp, "total_count")
  
  perc_icb_map_beddays <- summary_icb_beddays |>
    get_summary_by_icb_map(icb_23_shp, "perc")
  
  rate_icb_map_beddays <- summary_icb_beddays |>
    get_summary_by_icb_map(icb_23_shp, "value")
}
```

::: panel-tabset
#### Number

```{r}
#| output: asis
#| eval: !expr include_admissions_and_beddays
cat("::: panel-tabset")
cat("\n")
cat("##### Admissions")
```

```{r}
#| output: asis
#| eval: !expr include_admissions
cat("::: {#fig-number_icb_admissions layout=\"[62, 38]\"}")
```

```{r}
#| eval: !expr include_admissions
england_value <- get_england_value(
  "total_count", 
  data = summary_icb_admissions)

get_summary_by_icb_bar(
  summary_icb_admissions, 
  "total_count", 
  cohort,
  england_value)

rm(england_value)
```

```{r}
#| eval: !expr include_admissions
#| crop: true
number_icb_map_admissions
```

```{r}
caption_number_admissions <- ifelse(
  include_admissions,  
  get_caption_by_geography(cohort_title, "number", "admissions"), 
  "")
```

`r caption_number_admissions`

```{r}
#| output: asis
#| eval: !expr include_admissions
cat(":::")
```

```{r}
#| output: asis
#| eval: !expr include_admissions_and_beddays
cat("##### Beddays")
```

```{r}
#| output: asis
#| eval: !expr include_beddays
cat("::: {#fig-number_icb_beddays layout=\"[62, 38]\"}")
```

```{r}
#| eval: !expr include_beddays
england_value <- get_england_value(
  "total_count", 
  data = summary_icb_beddays)

get_summary_by_icb_bar(
  summary_icb_beddays, 
  "total_count", 
  cohort,
  england_value)

rm(england_value)
```

```{r}
#| eval: !expr include_beddays
#| crop: true
number_icb_map_beddays
```

```{r}
caption_number_beddays <- ifelse(
  include_beddays,  
  get_caption_by_geography(cohort_title, "number", "beddays"), 
  "")
```

`r caption_number_beddays`

```{r}
#| output: asis
#| eval: !expr include_beddays
cat(":::")
```

```{r}
#| output: asis
#| eval: !expr include_admissions_and_beddays
cat(":::")
```

#### Percentage of `r treatment_type_title` activity

```{r}
#| output: asis
#| eval: !expr include_admissions_and_beddays
cat("::: panel-tabset")
cat("\n")
cat("##### Admissions")
```

```{r}
#| output: asis
#| eval: !expr include_admissions
cat("::: {#fig-perc_icb_admissions layout=\"[62, 38]\"}")
```

```{r}
#| eval: !expr include_admissions
england_value <- get_england_value(
  "perc", 
  activity = "admissions",
  treatment = treatment_type,
  data = overview,
  cohort = cohort)

get_summary_by_icb_bar(
  summary_icb_admissions, 
  "perc", 
  cohort,
  england_value)

rm(england_value)
```

```{r}
#| eval: !expr include_admissions
#| crop: true
perc_icb_map_admissions
```

```{r}
caption_perc_admissions <- ifelse(
  include_admissions,  
  get_caption_by_geography(cohort_title, 
                           "perc", 
                           "admissions",
                           treatment_type), 
  "")
```

`r caption_perc_admissions`

```{r}
#| output: asis
#| eval: !expr include_admissions
cat(":::")
```

```{r}
#| output: asis
#| eval: !expr include_admissions_and_beddays
cat("##### Beddays")
```

```{r}
#| output: asis
#| eval: !expr include_beddays
cat("::: {#fig-perc_icb_beddays layout=\"[62, 38]\"}")
```

```{r}
#| eval: !expr include_beddays
england_value <- get_england_value(
  "perc", 
  activity = "beddays",
  treatment = treatment_type,
  data = overview,
  cohort = cohort)

get_summary_by_icb_bar(
  summary_icb_beddays, 
  "perc", 
  cohort,
  england_value)

rm(england_value)
```

```{r}
#| eval: !expr include_beddays
#| crop: true
perc_icb_map_beddays
```

```{r}
caption_perc_beddays <- ifelse(
  include_beddays,  
  get_caption_by_geography(cohort_title, 
                           "perc", 
                           "beddays",
                           treatment_type), 
  "")
```

`r caption_perc_beddays`

```{r}
#| output: asis
#| eval: !expr include_beddays
cat(":::")
```

```{r}
#| output: asis
#| eval: !expr include_admissions_and_beddays
cat(":::")
```

#### Age and sex standardised rates per 100,000 population

```{r}
#| output: asis
#| eval: !expr include_admissions_and_beddays
cat("::: panel-tabset")
cat("\n")
cat("##### Admissions")
```

```{r}
#| output: asis
#| eval: !expr include_admissions
cat("::: {#fig-rate_icb_admissions layout=\"[62, 38]\"}")
```

```{r}
#| eval: !expr include_admissions
england_value <- get_england_value(
  "value",
  data = standardised_rates_admissions,
  cohort = cohort)

get_summary_by_icb_bar(
  summary_icb_admissions, 
  "value", 
  cohort,
  england_value)

rm(england_value)
```

```{r}
#| eval: !expr include_admissions
#| crop: true
rate_icb_map_admissions
```

```{r}
caption_rate_admissions <- ifelse(
  include_admissions,  
  get_caption_by_geography(cohort_title, 
                           "rate", 
                           "admissions"), 
  "")
```

`r caption_rate_admissions`

```{r}
#| output: asis
#| eval: !expr include_admissions
cat(":::")
```

```{r}
#| output: asis
#| eval: !expr include_admissions_and_beddays
cat("##### Beddays")
```

```{r}
#| output: asis
#| eval: !expr include_beddays
cat("::: {#fig-rate_icb_beddays layout=\"[62, 38]\"}")
```

```{r}
#| eval: !expr include_beddays
england_value <- get_england_value(
  "value",
  data = standardised_rates_beddays,
  cohort = cohort)

get_summary_by_icb_bar(
  summary_icb_beddays, 
  "value", 
  cohort,
  england_value)

rm(england_value)
```

```{r}
#| eval: !expr include_beddays
#| crop: true
rate_icb_map_beddays
```

```{r}
caption_rate_beddays <- ifelse(
  include_beddays,  
  get_caption_by_geography(cohort_title, 
                           "rate", 
                           "beddays"), 
  "")
```

`r caption_rate_beddays`

```{r}
#| output: asis
#| eval: !expr include_beddays
cat(":::")
```

```{r}
#| output: asis
#| eval: !expr include_admissions_and_beddays
cat(":::")
```

#### Table

```{r}
#| output: asis
#| eval: !expr include_admissions_and_beddays
cat("::: panel-tabset")
cat("\n")
cat("##### Admissions")
```

```{r}
summary_icb_suppressed <- summary_icb_admissions |>
  small_number_suppression_comparative("admissions")
  
number_suppressed <- summary_icb_suppressed |>
  dplyr::filter(stringr::str_detect(total_count, "<=")) |>
  nrow()
```

```{r}
#| eval: !expr include_admissions
#| include: !expr include_admissions # for table caption
#| label: tbl-rate_icb_admissions
#| tbl-cap: !expr get_caption_by_geography_table(cohort_title, "admissions", treatment_type, "icb", number_suppressed)
get_summary_by_geography_table(
  summary_icb_suppressed,
  "admissions", 
  treatment_type)
```

```{r}
#| output: asis
#| eval: !expr include_admissions_and_beddays
cat("##### Beddays")
```

```{r}
summary_icb_suppressed <- summary_icb_beddays |>
  small_number_suppression_comparative("beddays")
```

```{r}
#| eval: !expr include_beddays
#| include: !expr include_beddays # for table caption
#| label: tbl-rate_icb_beddays
#| tbl-cap: !expr get_caption_by_geography_table(cohort_title, "beddays", treatment_type, "icb")
get_summary_by_geography_table(
  summary_icb_beddays,
  "beddays", 
  treatment_type)
```

```{r}
#| output: asis
#| eval: !expr include_admissions_and_beddays
cat(":::")
```
:::
