# Frail Older People (High Frailty Risk) Cohort

```{r}
library("flextable")
library("tidyr")
library("dplyr")
library("ggplot2")
library("StrategyUnitTheme")
library("forcats")
library("ComplexUpset")
library("scales")
library("targets")
library("plotly")
library("patchwork")

source("R/captions.R")
source("R/general.R")
source("R/descriptive_analyses.R")
source("R/comparative_analyses.R")
source("R/Functions for cohort overlap.R")
source("R/Functions for trend analysis.R")

options(scipen = 999)
```

```{r global variables}
cohort <- "frail_elderly_high"
cohort_title <- "Frail Older People (high frailty)"
treatment_type <- "emergency"
```

```{r}
england_age_sex_standardised_rates_episodes<-tar_read(england_age_sex_standardised_rates_episodes)|>
  filter(cohorts==cohort)

england_age_sex_standardised_rates_beddays<-tar_read(england_age_sex_standardised_rates_beddays)|>
  filter(cohorts==cohort)
```


This cohort includes older patients with a high level of frailty, specifically, those 75 years of age or over with an emergency admission and a frailty score over 15. The frailty score is calculated from ICD-10 diagnoses recorded for admissions during the previous 2 years and using the risk scores in Gilbert et al (2018), Development and validation of a Hospital Frailty Risk Score focusing on older people in acute care settings using electronic hospital records: an observational study. The Lancet, 391(10132), pp.1775-1782.

## Descriptive Analysis of Mitigable Activity

```{r}
overview_frail_elderly_high <- targets::tar_read(overview_frail_elderly_high)

frail_elderly_high_admissions_perc <- overview_frail_elderly_high |>
  dplyr::filter(activity_type == "Admissions") |>
  dplyr::pull(perc)

frail_elderly_high_beddays_perc <- overview_frail_elderly_high |>
  dplyr::filter(activity_type == "Beddays") |>
  dplyr::pull(perc)
```

In 2023/24, `r frail_elderly_high_admissions_perc`% of all emergency admissions and `r frail_elderly_high_beddays_perc`% of all emergency beddays fall under mitigable activity for the Frail Older People (high frailty) cohort (@tbl-perc_frail_elderly_high).

```{r}
#| label: tbl-perc_frail_elderly_high
#| tbl-cap: !expr get_caption_overview(cohort_title, treatment_type)
overview_frail_elderly_high |>
  get_table_perc()
```

### Patient Characteristics

In this section, the number and percentage of mitigable activity for the Frail Older People (high frailty) cohort are shown by patient characteristics: age, ethnic category, IMD decile and sex. Rates per 100,000 population are also provided for context.

Outputs are presented for both admissions and beddays, but patterns are broadly similar across the two.

::: panel-tabset
### Admissions

::: panel-tabset
### Age

```{r}
perc_frail_elderly_high_age_admissions <- targets::tar_read(perc_frail_elderly_high_age_admissions)
rates_frail_elderly_high_age_admissions <- targets::tar_read(rates_frail_elderly_high_age_admissions)
```

Of 2023/24 mitigable admissions for the Frail Older People (high frailty) cohort, most patients (`r perc_frail_elderly_high_age_admissions |> dplyr::filter(age_range == "85-89") |> dplyr::pull(perc)`%) are in the 85-89 year old age group (@tbl-perc_frail_elderly_high_age_admissions). Although the percentages for each age group are roughly similar, the rates of mitigable admissions per 100,000 population increases with age, with the 90+ age group having the highest rates at `r rates_frail_elderly_high_age_admissions |> dplyr::filter(age_range == "90+") |> dplyr::pull(value) |> prettyNum(big.mark = ",")` per 100,000 (@tbl-rate_frail_elderly_high_age_admissions).

::: panel-tabset
#### Percentage of emergency activity

```{r}
#| label: tbl-perc_frail_elderly_high_age_admissions
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "age group", treatment_type)
perc_frail_elderly_high_age_admissions |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_elderly_high_age_admissions
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "age group", treatment_type)
perc_frail_elderly_high_age_admissions |>
  get_perc_by_group_plot("age_range", "admissions")
```

#### Rates per 100,000 population

```{r}
#| label: tbl-rate_frail_elderly_high_age_admissions
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "age group")
rates_frail_elderly_high_age_admissions |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_frail_elderly_high_age_admissions
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "age group")
rates_frail_elderly_high_age_admissions |>
  get_rates_by_group_plot("age_range")
```
:::

### Ethnicity

```{r}
perc_frail_elderly_high_ethnicity_admissions <- targets::tar_read(perc_frail_elderly_high_ethnicity_admissions)
rates_frail_elderly_high_ethnicity_admissions <- targets::tar_read(rates_frail_elderly_high_ethnicity_admissions)
```

Patients in the White ethnic group make up the majority (`r perc_frail_elderly_high_ethnicity_admissions |> dplyr::filter(Ethnic_Category == "White") |> dplyr::pull(perc)`%) of 2023-24 mitigable admissions for the Frail Older People (high frailty) cohort and have the highest rates (`r rates_frail_elderly_high_ethnicity_admissions |> dplyr::filter(Ethnic_Category == "White") |> dplyr::pull(value) |> prettyNum(big.mark = ",")`) per 100,000 population.

::: panel-tabset
#### Percentage of emergency activity

```{r}
#| label: tbl-perc_frail_elderly_high_ethnicity_admissions
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "ethnicity", treatment_type)
perc_frail_elderly_high_ethnicity_admissions |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_elderly_high_ethnicity_admissions
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "ethnicity", treatment_type)
perc_frail_elderly_high_ethnicity_admissions |>
  get_perc_by_group_plot("Ethnic_Category", "admissions")
```

#### Rates per 100,000 population

```{r}
#| label: tbl-rate_frail_elderly_high_ethnicity_admissions
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "ethnicity")
rates_frail_elderly_high_ethnicity_admissions |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_frail_elderly_high_ethnicity_admissions
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "ethnicity")
rates_frail_elderly_high_ethnicity_admissions |>
  get_rates_by_group_plot("Ethnic_Category")
```
:::

### IMD

```{r}
perc_frail_elderly_high_imd_admissions <- targets::tar_read(perc_frail_elderly_high_imd_admissions)
rates_frail_elderly_high_imd_admissions <- targets::tar_read(rates_frail_elderly_high_imd_admissions)
```

The percentage of 2023/24 mitigable admissions for the Frail Older People (high frailty) cohort appear similar across the IMD deciles. Patients from areas with IMD deciles 7-9 have the highest rates of mitigable admission per 100,000 (@tbl-rate_frail_elderly_high_imd_admissions). However, there is little difference between patients from the most deprived areas (decile 1) compared to those from the least deprived areas (decile 10).

::: panel-tabset
#### Percentage of emergency activity

```{r}
#| label: tbl-perc_frail_elderly_high_imd_admissions
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "imd", treatment_type)
perc_frail_elderly_high_imd_admissions |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_elderly_high_imd_admissions
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "imd", treatment_type)
perc_frail_elderly_high_imd_admissions |>
  get_perc_by_group_plot("imd19_decile", "admissions")
```

#### Rates per 100,000 population

```{r}
#| label: tbl-rate_frail_elderly_high_imd_admissions
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "imd")
rates_frail_elderly_high_imd_admissions |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_frail_elderly_high_imd_admissions
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "imd")
rates_frail_elderly_high_imd_admissions |>
  get_rates_by_group_plot("imd19_decile")
```
:::

### Sex

```{r}
perc_frail_elderly_high_sex_admissions <- targets::tar_read(perc_frail_elderly_high_sex_admissions)
rates_frail_elderly_high_sex_admissions <- targets::tar_read(rates_frail_elderly_high_sex_admissions)
```

The majority (`r perc_frail_elderly_high_sex_admissions |> dplyr::filter(sex == "Female") |> dplyr::pull(perc)`%) of mitigable admissions for the Frail Older People (high frailty) cohort are for female patients. Females also have the higher rate per 100,000 at `r rates_frail_elderly_high_sex_admissions |> dplyr::filter(sex == "Female") |> dplyr::pull(value) |> prettyNum(big.mark = ",")` compared to `r rates_frail_elderly_high_sex_admissions |> dplyr::filter(sex == "Male") |> dplyr::pull(value) |> prettyNum(big.mark = ",")` for males (@tbl-rate_frail_elderly_high_sex_admissions).

::: panel-tabset
#### Percentage of emergency activity

```{r}
#| label: tbl-perc_frail_elderly_high_sex_admissions
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "sex", treatment_type)
perc_frail_elderly_high_sex_admissions |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_elderly_high_sex_admissions
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "sex", treatment_type)
perc_frail_elderly_high_sex_admissions |>
  get_perc_by_group_plot("sex", "admissions")
```

#### Rates per 100,000 population

```{r}
#| label: tbl-rate_frail_elderly_high_sex_admissions
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "sex")
rates_frail_elderly_high_sex_admissions |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_frail_elderly_high_sex_admissions
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "sex")
rates_frail_elderly_high_sex_admissions |>
  get_rates_by_group_plot("sex")
```
:::
:::

### Beddays

::: panel-tabset
### Age

```{r}
perc_frail_elderly_high_age_beddays <- targets::tar_read(perc_frail_elderly_high_age_beddays)
rates_frail_elderly_high_age_beddays <- targets::tar_read(rates_frail_elderly_high_age_beddays)
```

Of 2023/24 mitigable beddays for the Frail Older People (high frailty) cohort, most patients (`r perc_frail_elderly_high_age_beddays |> dplyr::filter(age_range == "85-89") |> dplyr::pull(perc)`%) are in the 85-89 year old age group (@tbl-perc_frail_elderly_high_age_beddays). Although the percentages for each age group are roughly similar, the rates of mitigable beddays per 100,000 population increases with age, with the 90+ age group having the highest rates at `r rates_frail_elderly_high_age_beddays |> dplyr::filter(age_range == "90+") |> dplyr::pull(value) |> prettyNum(big.mark = ",")` per 100,000 (@tbl-rate_frail_elderly_high_age_beddays).

::: panel-tabset
#### Percentage of emergency activity

```{r}
#| label: tbl-perc_frail_elderly_high_age_beddays
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "age group", treatment_type)
targets::tar_read(perc_frail_elderly_high_age_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_elderly_high_age_beddays
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "age group", treatment_type)
targets::tar_read(perc_frail_elderly_high_age_beddays) |>
  get_perc_by_group_plot("age_range", "beddays")
```

#### Rates per 100,000 population

```{r}
#| label: tbl-rate_frail_elderly_high_age_beddays
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "age group")
targets::tar_read(rates_frail_elderly_high_age_beddays) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_frail_elderly_high_age_beddays
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "age group")
targets::tar_read(rates_frail_elderly_high_age_beddays) |>
  get_rates_by_group_plot("age_range")
```
:::

### Ethnicity

```{r}
perc_frail_elderly_high_ethnicity_beddays <- targets::tar_read(perc_frail_elderly_high_ethnicity_beddays)
rates_frail_elderly_high_ethnicity_beddays <- targets::tar_read(rates_frail_elderly_high_ethnicity_beddays)
```

Patients in the White ethnic group make up the majority (`r perc_frail_elderly_high_ethnicity_beddays |> dplyr::filter(Ethnic_Category == "White") |> dplyr::pull(perc)`%) of 2023-24 mitigable beddays for the Frail Older People (high frailty) cohort and have the highest rates (`r rates_frail_elderly_high_ethnicity_beddays |> dplyr::filter(Ethnic_Category == "White") |> dplyr::pull(value) |> prettyNum(big.mark = ",")`) per 100,000 population.

::: panel-tabset
#### Percentage of emergency activity

```{r}
#| label: tbl-perc_frail_elderly_high_ethnicity_beddays
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "ethnicity", treatment_type)
targets::tar_read(perc_frail_elderly_high_ethnicity_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_elderly_high_ethnicity_beddays
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "ethnicity", treatment_type)
targets::tar_read(perc_frail_elderly_high_ethnicity_beddays) |>
  get_perc_by_group_plot("Ethnic_Category", "beddays")
```

#### Rates per 100,000 population

```{r}
#| label: tbl-rate_frail_elderly_high_ethnicity_beddays
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "ethnicity")
targets::tar_read(rates_frail_elderly_high_ethnicity_beddays) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_frail_elderly_high_ethnicity_beddays
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "ethnicity")
targets::tar_read(rates_frail_elderly_high_ethnicity_beddays) |>
  get_rates_by_group_plot("Ethnic_Category")
```
:::

### IMD

```{r}
perc_frail_elderly_high_imd_beddays <- targets::tar_read(perc_frail_elderly_high_imd_beddays)
rates_frail_elderly_high_imd_beddays <- targets::tar_read(rates_frail_elderly_high_imd_beddays)
```

The percentage of 2023/24 mitigable beddays for the Frail Older People (high frailty) cohort appear similar across the IMD deciles. Patients from areas with IMD deciles 7-9 have the highest rates of mitigable admission per 100,000 @tbl-rate_frail_elderly_high_imd_beddays. However, there is little difference between patients from the most deprived areas (decile 1) compared to those from the least deprived areas (decile 10).

::: panel-tabset
#### Percentage of emergency activity

```{r}
#| label: tbl-perc_frail_elderly_high_imd_beddays
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "imd", treatment_type)
targets::tar_read(perc_frail_elderly_high_imd_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_elderly_high_imd_beddays
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "imd", treatment_type)
targets::tar_read(perc_frail_elderly_high_imd_beddays) |>
  get_perc_by_group_plot("imd19_decile", "beddays")
```

#### Rates per 100,000 population

```{r}
#| label: tbl-rate_frail_elderly_high_imd_beddays
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "imd")
targets::tar_read(rates_frail_elderly_high_imd_beddays) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_frail_elderly_high_imd_beddays
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "imd")
targets::tar_read(rates_frail_elderly_high_imd_beddays) |>
  get_rates_by_group_plot("imd19_decile")
```
:::

### Sex

```{r}
perc_frail_elderly_high_sex_beddays <- targets::tar_read(perc_frail_elderly_high_sex_beddays)
rates_frail_elderly_high_sex_beddays <- targets::tar_read(rates_frail_elderly_high_sex_beddays)
```

The majority (`r perc_frail_elderly_high_sex_beddays |> dplyr::filter(sex == "Female") |> dplyr::pull(perc)`%) of mitigable beddays for the Frail Older People (high frailty) cohort are for female patients. Females also have the higher rate per 100,000 at `r rates_frail_elderly_high_sex_beddays |> dplyr::filter(sex == "Female") |> dplyr::pull(value) |> prettyNum(big.mark = ",")` compared to `r rates_frail_elderly_high_sex_beddays |> dplyr::filter(sex == "Male") |> dplyr::pull(value) |> prettyNum(big.mark = ",")` for males (@tbl-rate_frail_elderly_high_sex_beddays).

::: panel-tabset
#### Percentage of emergency activity

```{r}
#| label: tbl-perc_frail_elderly_high_sex_beddays
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "sex", treatment_type)
targets::tar_read(perc_frail_elderly_high_sex_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_elderly_high_sex_beddays
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "sex", treatment_type)
targets::tar_read(perc_frail_elderly_high_sex_beddays) |>
  get_perc_by_group_plot("sex", "beddays")
```

#### Rates per 100,000 population

```{r}
#| label: tbl-rate_frail_elderly_high_sex_beddays
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "sex")
targets::tar_read(rates_frail_elderly_high_sex_beddays) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_frail_elderly_high_sex_beddays
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "sex")
targets::tar_read(rates_frail_elderly_high_sex_beddays) |>
  get_rates_by_group_plot("sex")
```
:::
:::
:::

### Admission Characteristics

In this section, mitigable activity for the Frail Older People (high frailty) cohort are shown by admission characteristics.

::: panel-tabset
### Length Of Stay

```{r}
perc_frail_elderly_high_los <- targets::tar_read(perc_frail_elderly_high_los)
```

Of the 2023/24 mitigable admissions for Frail Older People (high frailty) cohort, most (`r perc_frail_elderly_high_los |> dplyr::filter(weeks == 1) |> dplyr::pull(perc_weeks) |> purrr::pluck(1)`%) length of stays are under 1 week and `r perc_frail_elderly_high_los |> dplyr::filter(los_range == 0) |> dplyr::pull(perc)`% are less than 1 day.

```{r}
#| label: tbl-perc_frail_elderly_high_los
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "los", treatment_type)
targets::tar_read(perc_frail_elderly_high_los) |>
  get_perc_by_los_table()
```

```{r}
#| label: fig-perc_frail_elderly_high_los
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "los", treatment_type)
perc_frail_elderly_high_los |>
  get_perc_by_los_plot()
```

### Specialty

Across both admissions and beddays, the largest two treatment functions for mitigable activity for the Frail Older People (high frailty) cohort are Elderly Medicine Service and General Internal Medicine Service.

::: panel-tabset
#### Admissions

```{r}
#| label: tbl-perc_frail_elderly_high_mainspecf_admissions
#| tbl-cap: !expr get_caption_top_ten_specialties(cohort_title, "admissions")
targets::tar_read(frail_elderly_high_specialties_top_ten_admissions) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_elderly_high_mainspecf_admissions
#| fig-cap: !expr get_caption_top_ten_specialties(cohort_title, "admissions")
targets::tar_read(frail_elderly_high_specialties_top_ten_admissions)  |>
  get_top_ten_specialties_plot("admissions")
```

#### Beddays

```{r}
#| label: tbl-perc_frail_elderly_high_mainspecf_beddays
#| tbl-cap: !expr get_caption_top_ten_specialties(cohort_title, "beddays")
targets::tar_read(frail_elderly_high_specialties_top_ten_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_frail_elderly_high_mainspecf_beddays
#| fig-cap: !expr get_caption_top_ten_specialties(cohort_title, "beddays")
targets::tar_read(frail_elderly_high_specialties_top_ten_beddays) |>
  get_top_ten_specialties_plot("beddays")
```
:::
:::

## Cohort overlap

Many admissions meet the criteria to be included in more than one mitigator cohort. Since these potential mitigator cohorts are not mutually exclusive there is a need to understand which cohorts overlap and the degree of overlap between the cohorts.

### Number and proportion within multiple other cohorts

For the Frail Older People (high frailty) activity we show how much of the activity is included in multiple other mitigable cohorts. There are some differences between cohort overlap for admissions and beddays, this is because efficiency mitigators are not included in admissions data as they do not impact the number of admissions, but are included in the beddays data as they influence length of stay. 

::: panel-tabset
#### Admissions

```{r, fig.width=4, fig.height=4}
#| label: fig-number_of_cohorts_spells
#| fig-cap: The number and percentage of mitigator cohorts that the Frail Elderly spells are a part of (2023/24).

total_cohort_numbers_2324<-targets::tar_read(total_cohort_numbers_2324)|>
  filter(frail_elderly_high==1)

plotting_barchart_number_of_cohorts(total_cohort_numbers_2324, episodes)

```

#### Beddays

```{r, fig.width=4, fig.height=4}
#| label: fig-number_of_cohorts_beddays
#| fig-cap: The number and percentage of mitigator cohorts that the Frail Elderly beddays are a part of (2023/24).

plotting_barchart_number_of_cohorts(total_cohort_numbers_2324, beddays)
```
:::

### Inclusion within other mitigable activity cohorts

This shows whether the activity within the Elderly Frail High activity is also included in other mitigator cohorts, including where this occurs the number and percentage of Elderly Frail High activity that is also included within other mitigator cohorts.

For example, Elderly Frail High cohort overlaps with all but 2 of the other mitigator cohorts. All the Elderly Frail High cohort activity is also included in the Emergency Elderly cohort, and 63% of this cohort are in the Alcohol Partially Attributable Chronic cohort.

::: panel-tabset
#### Admissions

```{r, fig.width=10, fig.height=6 }
#| label: fig-prop_other_cohorts_frail_spells
#| fig-cap: The number and proportion of Frail Elderly spells that are included in each of the other cohorts (2023/24).

mitigator_summary_table<-tar_read(mitigator_summary_table)

plotting_barchart_summary_of_overlaps(total_cohort_numbers_2324,cohort, episodes, mitigator_summary_table )

```

#### Beddays

```{r, fig.width=10, fig.height=7 }
#| label: fig-prop_other_cohorts_frail_beddays
#| fig-cap: The number and proportion of Frail Elderly beddays that are included in each of the other cohorts (2023/24).

plotting_barchart_summary_of_overlaps(total_cohort_numbers_2324,cohort, beddays, mitigator_summary_table)

```
:::

### Most common cohort overlaps

Often overlap between a small number of groups can be visualised using Venn diagram. However, due to the large number of mitigator cohorts and therefore high numbers of potential combinations of overlaps we have used upset plots to show the largest overlaps between cohorts.

The 15 most common cohort combinations for the Elderly Frail High cohort are shown. For this cohort there are a very large number of different cohort combinations, so there are many smaller size cohort combinations that are not shown (all combinations together would add to 100%).

::: panel-tabset
#### Admissions

```{r, fig.width=10, fig.height=6}
#| label: upset_plot_frail_elderly_high_episodes
#| fig-cap: The 15 most common mitigator cohort overlaps for Frail Elderly admissions (2023/24).

plot_upset_plot(total_cohort_numbers_2324,  mitigator_summary_table, episodes)

```

#### Beddays

```{r, fig.width=10, fig.height=6}
#| label: upset_plot_frail_elderly_high_bedday
#| fig-cap: The 15 most common mitigator cohort overlaps for Frail Elderly beddays (2023/24).

plot_upset_plot(total_cohort_numbers_2324,  mitigator_summary_table, beddays)
```
:::



## Comparative Analysis

This section is still a work in progress.

::: panel-tabset
### Admissions

::: panel-tabset
#### Integrated Care Board

```{r}
#| output: false
summary_frail_elderly_high_icb_admissions <- targets::tar_read(summary_frail_elderly_high_icb_admissions)

icb_23_shp <- sf::st_read("https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/Integrated_Care_Boards_April_2023_EN_BGC/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson") |>
  janitor::clean_names()

number_frail_elderly_high_icb_admissions_map <- summary_frail_elderly_high_icb_admissions |>
  get_summary_by_icb_map(icb_23_shp, "total_count")

perc_frail_elderly_high_icb_admissions_map <- summary_frail_elderly_high_icb_admissions |>
  get_summary_by_icb_map(icb_23_shp, "perc")

rate_frail_elderly_high_icb_admissions_map <- summary_frail_elderly_high_icb_admissions |>
  get_summary_by_icb_map(icb_23_shp, "value")
```

::: panel-tabset
##### Number of admissions

::: panel-tabset
###### Bars

```{r}
#| label: fig-number_frail_elderly_high_icb_admissions_bar
#| fig-cap: !expr get_caption_by_icb(cohort_title, "number", "admissions")
england_value <- get_england_value("total_count", 
                                   data_number = summary_frail_elderly_high_icb_admissions)

get_summary_by_icb_bar(summary_frail_elderly_high_icb_admissions, 
                       "total_count", 
                       cohort,
                       england_value)

rm(england_value)
```

###### Map

```{r}
#| label: fig-number_frail_elderly_high_icb_admissions_map
#| fig-cap: !expr get_caption_by_icb(cohort_title, "number", "admissions")
number_frail_elderly_high_icb_admissions_map
```
:::

##### Percentage of emergency activity

::: panel-tabset
###### Bars

```{r}
#| label: fig-perc_frail_elderly_high_icb_admissions_bar
#| fig-cap: !expr get_caption_by_icb(cohort_title, "perc", "admissions")
total_beddays_admissions <- targets::tar_read(total_beddays_admissions)

england_value <- get_england_value("perc", 
                                   activity = "admissions",
                                   treatment = treatment_type,
                                   data_rate = england_age_sex_standardised_rates_episodes,
                                   cohort = cohort)

get_summary_by_icb_bar(summary_frail_elderly_high_icb_admissions, 
                       "perc", 
                       cohort,
                       england_value)

rm(england_value)
```

###### Map

```{r}
#| label: fig-perc_frail_elderly_high_icb_admissions_map
#| fig-cap: !expr get_caption_by_icb(cohort_title, "perc", "admissions", treatment_type)
perc_frail_elderly_high_icb_admissions_map
```
:::

##### Age and sex standardised rates per 100,000 population

::: panel-tabset
###### Bars

```{r}
#| label: fig-rate_frail_elderly_high_icb_admissions_bar
#| fig-cap: !expr get_caption_by_icb(cohort_title, "SR", "admissions")
england_value <- get_england_value("value",
                                   data_rate = england_age_sex_standardised_rates_episodes,
                                   cohort = cohort)

get_summary_by_icb_bar(summary_frail_elderly_high_icb_admissions, 
                       "value", 
                       cohort,
                       england_value)

rm(england_value)
```

###### Map

```{r}
#| label: fig-rate_frail_elderly_high_icb_admissions_map
#| fig-cap: !expr get_caption_by_icb(cohort_title, "SR", "admissions")
rate_frail_elderly_high_icb_admissions_map
```
:::

##### Table

```{r}
#| label: tbl-rate_frail_elderly_high_icb_admissions
#| tbl-cap: !expr get_caption_by_geography_table(cohort_title, "admissions", treatment_type, "icb")
get_summary_by_geography_table(summary_frail_elderly_high_icb_admissions, "episodes", treatment_type)
```
:::

#### Local Authority

```{r}
#| label: tbl-rate_frail_elderly_high_la_admissions
#| tbl-cap: !expr get_caption_by_geography_table(cohort_title, "admissions", treatment_type, "la")
targets::tar_read(summary_frail_elderly_high_la_admissions) |>
  get_summary_by_geography_table("episodes", treatment_type)
```
:::

### Beddays

::: panel-tabset
#### Integrated Care Board

```{r}
#| output: false
summary_frail_elderly_high_icb_beddays <- targets::tar_read(summary_frail_elderly_high_icb_beddays)

number_frail_elderly_high_icb_beddays_map <- summary_frail_elderly_high_icb_beddays |>
  get_summary_by_icb_map(icb_23_shp, "total_count")

perc_frail_elderly_high_icb_beddays_map <- summary_frail_elderly_high_icb_beddays |>
  get_summary_by_icb_map(icb_23_shp, "perc")

rate_frail_elderly_high_icb_beddays_map <- summary_frail_elderly_high_icb_beddays |>
  get_summary_by_icb_map(icb_23_shp, "value")
```

::: panel-tabset
##### Number of beddays

::: panel-tabset
###### Bars

```{r}
#| label: fig-number_frail_elderly_high_icb_beddays_bar
#| fig-cap: !expr get_caption_by_icb(cohort_title, "number", "beddays")
england_value <- get_england_value("total_count", 
                                   data_number = summary_frail_elderly_high_icb_beddays)

get_summary_by_icb_bar(summary_frail_elderly_high_icb_beddays, 
                       "total_count", 
                       cohort,
                       england_value)

rm(england_value)
```

###### Map

```{r}
#| label: fig-number_frail_elderly_high_icb_beddays_map
#| fig-cap: !expr get_caption_by_icb(cohort_title, "number", "beddays")
number_frail_elderly_high_icb_beddays_map
```
:::

##### Percentage of emergency activity

::: panel-tabset
###### Bars

```{r}
#| label: fig-perc_frail_elderly_high_icb_beddays_bar
#| fig-cap: !expr get_caption_by_icb(cohort_title, "perc", "beddays")
total_beddays_admissions <- targets::tar_read(total_beddays_admissions)

england_value <- get_england_value("perc", 
                                   activity = "beddays",
                                   treatment = treatment_type,
                                   data_rate = england_age_sex_standardised_rates_beddays,
                                   cohort = cohort)

get_summary_by_icb_bar(summary_frail_elderly_high_icb_beddays, 
                       "perc", 
                       cohort,
                       england_value)

rm(england_value)
```

###### Map

```{r}
#| label: fig-perc_frail_elderly_high_icb_beddays_map
#| fig-cap: !expr get_caption_by_icb(cohort_title, "perc", "beddays", treatment_type)
perc_frail_elderly_high_icb_beddays_map
```
:::

##### Age and sex standardised rates per 100,000 population

::: panel-tabset
###### Bars

```{r}
#| label: fig-rate_frail_elderly_high_icb_beddays_bar
#| fig-cap: !expr get_caption_by_icb(cohort_title, "SR", "beddays")
england_value <- get_england_value("value",
                                   data_rate = england_age_sex_standardised_rates_beddays,
                                   cohort = cohort)

get_summary_by_icb_bar(summary_frail_elderly_high_icb_beddays, 
                       "value", 
                       cohort,
                       england_value)

rm(england_value)
```

###### Map

```{r}
#| label: fig-rate_frail_elderly_high_icb_beddays_map
#| fig-cap: !expr get_caption_by_icb(cohort_title, "SR", "beddays")
rate_frail_elderly_high_icb_beddays_map
```
:::

##### Table

```{r}
#| label: tbl-rate_frail_elderly_high_icb_beddays
#| tbl-cap: !expr get_caption_by_geography_table(cohort_title, "beddays", treatment_type, "icb")
get_summary_by_geography_table(summary_frail_elderly_high_icb_beddays, "beddays", treatment_type)
```
:::

#### Local Authority

```{r}
#| label: tbl-rate_frail_elderly_high_la_beddays
#| tbl-cap: !expr get_caption_by_geography_table(cohort_title, "beddays", treatment_type, "la")
targets::tar_read(summary_frail_elderly_high_la_beddays) |>
  get_summary_by_geography_table("beddays", treatment_type)
```
:::
:::

## Trend Analysis

We aim to understand whether there have been decreases, or increases, in potentially mitigable Frail Older People (high frailty) activity over time. We have considered Frail Older People (high frailty) admissions and beddays over the past 9 years in England as a whole and for each ICB, including:

a\) the absolute number of Frail Older People (high frailty) admissions/beddays,

b\) these admissions/beddays as a proportion of emergency admissions,

c\) the age and sex standardised rates of these admissions/beddays using the England 2021 census population.

To help understand the variability between ICBs we have calculated for each ICB the percentage change in proportion of emergency admissions and in standardised rates between 2018/19 and 2023/24.

### England

::: panel-tabset
#### Number over time

::: panel-tabset
#### Admissions

```{r, fig.width=7, fig.height=3}
#| label: fig-number_trends_spells_england
#| fig-cap: The total number of admissions for the Frail Older People (high frailty) mitigable activity cohort in England over the last 9 years. 

numbers_over_time<-tar_read(numbers_over_time)|>
  filter(year!="2014/15")

denominator_over_time<-tar_read(denominator_over_time)
icb_population_data<-tar_read(icb_population_data)

number_percentage_over_time<-  data_number_percentage_over_time_icb(denominator_over_time, 
                                    numbers_over_time,
                                       cohort,                                       total_episodes_emergency,
                                      total_beddays_emergency)

plot_of_number_over_time(number_percentage_over_time, episodes)


```

#### Beddays

```{r, fig.width=7, fig.height=3}
#| label: fig-number_trends_beddays_england
#| fig-cap: The total number of beddays for the Frail Older People (high frailty) mitigable activity cohort in England over the last 9 years. 
plot_of_number_over_time(number_percentage_over_time,  beddays)

```
:::

#### Crude rate

Frail Older People (high frailty) activity as a percentage of total emergency activity.

::: panel-tabset
#### Admissions

```{r, fig.width=7, fig.height=3}
#| label: fig-percent_trends_spells_england
#| fig-cap: The percentage of total emergency admissions that are for Frail Older People (high frailty) potentially mitigable activity in England over the last 9 years. 

plot_of_percentage_over_time(number_percentage_over_time|>
                               filter(!is.na(percentage_episodes)), 
          episodes, total_episodes)

```

#### Beddays

```{r, fig.width=7, fig.height=3}
#| label: fig-percent_trends_beddays_england
#| fig-cap: The percentage of total emergency beddays that are for Frail Older People (high frailty) potentially mitigable activity in England over the last 9 years. 

plot_of_percentage_over_time(number_percentage_over_time|>
                               filter(!is.na(percentage_beddays)),  beddays, total_beddays)

```
:::

#### Age and sex standardised rates over time

::: panel-tabset
#### Admissions

```{r, fig.width=7, fig.height=3}
#| label: fig-stardardised_trends_spells_england
#| fig-cap: Age and sex standardised rate of admissions for Frail Older People (high frailty) potentially mitigable activity in England over the last 9 years. 

plot_of_standardised_rates_over_time(england_age_sex_standardised_rates_episodes)

```

#### Beddays

```{r, fig.width=7, fig.height=3}
#| label: fig-stardardised_trends_beddays_england
#| fig-cap: Age and sex standardised rate of beddays for Frail Older People (high frailty) potentially mitigable activity in England over the last 9 years.

plot_of_standardised_rates_over_time(england_age_sex_standardised_rates_beddays)

```
:::
:::

### ICB

Note: Low numbers of admissions/beddays for Frimley ICB in 2022/23 reflect an issue with data submissions for this period. 

::: panel-tabset
#### Number over time

::: panel-tabset
#### Admissions

```{r, fig.width=5, fig.height=3}
#| label: fig-number_trends_spells_icb
#| fig-cap: The number of admissions for the Frail Older People (high frailty) mitigable activity cohort by ICB over the last 9 years. 

plotting_icb_over_time(number_percentage_over_time|>
        mutate(activity=episodes),
        'Number')

```

<br>

```{r, fig.height=6, fig.width=8}
#| label: fig-percent_change_number_spells
#| fig-cap: The percentage change in the number of Frail Older People (high frailty) admissions by ICB between 2018/19 and 2023/24. 

england_average_numbers_episodes<-calculating_england_average_numbers(number_percentage_over_time, episodes)


plotting_percentage_change_over_time_by_icb(number_percentage_over_time|>filter(!is.na(icb_2024_name)), episodes, icb_2024_name , england_average_numbers_episodes$change, 1.6, 1.3)

```


#### Beddays

```{r, fig.width=5, fig.height=3}
#| label: fig-number_trends_beddays_icb
#| fig-cap: The number of beddays for the Frail Older People (high frailty) mitigable activity cohort by ICB over the last 9 years. 

plotting_icb_over_time(number_percentage_over_time|>
        mutate(activity=beddays), 'Number')
```

<br>

```{r, fig.height=6, fig.width=8}
#| label: fig-percent_change_number_beddays
#| fig-cap: The percentage change in the number of Frail Older People (high frailty) beddays by ICB between 2018/19 and 2023/24. 

england_average_numbers_beddays<-calculating_england_average_numbers(number_percentage_over_time, beddays)


plotting_percentage_change_over_time_by_icb(number_percentage_over_time|>filter(!is.na(icb_2024_name)), beddays, icb_2024_name, england_average_numbers_beddays$change, 1.6, 1.3)

```

:::

#### Crude rate

Frail Older People (high frailty) activity as a percentage of total emergency activity by ICB.

::: panel-tabset
#### Admissions

```{r, fig.width=5, fig.height=3}
#| label: fig-percent_trends_spells_icb
#| fig-cap: The percentage of total emergency admissions that are for Frail Older People (high frailty) potentially mitigable activity by ICB over the last 9 years. 

plotting_icb_over_time(number_percentage_over_time|>
        mutate(activity=percentage_episodes)|>
          filter(!is.na(activity)), 'Percentage')

```

<br>

```{r, fig.height=6, fig.width=8}
#| label: fig-percent_change_percent_spells
#| fig-cap: The percentage change in the proportion emergency admissions that are Frail Older People (high frailty) admissions by ICB between 2018/19 and 2023/24. 

england_average_percentage_episodes<-calculating_england_average_percentage(number_percentage_over_time|> filter(!is.na(total_episodes)), episodes, total_episodes)

plotting_percentage_change_over_time_by_icb(number_percentage_over_time|>filter(!is.na(icb_2024_name)), percentage_episodes, icb_2024_name, england_average_percentage_episodes$change, 1.6, 1.3)


```

#### Beddays

```{r, fig.width=5, fig.height=3}
#| label: fig-percent_trends_beddays_icb
#| fig-cap: The percentage of total emergency beddays that are for Frail Older People (high frailty) potentially mitigable activity by ICB over the last 9 years. 

plotting_icb_over_time(number_percentage_over_time|>
        mutate(activity=percentage_beddays)|>
          filter(!is.na(activity)), 'Percentage')

```

<br>

```{r, fig.height=6, fig.width=8}
#| label: fig-percent_change_percent_beddays
#| fig-cap: The percentage change in the proportion emergency beddays that are Frail Older People (high frailty) beddays by ICB between 2018/19 and 2023/24. 

england_average_percentage_beddays<-calculating_england_average_percentage(number_percentage_over_time|>
          filter(!is.na(percentage_beddays)), beddays, total_beddays)

plotting_percentage_change_over_time_by_icb(number_percentage_over_time|>filter(!is.na(icb_2024_name)), percentage_beddays, icb_2024_name, england_average_percentage_beddays$change,  1.6, 1.3)


```
:::

#### Age and sex standardised rates over time

::: panel-tabset
#### Admissions

```{r, fig.width=5, fig.height=3}
#| label: fig-stardardised_trends_spells_icb
#| fig-cap: Age and sex standardised rate of admissions for Frail Older People (high frailty) potentially mitigable activity by ICB over the last 9 years. 

icb_age_sex_standardised_rates_episodes<-tar_read(icb_age_sex_standardised_rates_episodes)

plotting_icb_over_time(
  (icb_age_sex_standardised_rates_episodes|> 
     filter(cohorts==cohort)|>
     mutate(activity=value)),
  'Standardised rate per 100,000')

```

<br>

```{r, fig.height=6, fig.width=8}
#| label: fig-percent_change_standardised_spells
#| fig-cap: The percentage change in the standardised rate of Frail Older People (high frailty) admissions by ICB between 2018/19 and 2023/24. 

england_average_standardised_episodes<-calculating_england_average_standardised(england_age_sex_standardised_rates_episodes)

plotting_percentage_change_over_time_by_icb(icb_age_sex_standardised_rates_episodes|> 
     filter(cohorts==cohort), value, icb_2024_name, england_average_standardised_episodes$change, 1.3, 1.7)


```

#### Beddays

```{r, fig.width=5, fig.height=3}
#| label: fig-stardardised_trends_beddays_icb
#| fig-cap: Age and sex standardised rate of beddays for Frail Older People (high frailty) potentially mitigable activity by ICB over the last 9 years.

icb_age_sex_standardised_rates_beddays<-tar_read(icb_age_sex_standardised_rates_beddays)

plotting_icb_over_time(
  (icb_age_sex_standardised_rates_beddays|> 
     filter(cohorts==cohort)|>
     mutate(activity=value)),
  'Standardised rate per 100,000')

```

<br>

```{r, fig.height=6, fig.width=8}
#| label: fig-percent_change_standardised_beddays
#| fig-cap: The percentage change in the standardised rate of Frail Older People (high frailty) beddays by ICB between 2018/19 and 2023/24. 


england_average_standardised_beddays<-calculating_england_average_standardised(england_age_sex_standardised_rates_beddays)


plotting_percentage_change_over_time_by_icb(icb_age_sex_standardised_rates_beddays|> 
     filter(cohorts==cohort), value, icb_2024_name, england_average_standardised_beddays$change, 1.4, 1.6)


```
:::
:::

### Change in age and sex standardised rate over time relative to level of activity

This chart shows the percentage change for each ICB relative to it's starting level of admissions/beddays to help demonstrate performance across ICBs. For example, those in the lower left quadrant already had relatively low standardised rates of admissions/beddays in 2018/19 and have continued to make further decreases over the last five years.

::: panel-tabset
#### Admissions

```{r, fig.width=5, fig.height=4}
#| label: fig-activity_vs_rate_of_change_episodes
#| fig-cap: The standardised rate of Frail Older People (high frailty) admissions (in 2018/19) versus the percentage change in admissions between 2018/19 and 2023/24 for ICBs. 
#| 
plotting_total_activity_vs_percentage_change(icb_age_sex_standardised_rates_episodes, value)


```
#### Beddays

```{r, fig.width=5, fig.height=4}
#| label: fig-activity_vs_rate_of_change_beddays
#| fig-cap: The standardised rate of Frail Older People (high frailty) beddays (in 2018/19) versus the percentage change in admissions between 2018/19 and 2023/24 for ICBs. 
#| 
plotting_total_activity_vs_percentage_change(icb_age_sex_standardised_rates_beddays, value)


```

:::

### Local Authority

```{r}

  

```
