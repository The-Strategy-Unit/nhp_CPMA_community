# Redirection and Substitution

```{r}
library("flextable")
library("tidyr")
library("dplyr")
library("ggplot2")
library("StrategyUnitTheme")
library("forcats")
library("ComplexUpset")
library("scales")
library("targets")
library("plotly")
library("patchwork")

source("R/captions.R")
source("R/general.R")
source("R/descriptive_analyses.R")
source("R/comparative_analyses.R")
source("R/Functions for cohort overlap.R")
source("R/Functions for trend analysis.R")

options(scipen = 999)
```

```{r global variables}
cohort <- "redirection_substitution"
cohort_title <- "Redirection and Substitution"
treatment_type <- "both"
```

```{r}
england_age_sex_standardised_rates_episodes<-tar_read(england_age_sex_standardised_rates_episodes)|>
  filter(cohorts==cohort)

england_age_sex_standardised_rates_beddays<-tar_read(england_age_sex_standardised_rates_beddays)|>
  filter(cohorts==cohort)
```

What this mechanism is...

## Descriptive Analysis of Mitigable Activity

```{r}
overview_redirection_substitution <- targets::tar_read(overview_redirection_substitution)

redirection_substitution_admissions_perc <- overview_redirection_substitution |>
  dplyr::filter(activity_type == "Admissions") |>
  dplyr::pull(perc)

redirection_substitution_beddays_perc <- overview_redirection_substitution |>
  dplyr::filter(activity_type == "Beddays") |>
  dplyr::pull(perc)
```

In 2023/24, `r redirection_substitution_admissions_perc`% of all (both emergency and elective) admissions and `r redirection_substitution_beddays_perc`% of all beddays fall under mitigable activity for the Redirection and Substitution group (@tbl-perc_redirection_substitution).

```{r}
#| label: tbl-perc_redirection_substitution
#| tbl-cap: !expr get_caption_overview(cohort_title, treatment_type)
overview_redirection_substitution |>
  get_table_perc()
```

### Patient Characteristics

::: panel-tabset
### Admissions

::: panel-tabset
### Age

```{r}
perc_age_redirection_substitution_admissions <- targets::tar_read(perc_age_redirection_substitution_admissions)
rates_age_redirection_substitution_admissions <- targets::tar_read(rates_age_redirection_substitution_admissions)
```

::: panel-tabset
#### Percentage of emergency activity

```{r}
#| label: tbl-perc_age_redirection_substitution_admissions
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "age group", treatment_type)
perc_age_redirection_substitution_admissions |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_age_redirection_substitution_admissions
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "age group", treatment_type)
perc_age_redirection_substitution_admissions |>
  get_perc_by_group_plot("age_range", "admissions")
```

#### Rates per 100,000 population

```{r}
#| label: tbl-rate_redirection_substitution_age_admissions
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "age group")
rates_age_redirection_substitution_admissions |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_redirection_substitution_age_admissions
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "age group")
rates_age_redirection_substitution_admissions |>
  get_rates_by_group_plot("age_range")
```
:::

### Ethnicity

```{r}
perc_ethnicity_redirection_substitution_admissions <- targets::tar_read(perc_ethnicity_redirection_substitution_admissions)
rates_ethnicity_redirection_substitution_admissions <- targets::tar_read(rates_ethnicity_redirection_substitution_admissions)
```

::: panel-tabset
#### Percentage of emergency activity

```{r}
#| label: tbl-perc_ethnicity_redirection_substitution_admissions
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "ethnicity", treatment_type)
perc_ethnicity_redirection_substitution_admissions |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_ethnicity_redirection_substitution_admissions
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "ethnicity", treatment_type)
perc_ethnicity_redirection_substitution_admissions |>
  get_perc_by_group_plot("Ethnic_Category", "admissions")
```

#### Rates per 100,000 population

```{r}
#| label: tbl-rate_redirection_substitution_ethnicity_admissions
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "ethnicity")
rates_ethnicity_redirection_substitution_admissions |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_redirection_substitution_ethnicity_admissions
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "ethnicity")
rates_ethnicity_redirection_substitution_admissions |>
  get_rates_by_group_plot("Ethnic_Category")
```
:::

### IMD

```{r}
perc_imd_redirection_substitution_admissions <- targets::tar_read(perc_imd_redirection_substitution_admissions)
rates_imd_redirection_substitution_admissions <- targets::tar_read(rates_imd_redirection_substitution_admissions)
```

::: panel-tabset
#### Percentage of emergency activity

```{r}
#| label: tbl-perc_imd_redirection_substitution_admissions
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "imd", treatment_type)
perc_imd_redirection_substitution_admissions |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_imd_redirection_substitution_admissions
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "imd", treatment_type)
perc_imd_redirection_substitution_admissions |>
  get_perc_by_group_plot("imd19_decile", "admissions")
```

#### Rates per 100,000 population

```{r}
#| label: tbl-rate_redirection_substitution_imd_admissions
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "imd")
rates_imd_redirection_substitution_admissions |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_redirection_substitution_imd_admissions
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "imd")
rates_imd_redirection_substitution_admissions |>
  get_rates_by_group_plot("imd19_decile")
```
:::

### Sex

```{r}
perc_sex_redirection_substitution_admissions <- targets::tar_read(perc_sex_redirection_substitution_admissions)
rates_sex_redirection_substitution_admissions <- targets::tar_read(rates_sex_redirection_substitution_admissions)
```

::: panel-tabset
#### Percentage of emergency activity

```{r}
#| label: tbl-perc_sex_redirection_substitution_admissions
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "sex", treatment_type)
perc_sex_redirection_substitution_admissions |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_sex_redirection_substitution_admissions
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "sex", treatment_type)
perc_sex_redirection_substitution_admissions |>
  get_perc_by_group_plot("sex", "admissions")
```

#### Rates per 100,000 population

```{r}
#| label: tbl-rate_redirection_substitution_sex_admissions
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "sex")
rates_sex_redirection_substitution_admissions |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_redirection_substitution_sex_admissions
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "sex")
rates_sex_redirection_substitution_admissions |>
  get_rates_by_group_plot("sex")
```
:::
:::

### Beddays

::: panel-tabset
### Age

```{r}
perc_age_redirection_substitution_beddays <- targets::tar_read(perc_age_redirection_substitution_beddays)
rates_age_redirection_substitution_beddays <- targets::tar_read(rates_age_redirection_substitution_beddays)
```

::: panel-tabset
#### Percentage of emergency activity

```{r}
#| label: tbl-perc_age_redirection_substitution_beddays
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "age group", treatment_type)
targets::tar_read(perc_age_redirection_substitution_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_age_redirection_substitution_beddays
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "age group", treatment_type)
targets::tar_read(perc_age_redirection_substitution_beddays) |>
  get_perc_by_group_plot("age_range", "beddays")
```

#### Rates per 100,000 population

```{r}
#| label: tbl-rate_redirection_substitution_age_beddays
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "age group")
targets::tar_read(rates_age_redirection_substitution_beddays) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_redirection_substitution_age_beddays
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "age group")
targets::tar_read(rates_age_redirection_substitution_beddays) |>
  get_rates_by_group_plot("age_range")
```
:::

### Ethnicity

```{r}
perc_ethnicity_redirection_substitution_beddays <- targets::tar_read(perc_ethnicity_redirection_substitution_beddays)
rates_ethnicity_redirection_substitution_beddays <- targets::tar_read(rates_ethnicity_redirection_substitution_beddays)
```

::: panel-tabset
#### Percentage of emergency activity

```{r}
#| label: tbl-perc_ethnicity_redirection_substitution_beddays
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "ethnicity", treatment_type)
targets::tar_read(perc_ethnicity_redirection_substitution_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_ethnicity_redirection_substitution_beddays
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "ethnicity", treatment_type)
targets::tar_read(perc_ethnicity_redirection_substitution_beddays) |>
  get_perc_by_group_plot("Ethnic_Category", "beddays")
```

#### Rates per 100,000 population

```{r}
#| label: tbl-rate_redirection_substitution_ethnicity_beddays
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "ethnicity")
targets::tar_read(rates_ethnicity_redirection_substitution_beddays) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_redirection_substitution_ethnicity_beddays
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "ethnicity")
targets::tar_read(rates_ethnicity_redirection_substitution_beddays) |>
  get_rates_by_group_plot("Ethnic_Category")
```
:::

### IMD

```{r}
perc_imd_redirection_substitution_beddays <- targets::tar_read(perc_imd_redirection_substitution_beddays)
rates_imd_redirection_substitution_beddays <- targets::tar_read(rates_imd_redirection_substitution_beddays)
```

::: panel-tabset
#### Percentage of emergency activity

```{r}
#| label: tbl-perc_imd_redirection_substitution_beddays
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "imd", treatment_type)
targets::tar_read(perc_imd_redirection_substitution_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_imd_redirection_substitution_beddays
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "imd", treatment_type)
targets::tar_read(perc_imd_redirection_substitution_beddays) |>
  get_perc_by_group_plot("imd19_decile", "beddays")
```

#### Rates per 100,000 population

```{r}
#| label: tbl-rate_redirection_substitution_imd_beddays
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "imd")
targets::tar_read(rates_imd_redirection_substitution_beddays) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_redirection_substitution_imd_beddays
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "imd")
targets::tar_read(rates_imd_redirection_substitution_beddays) |>
  get_rates_by_group_plot("imd19_decile")
```
:::

### Sex

```{r}
perc_sex_redirection_substitution_beddays <- targets::tar_read(perc_sex_redirection_substitution_beddays)
rates_sex_redirection_substitution_beddays <- targets::tar_read(rates_sex_redirection_substitution_beddays)
```

::: panel-tabset
#### Percentage of emergency activity

```{r}
#| label: tbl-perc_sex_redirection_substitution_beddays
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "sex", treatment_type)
targets::tar_read(perc_sex_redirection_substitution_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_sex_redirection_substitution_beddays
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "sex", treatment_type)
targets::tar_read(perc_sex_redirection_substitution_beddays) |>
  get_perc_by_group_plot("sex", "beddays")
```

#### Rates per 100,000 population

```{r}
#| label: tbl-rate_redirection_substitution_sex_beddays
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "sex")
targets::tar_read(rates_sex_redirection_substitution_beddays) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_redirection_substitution_sex_beddays
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "sex")
targets::tar_read(rates_sex_redirection_substitution_beddays) |>
  get_rates_by_group_plot("sex")
```
:::
:::
:::

### Admission Characteristics

::: panel-tabset
### Length Of Stay

```{r}
perc_los_redirection_substitution <- targets::tar_read(perc_los_redirection_substitution)
```

```{r}
#| label: tbl-perc_los_redirection_substitution
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "los", treatment_type)
perc_los_redirection_substitution |>
  get_perc_by_los_table()
```

```{r}
#| label: fig-perc_los_redirection_substitution
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "los", treatment_type)
perc_los_redirection_substitution |>
  get_perc_by_los_plot()
```

### Specialty

::: panel-tabset
#### Admissions

```{r}
#| label: tbl-perc_specialty_redirection_substitution_admissions
#| tbl-cap: !expr get_caption_top_ten_specialties(cohort_title, "admissions")
targets::tar_read(specialty_redirection_substitution_admissions) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_specialty_redirection_substitution_admissions
#| fig-cap: !expr get_caption_top_ten_specialties(cohort_title, "admissions")
targets::tar_read(specialty_redirection_substitution_admissions)  |>
  get_top_ten_specialties_plot("admissions")
```

#### Beddays

```{r}
#| label: tbl-perc_specialty_redirection_substitution_beddays
#| tbl-cap: !expr get_caption_top_ten_specialties(cohort_title, "beddays")
targets::tar_read(specialty_redirection_substitution_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_specialty_redirection_substitution_beddays
#| fig-cap: !expr get_caption_top_ten_specialties(cohort_title, "beddays")
targets::tar_read(specialty_redirection_substitution_beddays) |>
  get_top_ten_specialties_plot("beddays")
```
:::
:::

## Cohort overlap

(Placeholder)

## Comparative Analysis

::: panel-tabset
### Admissions

::: panel-tabset
#### Integrated Care Board

```{r}
#| output: false
summary_icb_admissions_redirection_substitution <- targets::tar_read(summary_icb_admissions_redirection_substitution)

icb_23_shp <- sf::st_read("https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/Integrated_Care_Boards_April_2023_EN_BGC/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson") |>
  janitor::clean_names() |>
  dplyr::mutate(icb23nm = simplify_icb_name(icb23nm))

number_icb_admissions_redirection_substitution_map <- summary_icb_admissions_redirection_substitution |>
  get_summary_by_icb_map(icb_23_shp, "total_count")

perc_icb_admissions_redirection_substitution_map <- summary_icb_admissions_redirection_substitution |>
  get_summary_by_icb_map(icb_23_shp, "perc")

rate_icb_admissions_redirection_substitution_map <- summary_icb_admissions_redirection_substitution |>
  get_summary_by_icb_map(icb_23_shp, "value")
```

::: panel-tabset
##### Number of admissions

::: panel-tabset
###### Bars

```{r}
#| label: fig-number_icb_admissions_redirection_substitution_bar
#| fig-cap: !expr get_caption_by_icb(cohort_title, "number", "admissions")
england_value <- get_england_value("total_count", 
                                   data_number = summary_icb_admissions_redirection_substitution)

get_summary_by_icb_bar(summary_icb_admissions_redirection_substitution, 
                       "total_count", 
                       cohort,
                       england_value)

rm(england_value)
```

###### Map

```{r}
#| label: fig-number_icb_admissions_redirection_substitution_map
#| fig-cap: !expr get_caption_by_icb(cohort_title, "number", "admissions")
number_icb_admissions_redirection_substitution_map
```
:::

##### Percentage of emergency activity

::: panel-tabset
###### Bars

```{r}
#| label: fig-perc_icb_admissions_redirection_substitution_bar
#| fig-cap: !expr get_caption_by_icb(cohort_title, "perc", "admissions", treatment_type)
total_beddays_admissions <- targets::tar_read(total_beddays_admissions)

england_value <- get_england_value("perc", 
                                   activity = "admissions",
                                   treatment = treatment_type,
                                   data_rate = england_age_sex_standardised_rates_episodes,
                                   cohort = cohort)

get_summary_by_icb_bar(summary_icb_admissions_redirection_substitution, 
                       "perc", 
                       cohort,
                       england_value)

rm(england_value)
```

###### Map

```{r}
#| label: fig-perc_icb_admissions_redirection_substitution_map
#| fig-cap: !expr get_caption_by_icb(cohort_title, "perc", "admissions", treatment_type)
perc_icb_admissions_redirection_substitution_map
```
:::

##### Age and sex standardised rates per 100,000 population

::: panel-tabset
###### Bars

```{r}
#| label: fig-rate_icb_admissions_redirection_substitution_bar
#| fig-cap: !expr get_caption_by_icb(cohort_title, "SR", "admissions")
england_value <- get_england_value("value",
                                   data_rate = england_age_sex_standardised_rates_episodes,
                                   cohort = cohort)

get_summary_by_icb_bar(summary_icb_admissions_redirection_substitution, 
                       "value", 
                       cohort,
                       england_value)

rm(england_value)
```

###### Map

```{r}
#| label: fig-rate_icb_admissions_redirection_substitution_map
#| fig-cap: !expr get_caption_by_icb(cohort_title, "SR", "admissions")
rate_icb_admissions_redirection_substitution_map
```
:::

##### Table

```{r}
#| label: tbl-rate_icb_admissions_redirection_substitution
#| tbl-cap: !expr get_caption_by_geography_table(cohort_title, "admissions", treatment_type, "icb")
get_summary_by_geography_table(summary_icb_admissions_redirection_substitution, "episodes", treatment_type)
```
:::

#### Local Authority

```{r}
#| label: tbl-rate_la_admissions_redirection_substitution
#| tbl-cap: !expr get_caption_by_geography_table(cohort_title, "admissions", treatment_type, "la")
targets::tar_read(summary_la_admissions_redirection_substitution) |>
  get_summary_by_geography_table("episodes", treatment_type)
```
:::

### Beddays

::: panel-tabset
#### Integrated Care Board

```{r}
#| output: false
summary_icb_beddays_redirection_substitution <- targets::tar_read(summary_icb_beddays_redirection_substitution)

number_icb_beddays_redirection_substitution_map <- summary_icb_beddays_redirection_substitution |>
  get_summary_by_icb_map(icb_23_shp, "total_count")

perc_icb_beddays_redirection_substitution_map <- summary_icb_beddays_redirection_substitution |>
  get_summary_by_icb_map(icb_23_shp, "perc")

rate_icb_beddays_redirection_substitution_map <- summary_icb_beddays_redirection_substitution |>
  get_summary_by_icb_map(icb_23_shp, "value")
```

::: panel-tabset
##### Number of beddays

::: panel-tabset
###### Bars

```{r}
#| label: fig-number_icb_beddays_redirection_substitution_bar
#| fig-cap: !expr get_caption_by_icb(cohort_title, "number", "beddays")
england_value <- get_england_value("total_count", 
                                   data_number = summary_icb_beddays_redirection_substitution)

get_summary_by_icb_bar(summary_icb_beddays_redirection_substitution, 
                       "total_count", 
                       cohort,
                       england_value)

rm(england_value)
```

###### Map

```{r}
#| label: fig-number_icb_beddays_redirection_substitution_map
#| fig-cap: !expr get_caption_by_icb(cohort_title, "number", "beddays")
number_icb_beddays_redirection_substitution_map
```
:::

##### Percentage of emergency activity

::: panel-tabset
###### Bars

```{r}
#| label: fig-perc_icb_beddays_redirection_substitution_bar
#| fig-cap: !expr get_caption_by_icb(cohort_title, "perc", "beddays", treatment_type)
total_beddays_admissions <- targets::tar_read(total_beddays_admissions)

england_value <- get_england_value("perc", 
                                   activity = "beddays",
                                   treatment = treatment_type,
                                   data_rate = england_age_sex_standardised_rates_beddays,
                                   cohort = cohort)

get_summary_by_icb_bar(summary_icb_beddays_redirection_substitution, 
                       "perc", 
                       cohort,
                       england_value)

rm(england_value)
```

###### Map

```{r}
#| label: fig-perc_icb_beddays_redirection_substitution_map
#| fig-cap: !expr get_caption_by_icb(cohort_title, "perc", "beddays", treatment_type)
perc_icb_beddays_redirection_substitution_map
```
:::

##### Age and sex standardised rates per 100,000 population

::: panel-tabset
###### Bars

```{r}
#| label: fig-rate_icb_beddays_redirection_substitution_bar
#| fig-cap: !expr get_caption_by_icb(cohort_title, "SR", "beddays")
england_value <- get_england_value("value",
                                   data_rate = england_age_sex_standardised_rates_beddays,
                                   cohort = cohort)

get_summary_by_icb_bar(summary_icb_beddays_redirection_substitution, 
                       "value", 
                       cohort,
                       england_value)

rm(england_value)
```

###### Map

```{r}
#| label: fig-rate_icb_beddays_redirection_substitution_map
#| fig-cap: !expr get_caption_by_icb(cohort_title, "SR", "beddays")
rate_icb_beddays_redirection_substitution_map
```
:::

##### Table

```{r}
#| label: tbl-rate_icb_beddays_redirection_substitution
#| tbl-cap: !expr get_caption_by_geography_table(cohort_title, "beddays", treatment_type, "icb")
get_summary_by_geography_table(summary_icb_beddays_redirection_substitution, "beddays", treatment_type)
```
:::

#### Local Authority

```{r}
#| label: tbl-rate_la_beddays_redirection_substitution
#| tbl-cap: !expr get_caption_by_geography_table(cohort_title, "beddays", treatment_type, "la")
targets::tar_read(summary_la_beddays_redirection_substitution) |>
  get_summary_by_geography_table("beddays", treatment_type)
```
:::
:::

## Trend Analysis

(Placeholder)