# Redirection and Substitution

```{r}
library("flextable")
library("tidyr")
library("dplyr")
library("ggplot2")
library("StrategyUnitTheme")
library("forcats")
library("ComplexUpset")
library("scales")
library("targets")
library("plotly")
library("patchwork")

source("R/captions.R")
source("R/general.R")
source("R/descriptive_analyses.R")
source("R/comparative_analyses.R")
source("R/Functions for cohort overlap.R")
source("R/Functions for trend analysis.R")

options(scipen = 999)
```

```{r global variables}
cohort <- "redirection_substitution"
cohort_title <- "Redirection and Substitution"
treatment_type <- "both"
```

```{r}
# england_age_sex_standardised_rates_episodes<-tar_read(england_age_sex_standardised_rates_episodes)|>
#   filter(cohorts==cohort)
# 
# england_age_sex_standardised_rates_beddays<-tar_read(england_age_sex_standardised_rates_beddays)|>
#   filter(cohorts==cohort)
```

What this mechanism is...

## Descriptive Analysis of Mitigable Activity

```{r}
overview_redirection_substitution <- targets::tar_read(overview_redirection_substitution)

redirection_substitution_admissions_perc <- overview_redirection_substitution |>
  dplyr::filter(activity_type == "Admissions") |>
  dplyr::pull(perc)

redirection_substitution_beddays_perc <- overview_redirection_substitution |>
  dplyr::filter(activity_type == "Beddays") |>
  dplyr::pull(perc)
```

In 2023/24, `r redirection_substitution_admissions_perc`% of all (both emergency and elective) admissions and `r redirection_substitution_beddays_perc`% of all beddays fall under mitigable activity for the Redirection and Substitution group (@tbl-perc_redirection_substitution).

```{r}
#| label: tbl-perc_redirection_substitution
#| tbl-cap: !expr get_caption_overview(cohort_title, treatment_type)
overview_redirection_substitution |>
  get_table_perc()
```

### Patient Characteristics

In this section, the number and percentage of mitigable activity for the Redirection and Substitution group cohort are shown by patient characteristics: age, ethnic category, IMD decile and sex. Rates per 100,000 population are also provided for context.

Outputs are presented for both admissions and beddays, but patterns are broadly similar across the two.

::: panel-tabset
### Admissions

::: panel-tabset
### Age

```{r}
perc_redirection_substitution_age_admissions <- targets::tar_read(perc_redirection_substitution_age_admissions)
rates_redirection_substitution_age_admissions <- targets::tar_read(rates_redirection_substitution_age_admissions)
```

::: panel-tabset
#### Percentage of emergency activity

```{r}
#| label: tbl-perc_redirection_substitution_age_admissions
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "age group", treatment_type)
perc_redirection_substitution_age_admissions |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_redirection_substitution_age_admissions
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "age group", treatment_type)
perc_redirection_substitution_age_admissions |>
  get_perc_by_group_plot("age_range", "admissions")
```

#### Rates per 100,000 population

```{r}
#| label: tbl-rate_redirection_substitution_age_admissions
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "age group")
rates_redirection_substitution_age_admissions |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_redirection_substitution_age_admissions
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "age group")
rates_redirection_substitution_age_admissions |>
  get_rates_by_group_plot("age_range")
```
:::

### Ethnicity

```{r}
perc_redirection_substitution_ethnicity_admissions <- targets::tar_read(perc_redirection_substitution_ethnicity_admissions)
rates_redirection_substitution_ethnicity_admissions <- targets::tar_read(rates_redirection_substitution_ethnicity_admissions)
```

::: panel-tabset
#### Percentage of emergency activity

```{r}
#| label: tbl-perc_redirection_substitution_ethnicity_admissions
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "ethnicity", treatment_type)
perc_redirection_substitution_ethnicity_admissions |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_redirection_substitution_ethnicity_admissions
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "ethnicity", treatment_type)
perc_redirection_substitution_ethnicity_admissions |>
  get_perc_by_group_plot("Ethnic_Category", "admissions")
```

#### Rates per 100,000 population

```{r}
#| label: tbl-rate_redirection_substitution_ethnicity_admissions
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "ethnicity")
rates_redirection_substitution_ethnicity_admissions |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_redirection_substitution_ethnicity_admissions
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "ethnicity")
rates_redirection_substitution_ethnicity_admissions |>
  get_rates_by_group_plot("Ethnic_Category")
```
:::

### IMD

```{r}
perc_redirection_substitution_imd_admissions <- targets::tar_read(perc_redirection_substitution_imd_admissions)
rates_redirection_substitution_imd_admissions <- targets::tar_read(rates_redirection_substitution_imd_admissions)
```

::: panel-tabset
#### Percentage of emergency activity

```{r}
#| label: tbl-perc_redirection_substitution_imd_admissions
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "imd", treatment_type)
perc_redirection_substitution_imd_admissions |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_redirection_substitution_imd_admissions
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "imd", treatment_type)
perc_redirection_substitution_imd_admissions |>
  get_perc_by_group_plot("imd19_decile", "admissions")
```

#### Rates per 100,000 population

```{r}
#| label: tbl-rate_redirection_substitution_imd_admissions
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "imd")
rates_redirection_substitution_imd_admissions |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_redirection_substitution_imd_admissions
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "imd")
rates_redirection_substitution_imd_admissions |>
  get_rates_by_group_plot("imd19_decile")
```
:::

### Sex

```{r}
perc_redirection_substitution_sex_admissions <- targets::tar_read(perc_redirection_substitution_sex_admissions)
rates_redirection_substitution_sex_admissions <- targets::tar_read(rates_redirection_substitution_sex_admissions)
```

::: panel-tabset
#### Percentage of emergency activity

```{r}
#| label: tbl-perc_redirection_substitution_sex_admissions
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "sex", treatment_type)
perc_redirection_substitution_sex_admissions |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_redirection_substitution_sex_admissions
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "sex", treatment_type)
perc_redirection_substitution_sex_admissions |>
  get_perc_by_group_plot("sex", "admissions")
```

#### Rates per 100,000 population

```{r}
#| label: tbl-rate_redirection_substitution_sex_admissions
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "sex")
rates_redirection_substitution_sex_admissions |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_redirection_substitution_sex_admissions
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "sex")
rates_redirection_substitution_sex_admissions |>
  get_rates_by_group_plot("sex")
```
:::
:::

### Beddays

::: panel-tabset
### Age

```{r}
perc_redirection_substitution_age_beddays <- targets::tar_read(perc_redirection_substitution_age_beddays)
rates_redirection_substitution_age_beddays <- targets::tar_read(rates_redirection_substitution_age_beddays)
```

::: panel-tabset
#### Percentage of emergency activity

```{r}
#| label: tbl-perc_redirection_substitution_age_beddays
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "age group", treatment_type)
targets::tar_read(perc_redirection_substitution_age_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_redirection_substitution_age_beddays
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "age group", treatment_type)
targets::tar_read(perc_redirection_substitution_age_beddays) |>
  get_perc_by_group_plot("age_range", "beddays")
```

#### Rates per 100,000 population

```{r}
#| label: tbl-rate_redirection_substitution_age_beddays
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "age group")
targets::tar_read(rates_redirection_substitution_age_beddays) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_redirection_substitution_age_beddays
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "age group")
targets::tar_read(rates_redirection_substitution_age_beddays) |>
  get_rates_by_group_plot("age_range")
```
:::

### Ethnicity

```{r}
perc_redirection_substitution_ethnicity_beddays <- targets::tar_read(perc_redirection_substitution_ethnicity_beddays)
rates_redirection_substitution_ethnicity_beddays <- targets::tar_read(rates_redirection_substitution_ethnicity_beddays)
```

::: panel-tabset
#### Percentage of emergency activity

```{r}
#| label: tbl-perc_redirection_substitution_ethnicity_beddays
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "ethnicity", treatment_type)
targets::tar_read(perc_redirection_substitution_ethnicity_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_redirection_substitution_ethnicity_beddays
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "ethnicity", treatment_type)
targets::tar_read(perc_redirection_substitution_ethnicity_beddays) |>
  get_perc_by_group_plot("Ethnic_Category", "beddays")
```

#### Rates per 100,000 population

```{r}
#| label: tbl-rate_redirection_substitution_ethnicity_beddays
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "ethnicity")
targets::tar_read(rates_redirection_substitution_ethnicity_beddays) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_redirection_substitution_ethnicity_beddays
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "ethnicity")
targets::tar_read(rates_redirection_substitution_ethnicity_beddays) |>
  get_rates_by_group_plot("Ethnic_Category")
```
:::

### IMD

```{r}
perc_redirection_substitution_imd_beddays <- targets::tar_read(perc_redirection_substitution_imd_beddays)
rates_redirection_substitution_imd_beddays <- targets::tar_read(rates_redirection_substitution_imd_beddays)
```

::: panel-tabset
#### Percentage of emergency activity

```{r}
#| label: tbl-perc_redirection_substitution_imd_beddays
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "imd", treatment_type)
targets::tar_read(perc_redirection_substitution_imd_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_redirection_substitution_imd_beddays
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "imd", treatment_type)
targets::tar_read(perc_redirection_substitution_imd_beddays) |>
  get_perc_by_group_plot("imd19_decile", "beddays")
```

#### Rates per 100,000 population

```{r}
#| label: tbl-rate_redirection_substitution_imd_beddays
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "imd")
targets::tar_read(rates_redirection_substitution_imd_beddays) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_redirection_substitution_imd_beddays
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "imd")
targets::tar_read(rates_redirection_substitution_imd_beddays) |>
  get_rates_by_group_plot("imd19_decile")
```
:::

### Sex

```{r}
perc_redirection_substitution_sex_beddays <- targets::tar_read(perc_redirection_substitution_sex_beddays)
rates_redirection_substitution_sex_beddays <- targets::tar_read(rates_redirection_substitution_sex_beddays)
```

::: panel-tabset
#### Percentage of emergency activity

```{r}
#| label: tbl-perc_redirection_substitution_sex_beddays
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "sex", treatment_type)
targets::tar_read(perc_redirection_substitution_sex_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_redirection_substitution_sex_beddays
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "sex", treatment_type)
targets::tar_read(perc_redirection_substitution_sex_beddays) |>
  get_perc_by_group_plot("sex", "beddays")
```

#### Rates per 100,000 population

```{r}
#| label: tbl-rate_redirection_substitution_sex_beddays
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "sex")
targets::tar_read(rates_redirection_substitution_sex_beddays) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_redirection_substitution_sex_beddays
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "sex")
targets::tar_read(rates_redirection_substitution_sex_beddays) |>
  get_rates_by_group_plot("sex")
```
:::
:::
:::

### Admission Characteristics

In this section, mitigable activity for the Redirection and Substitution group are shown by admission characteristics.

::: panel-tabset
### Length Of Stay

```{r}
perc_redirection_substitution_los <- targets::tar_read(perc_los_redirection_substitution)
```

```{r}
#| label: tbl-perc_redirection_substitution_los
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "los", treatment_type)
perc_redirection_substitution_los |>
  get_perc_by_los_table()
```

```{r}
#| label: fig-perc_redirection_substitution_los
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "los", treatment_type)
perc_redirection_substitution_los |>
  get_perc_by_los_plot()
```

### Specialty

::: panel-tabset
#### Admissions

```{r}
#| label: tbl-perc_redirection_substitution_mainspecf_admissions
#| tbl-cap: !expr get_caption_top_ten_specialties(cohort_title, "admissions")
targets::tar_read(specialties_top_ten_redirection_substitution_admissions) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_redirection_substitution_mainspecf_admissions
#| fig-cap: !expr get_caption_top_ten_specialties(cohort_title, "admissions")
targets::tar_read(specialties_top_ten_redirection_substitution_admissions)  |>
  get_top_ten_specialties_plot("admissions")
```

#### Beddays

```{r}
#| label: tbl-perc_redirection_substitution_mainspecf_beddays
#| tbl-cap: !expr get_caption_top_ten_specialties(cohort_title, "beddays")
targets::tar_read(specialties_top_ten_redirection_substitution_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_redirection_substitution_mainspecf_beddays
#| fig-cap: !expr get_caption_top_ten_specialties(cohort_title, "beddays")
targets::tar_read(specialties_top_ten_redirection_substitution_beddays) |>
  get_top_ten_specialties_plot("beddays")
```
:::
:::
