# Redirection and Substitution

```{r}
library("flextable")
library("tidyr")
library("dplyr")
library("ggplot2")
library("StrategyUnitTheme")
library("forcats")
library("ComplexUpset")
library("scales")
library("targets")
library("plotly")
library("patchwork")

source("R/captions.R")
source("R/general.R")
source("R/descriptive_analyses.R")
source("R/comparative_analyses.R")
source("R/Functions for cohort overlap.R")
source("R/Functions for trend analysis.R")

options(scipen = 999)
options(knitr.duplicate.label = "allow")
```

```{r global variables}
cohort <- "redirection_substitution"
cohort_title <- "Redirection and Substitution"
treatment_type <- "both"
treatment_type_title <- format_treatment_for_caption(treatment_type)
```

```{r}
#| output: false
mitigator_summary_table <- readxl::read_excel("summary_mitigators_table.xlsx") |>
  dplyr::mutate(mechanism = snakecase::to_snake_case(mechanism))

mechanisms <- mitigator_summary_table |> 
  dplyr::pull(mechanism) |> 
  unique()

england_age_sex_standardised_rates_episodes <- tar_read(england_age_sex_standardised_rates_episodes) |>
  filter(cohorts == cohort)

england_age_sex_standardised_rates_beddays <- tar_read(england_age_sex_standardised_rates_beddays) |>
  filter(cohorts == cohort)

total_beddays_admissions <- targets::tar_read(total_beddays_admissions)

icb_23_shp <- sf::st_read("https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/Integrated_Care_Boards_April_2023_EN_BGC/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson") |>
  janitor::clean_names() |>
  dplyr::mutate(icb23nm = simplify_icb_name(icb23nm))
```

What this mechanism is...

## Descriptive Analysis of Mitigable Activity

```{r}
overview <- targets::tar_read(overview_redirection_substitution)

redirection_substitution_admissions_perc <- overview |>
  dplyr::filter(activity_type == "Admissions") |>
  dplyr::pull(perc)

redirection_substitution_beddays_perc <- overview |>
  dplyr::filter(activity_type == "Beddays") |>
  dplyr::pull(perc)
```

In 2023/24, `r redirection_substitution_admissions_perc`% of all (both emergency and elective) admissions and `r redirection_substitution_beddays_perc`% of all beddays fall under mitigable activity for the Redirection and Substitution group (@tbl-perc_redirection_substitution).

```{r}
#| label: tbl-perc_redirection_substitution
#| tbl-cap: !expr get_caption_overview(cohort_title, treatment_type)
overview |>
  get_table_perc()
```

### Patient Characteristics

::: panel-tabset
### Admissions

::: panel-tabset
### Age

```{r}
perc_age_redirection_substitution_admissions <- targets::tar_read(perc_age_redirection_substitution_admissions)
rates_age_redirection_substitution_admissions <- targets::tar_read(rates_age_redirection_substitution_admissions)
```

::: panel-tabset
#### Percentage of `r treatment_type_title` activity

```{r}
#| label: tbl-perc_age_redirection_substitution_admissions
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "age group", treatment_type)
perc_age_redirection_substitution_admissions |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_age_redirection_substitution_admissions
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "age group", treatment_type)
perc_age_redirection_substitution_admissions |>
  get_perc_by_group_plot("age_range", "admissions")
```

#### Percentage of `r treatment_type_title` activity

```{r}
#| label: tbl-rate_redirection_substitution_age_admissions
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "age group")
rates_age_redirection_substitution_admissions |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_redirection_substitution_age_admissions
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "age group")
rates_age_redirection_substitution_admissions |>
  get_rates_by_group_plot("age_range")
```
:::

### Ethnicity

```{r}
perc_ethnicity_redirection_substitution_admissions <- targets::tar_read(perc_ethnicity_redirection_substitution_admissions)
rates_ethnicity_redirection_substitution_admissions <- targets::tar_read(rates_ethnicity_redirection_substitution_admissions)
```

::: panel-tabset
#### Percentage of `r treatment_type_title` activity

```{r}
#| label: tbl-perc_ethnicity_redirection_substitution_admissions
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "ethnicity", treatment_type)
perc_ethnicity_redirection_substitution_admissions |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_ethnicity_redirection_substitution_admissions
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "ethnicity", treatment_type)
perc_ethnicity_redirection_substitution_admissions |>
  get_perc_by_group_plot("Ethnic_Category", "admissions")
```

#### Percentage of `r treatment_type_title` activity

```{r}
#| label: tbl-rate_redirection_substitution_ethnicity_admissions
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "ethnicity")
rates_ethnicity_redirection_substitution_admissions |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_redirection_substitution_ethnicity_admissions
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "ethnicity")
rates_ethnicity_redirection_substitution_admissions |>
  get_rates_by_group_plot("Ethnic_Category")
```
:::

### IMD

```{r}
perc_imd_redirection_substitution_admissions <- targets::tar_read(perc_imd_redirection_substitution_admissions)
rates_imd_redirection_substitution_admissions <- targets::tar_read(rates_imd_redirection_substitution_admissions)
```

::: panel-tabset
#### Percentage of `r treatment_type_title` activity

```{r}
#| label: tbl-perc_imd_redirection_substitution_admissions
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "imd", treatment_type)
perc_imd_redirection_substitution_admissions |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_imd_redirection_substitution_admissions
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "imd", treatment_type)
perc_imd_redirection_substitution_admissions |>
  get_perc_by_group_plot("imd19_decile", "admissions")
```

#### Percentage of `r treatment_type_title` activity

```{r}
#| label: tbl-rate_redirection_substitution_imd_admissions
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "imd")
rates_imd_redirection_substitution_admissions |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_redirection_substitution_imd_admissions
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "imd")
rates_imd_redirection_substitution_admissions |>
  get_rates_by_group_plot("imd19_decile")
```
:::

### Sex

```{r}
perc_sex_redirection_substitution_admissions <- targets::tar_read(perc_sex_redirection_substitution_admissions)
rates_sex_redirection_substitution_admissions <- targets::tar_read(rates_sex_redirection_substitution_admissions)
```

::: panel-tabset
#### Percentage of `r treatment_type_title` activity

```{r}
#| label: tbl-perc_sex_redirection_substitution_admissions
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "sex", treatment_type)
perc_sex_redirection_substitution_admissions |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_sex_redirection_substitution_admissions
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "sex", treatment_type)
perc_sex_redirection_substitution_admissions |>
  get_perc_by_group_plot("sex", "admissions")
```

#### Percentage of `r treatment_type_title` activity

```{r}
#| label: tbl-rate_redirection_substitution_sex_admissions
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "sex")
rates_sex_redirection_substitution_admissions |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_redirection_substitution_sex_admissions
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "admissions", "sex")
rates_sex_redirection_substitution_admissions |>
  get_rates_by_group_plot("sex")
```
:::
:::

### Beddays

::: panel-tabset
### Age

```{r}
perc_age_redirection_substitution_beddays <- targets::tar_read(perc_age_redirection_substitution_beddays)
rates_age_redirection_substitution_beddays <- targets::tar_read(rates_age_redirection_substitution_beddays)
```

::: panel-tabset
#### Percentage of `r treatment_type_title` activity

```{r}
#| label: tbl-perc_age_redirection_substitution_beddays
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "age group", treatment_type)
targets::tar_read(perc_age_redirection_substitution_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_age_redirection_substitution_beddays
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "age group", treatment_type)
targets::tar_read(perc_age_redirection_substitution_beddays) |>
  get_perc_by_group_plot("age_range", "beddays")
```

#### Percentage of `r treatment_type_title` activity

```{r}
#| label: tbl-rate_redirection_substitution_age_beddays
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "age group")
targets::tar_read(rates_age_redirection_substitution_beddays) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_redirection_substitution_age_beddays
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "age group")
targets::tar_read(rates_age_redirection_substitution_beddays) |>
  get_rates_by_group_plot("age_range")
```
:::

### Ethnicity

```{r}
perc_ethnicity_redirection_substitution_beddays <- targets::tar_read(perc_ethnicity_redirection_substitution_beddays)
rates_ethnicity_redirection_substitution_beddays <- targets::tar_read(rates_ethnicity_redirection_substitution_beddays)
```

::: panel-tabset
#### Percentage of `r treatment_type_title` activity

```{r}
#| label: tbl-perc_ethnicity_redirection_substitution_beddays
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "ethnicity", treatment_type)
targets::tar_read(perc_ethnicity_redirection_substitution_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_ethnicity_redirection_substitution_beddays
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "ethnicity", treatment_type)
targets::tar_read(perc_ethnicity_redirection_substitution_beddays) |>
  get_perc_by_group_plot("Ethnic_Category", "beddays")
```

#### Percentage of `r treatment_type_title` activity

```{r}
#| label: tbl-rate_redirection_substitution_ethnicity_beddays
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "ethnicity")
targets::tar_read(rates_ethnicity_redirection_substitution_beddays) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_redirection_substitution_ethnicity_beddays
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "ethnicity")
targets::tar_read(rates_ethnicity_redirection_substitution_beddays) |>
  get_rates_by_group_plot("Ethnic_Category")
```
:::

### IMD

```{r}
perc_imd_redirection_substitution_beddays <- targets::tar_read(perc_imd_redirection_substitution_beddays)
rates_imd_redirection_substitution_beddays <- targets::tar_read(rates_imd_redirection_substitution_beddays)
```

::: panel-tabset
#### Percentage of `r treatment_type_title` activity

```{r}
#| label: tbl-perc_imd_redirection_substitution_beddays
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "imd", treatment_type)
targets::tar_read(perc_imd_redirection_substitution_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_imd_redirection_substitution_beddays
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "imd", treatment_type)
targets::tar_read(perc_imd_redirection_substitution_beddays) |>
  get_perc_by_group_plot("imd19_decile", "beddays")
```

#### Percentage of `r treatment_type_title` activity

```{r}
#| label: tbl-rate_redirection_substitution_imd_beddays
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "imd")
targets::tar_read(rates_imd_redirection_substitution_beddays) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_redirection_substitution_imd_beddays
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "imd")
targets::tar_read(rates_imd_redirection_substitution_beddays) |>
  get_rates_by_group_plot("imd19_decile")
```
:::

### Sex

```{r}
perc_sex_redirection_substitution_beddays <- targets::tar_read(perc_sex_redirection_substitution_beddays)
rates_sex_redirection_substitution_beddays <- targets::tar_read(rates_sex_redirection_substitution_beddays)
```

::: panel-tabset
#### Percentage of `r treatment_type_title` activity

```{r}
#| label: tbl-perc_sex_redirection_substitution_beddays
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "sex", treatment_type)
targets::tar_read(perc_sex_redirection_substitution_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_sex_redirection_substitution_beddays
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "beddays", "sex", treatment_type)
targets::tar_read(perc_sex_redirection_substitution_beddays) |>
  get_perc_by_group_plot("sex", "beddays")
```

#### Percentage of `r treatment_type_title` activity

```{r}
#| label: tbl-rate_redirection_substitution_sex_beddays
#| tbl-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "sex")
targets::tar_read(rates_sex_redirection_substitution_beddays) |>
  get_rates_by_group_table() 
```

```{r}
#| label: fig-rate_redirection_substitution_sex_beddays
#| fig-cap: !expr get_caption_by_group("rate", cohort_title, "beddays", "sex")
targets::tar_read(rates_sex_redirection_substitution_beddays) |>
  get_rates_by_group_plot("sex")
```
:::
:::
:::

### Admission Characteristics

::: panel-tabset
### Length Of Stay

```{r}
perc_los_redirection_substitution <- targets::tar_read(perc_los_redirection_substitution)
```

```{r}
#| label: tbl-perc_los_redirection_substitution
#| tbl-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "los", treatment_type)
perc_los_redirection_substitution |>
  get_perc_by_los_table()
```

```{r}
#| label: fig-perc_los_redirection_substitution
#| fig-cap: !expr get_caption_by_group("perc", cohort_title, "admissions", "los", treatment_type)
perc_los_redirection_substitution |>
  get_perc_by_los_plot()
```

### Specialty

::: panel-tabset
#### Admissions

```{r}
#| label: tbl-perc_specialty_redirection_substitution_admissions
#| tbl-cap: !expr get_caption_top_ten_specialties(cohort_title, "admissions")
targets::tar_read(specialty_redirection_substitution_admissions) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_specialty_redirection_substitution_admissions
#| fig-cap: !expr get_caption_top_ten_specialties(cohort_title, "admissions")
targets::tar_read(specialty_redirection_substitution_admissions)  |>
  get_top_ten_specialties_plot("admissions")
```

#### Beddays

```{r}
#| label: tbl-perc_specialty_redirection_substitution_beddays
#| tbl-cap: !expr get_caption_top_ten_specialties(cohort_title, "beddays")
targets::tar_read(specialty_redirection_substitution_beddays) |>
  get_table_perc() 
```

```{r}
#| label: fig-perc_specialty_redirection_substitution_beddays
#| fig-cap: !expr get_caption_top_ten_specialties(cohort_title, "beddays")
targets::tar_read(specialty_redirection_substitution_beddays) |>
  get_top_ten_specialties_plot("beddays")
```
:::
:::

## Cohort overlap

Many admissions meet the criteria to be included in more than one mitigator cohort. Since these potential mitigator cohorts are not mutually exclusive there is a need to understand which cohorts overlap and the degree of overlap between the cohorts.

### Number and proportion within multiple other cohorts

For the Redirection/Substitution mechanism group we show how much of the activity is included in other Redirection/Substitution groups. 

```{r}
overlap_numbers <- targets::tar_read(cohort_overlap_numbers_redirection)
```

```{r}
#| output: asis
knitr::knit_child(
  input = "child-dir/_child-overlap_number-within-others.qmd",
  envir = environment(),
  quiet = TRUE
  ) |>
  cat(sep = '\n')
```

### Most common cohort overlaps

Often overlap between a small number of groups can be visualised using Venn diagram. However, due to the large number of mitigator cohorts and therefore high numbers of potential combinations of overlaps we have used upset plots to show the largest overlaps between cohorts.

The 15 most common cohort combinations for the Redirection/Substitution mechanism group are shown. 

```{r}
#| output: asis
knitr::knit_child(
  input = "child-dir/_child-overlap_most-common.qmd",
  envir = environment(),
  quiet = TRUE
  ) |>
  cat(sep = '\n')
```

## Comparative Analysis

::: panel-tabset
### Admissions

```{r}
#| output: asis
activity_type <- "admissions"
summary_icb <- targets::tar_read_raw(glue::glue("summary_icb_{activity_type}_{cohort}"))
summary_la <- targets::tar_read_raw(glue::glue("summary_la_{activity_type}_{cohort}"))
standardised_rates <- england_age_sex_standardised_rates_episodes

knitr::knit_child(
                  input = "child-dir/_child-comparative.qmd",
                  envir = environment(),
                  quiet = TRUE
                ) |>
                  cat(sep = '\n')
```

### Beddays

```{r}
#| output: asis
activity_type <- "beddays"
summary_icb <- targets::tar_read_raw(glue::glue("summary_icb_{activity_type}_{cohort}"))
summary_la <- targets::tar_read_raw(glue::glue("summary_la_{activity_type}_{cohort}"))
standardised_rates <- england_age_sex_standardised_rates_beddays

knitr::knit_child(
                  input = "child-dir/_child-comparative.qmd",
                  envir = environment(),
                  quiet = TRUE
                ) |>
                  cat(sep = '\n')
```

:::

## Trend Analysis

We aim to understand whether there have been decreases, or increases, in potentially mitigable Redirection and Substitution activity over time. We have considered Redirection and Substitution admissions and beddays over the past 9 years in England as a whole and for each ICB, including:

a\) the absolute number of Redirection and Substitution admissions/beddays,

b\) these admissions/beddays as a proportion of emergency admissions,

c\) the age and sex standardised rates of these admissions/beddays using the England 2021 census population.

To help understand the variability between ICBs we have calculated for each ICB the percentage change in proportion of emergency admissions and in standardised rates between 2018/19 and 2023/24.

### England

::: panel-tabset
#### Number over time

::: panel-tabset
#### Admissions

```{r, fig.width=7, fig.height=3}
#| label: fig-number_trends_spells_england
#| fig-cap: !expr get_caption_trends(cohort_title, "number", "admissions", "England")

numbers_over_time<-tar_read(numbers_over_time)|>
  filter(year!="2014/15")|>
  filter(cohorts==cohort)

denominator_over_time<-tar_read(denominator_over_time)
icb_population_data<-tar_read(icb_population_data)

number_percentage_over_time<-  data_number_percentage_over_time_icb(denominator_over_time, 
                                    numbers_over_time,
                                       cohort,                 
                                    treatment_type)

plot_of_number_over_time(number_percentage_over_time, episodes)


```

#### Beddays

```{r, fig.width=7, fig.height=3}
#| label: fig-number_trends_beddays_england
#| fig-cap: !expr get_caption_trends(cohort_title, "number", "beddays", "England")
plot_of_number_over_time(number_percentage_over_time,  beddays)

```
:::

#### Percentage of `r treatment_type_title` activity

Potentially mitigable Redirection and Substitution activity as a percentage of total activity (elective and emergency admissions/beddays).

::: panel-tabset
#### Admissions

```{r, fig.width=7, fig.height=3}
#| label: fig-percent_trends_spells_england
#| fig-cap: !expr get_caption_trends(cohort_title, "perc", "admissions", "England")

plot_of_percentage_over_time(number_percentage_over_time|>
                               filter(!is.na(percentage_episodes)), 
          episodes, total_episodes)

```

#### Beddays

```{r, fig.width=7, fig.height=3}
#| label: fig-percent_trends_beddays_england
#| fig-cap: !expr get_caption_trends(cohort_title, "perc", "beddays", "England")

plot_of_percentage_over_time(number_percentage_over_time|>
                               filter(!is.na(percentage_beddays)),  beddays, total_beddays)

```
:::

#### Age and sex standardised rates over time

::: panel-tabset
#### Admissions

```{r, fig.width=7, fig.height=3}
#| label: fig-stardardised_trends_spells_england
#| fig-cap: !expr get_caption_trends(cohort_title, "SR", "admissions", "England") 

plot_of_standardised_rates_over_time(england_age_sex_standardised_rates_episodes)

```

#### Beddays

```{r, fig.width=7, fig.height=3}
#| label: fig-stardardised_trends_beddays_england
#| fig-cap: !expr get_caption_trends(cohort_title, "SR", "beddays", "England")

plot_of_standardised_rates_over_time(england_age_sex_standardised_rates_beddays)

```
:::
:::

### ICB

Note: Low numbers of admissions/beddays for Frimley ICB in 2022/23 reflect an issue with data submissions for this period. 

::: panel-tabset
#### Number over time

::: panel-tabset
#### Admissions

```{r, fig.width=5, fig.height=3}
#| label: fig-number_trends_spells_icb
#| fig-cap: !expr get_caption_trends(cohort_title, "number", "admissions", "icb") 

plotting_icb_over_time(number_percentage_over_time|>
        mutate(activity=episodes),
        'Number')

```

<br>

```{r, fig.height=6, fig.width=8}
#| label: fig-percent_change_number_spells
#| fig-cap: !expr get_caption_trends_percentage_change(cohort_title, "number", "admissions")

england_average_numbers_episodes<-calculating_england_average_numbers(number_percentage_over_time, episodes)


plotting_percentage_change_over_time_by_icb(number_percentage_over_time|>filter(!is.na(icb_2024_name)), episodes, icb_2024_name , england_average_numbers_episodes$change, 1.2, 1.3)

```


#### Beddays

```{r, fig.width=5, fig.height=3}
#| label: fig-number_trends_beddays_icb
#| fig-cap: !expr get_caption_trends(cohort_title, "number", "beddays", "icb")

plotting_icb_over_time(number_percentage_over_time|>
        mutate(activity=beddays), 'Number')
```

<br>

```{r, fig.height=6, fig.width=8}
#| label: fig-percent_change_number_beddays
#| fig-cap: !expr get_caption_trends_percentage_change(cohort_title, "number", "beddays") 

england_average_numbers_beddays<-calculating_england_average_numbers(number_percentage_over_time, beddays)


plotting_percentage_change_over_time_by_icb(number_percentage_over_time|>filter(!is.na(icb_2024_name)), beddays, icb_2024_name, england_average_numbers_beddays$change, 1.5, 1.2)

```

:::

#### Percentage of `r treatment_type_title` activity

Potentially mitigable Redirection and Substitution activity as a percentage of total activity (elective and emergency activity) by ICB.

::: panel-tabset
#### Admissions

```{r, fig.width=5, fig.height=3}
#| label: fig-percent_trends_spells_icb
#| fig-cap: !expr get_caption_trends(cohort_title, "percentage", "admissions", "icb")

plotting_icb_over_time(number_percentage_over_time|>
        mutate(activity=percentage_episodes)|>
          filter(!is.na(activity)), 'Percentage')

```

<br>

```{r, fig.height=6, fig.width=8}
#| label: fig-percent_change_percent_spells
#| fig-cap: !expr get_caption_trends_percentage_change(cohort_title, "prop", "admissions", treatment_type) 

england_average_percentage_episodes<-calculating_england_average_percentage(number_percentage_over_time|> filter(!is.na(total_episodes)), episodes, total_episodes)

plotting_percentage_change_over_time_by_icb(number_percentage_over_time|>filter(!is.na(icb_2024_name)), percentage_episodes, icb_2024_name, england_average_percentage_episodes$change, 1.2, 1.3)


```

#### Beddays

```{r, fig.width=5, fig.height=3}
#| label: fig-percent_trends_beddays_icb
#| fig-cap: !expr get_caption_trends(cohort_title, "percentage", "beddays", "icb")

plotting_icb_over_time(number_percentage_over_time|>
        mutate(activity=percentage_beddays)|>
          filter(!is.na(activity)), 'Percentage')

```

<br>

```{r, fig.height=6, fig.width=8}
#| label: fig-percent_change_percent_beddays
#| fig-cap: !expr get_caption_trends_percentage_change(cohort_title, "prop", "beddays", treatment_type) 

england_average_percentage_beddays<-calculating_england_average_percentage(number_percentage_over_time|>
          filter(!is.na(percentage_beddays)), beddays, total_beddays)

plotting_percentage_change_over_time_by_icb(number_percentage_over_time|>filter(!is.na(icb_2024_name)), percentage_beddays, icb_2024_name, england_average_percentage_beddays$change,  1.4, 1.1)


```
:::

#### Age and sex standardised rates over time

::: panel-tabset
#### Admissions

```{r, fig.width=5, fig.height=3}
#| label: fig-stardardised_trends_spells_icb
#| fig-cap: !expr get_caption_trends(cohort_title, "SR", "admissions", "icb")

icb_age_sex_standardised_rates_episodes<-tar_read(icb_age_sex_standardised_rates_episodes)

plotting_icb_over_time(
  (icb_age_sex_standardised_rates_episodes|> 
     filter(cohorts==cohort)|>
     mutate(activity=value)),
  'Standardised rate per 100,000')

```

<br>

```{r, fig.height=6, fig.width=8}
#| label: fig-percent_change_standardised_spells
#| fig-cap: !expr get_caption_trends_percentage_change(cohort_title, "SR", "admissions")

england_average_standardised_episodes<-calculating_england_average_standardised(england_age_sex_standardised_rates_episodes)

plotting_percentage_change_over_time_by_icb(icb_age_sex_standardised_rates_episodes|> 
     filter(cohorts==cohort), value, icb_2024_name, england_average_standardised_episodes$change, 1.3, 1.4)


```

#### Beddays

```{r, fig.width=5, fig.height=3}
#| label: fig-stardardised_trends_beddays_icb
#| fig-cap: !expr get_caption_trends(cohort_title, "SR", "beddays", "icb")

icb_age_sex_standardised_rates_beddays<-tar_read(icb_age_sex_standardised_rates_beddays)

plotting_icb_over_time(
  (icb_age_sex_standardised_rates_beddays|> 
     filter(cohorts==cohort)|>
     mutate(activity=value)),
  'Standardised rate per 100,000')

```

<br>

```{r, fig.height=6, fig.width=8}
#| label: fig-percent_change_standardised_beddays
#| fig-cap: !expr get_caption_trends_percentage_change(cohort_title, "SR", "beddays") 

england_average_standardised_beddays<-calculating_england_average_standardised(england_age_sex_standardised_rates_beddays)


plotting_percentage_change_over_time_by_icb(icb_age_sex_standardised_rates_beddays|> 
     filter(cohorts==cohort), value, icb_2024_name, england_average_standardised_beddays$change, 1.5, 1.2)


```
:::
:::

### Change in age and sex standardised rate over time relative to level of activity

This chart shows the percentage change for each ICB relative to it's starting level of admissions/beddays to help demonstrate performance across ICBs. Those ICBs in the lower left quadrant (shaded in green) could be considered as performing well; they already had relatively low standardised rates of admissions/beddays in 2018/19 and have continued to make further decreases over the last five years.

::: panel-tabset
#### Admissions

```{r, fig.width=5, fig.height=4}
#| label: fig-activity_vs_rate_of_change_episodes
#| fig-cap: !expr get_caption_activity_vs_perc_change(cohort_title, "admissions")

plotting_total_activity_vs_percentage_change(icb_age_sex_standardised_rates_episodes, icb_2024_name)


```
#### Beddays

```{r, fig.width=5, fig.height=4}
#| label: fig-activity_vs_rate_of_change_beddays
#| fig-cap: !expr get_caption_activity_vs_perc_change(cohort_title, "beddays")  
#| 
plotting_total_activity_vs_percentage_change(icb_age_sex_standardised_rates_beddays, icb_2024_name)


```

:::

### Local Authority

Age and sex standardised rates of activity for local authority areas. 

::: panel-tabset
#### Admissions
```{r}
#| label: table-local_authority_over_time_episodes
#| fig-cap: !expr get_caption_la_trends(cohort_title, "admissions") 

la_age_sex_standardised_rates_episodes_over_time<-tar_read(la_age_sex_standardised_rates_episodes_over_time)

la_episode_table<-generating_la_table(la_age_sex_standardised_rates_episodes_over_time, cohort)

DT::datatable(la_episode_table)


```


#### Beddays
```{r}
#| label: table_local_authority_over_time_beddays
#| fig-cap: !expr get_caption_la_trends(cohort_title, "beddays")   

la_age_sex_standardised_rates_beddays_over_time<-tar_read(la_age_sex_standardised_rates_beddays_over_time)

la_beddays_table<-generating_la_table(la_age_sex_standardised_rates_beddays_over_time, cohort)

DT::datatable(la_beddays_table)

```

:::