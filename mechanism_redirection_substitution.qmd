# Redirection and Substitution

```{r}
library("flextable")
library("tidyr")
library("dplyr")
library("ggplot2")
library("StrategyUnitTheme")
library("forcats")
library("ComplexUpset")
library("scales")
library("targets")
library("plotly")
library("patchwork")

source("R/captions.R")
source("R/general.R")
source("R/descriptive_analyses.R")
source("R/comparative_analyses.R")
source("R/Functions for cohort overlap.R")
source("R/Functions for trend analysis.R")
source("R/manipulating_mitigators_and_mechanisms.R")

options(scipen = 999)
options(knitr.duplicate.label = "allow")
```

```{r global variables}
cohort <- "redirection_substitution"
cohort_title <- "Redirection and Substitution"
treatment_type <- "both"
treatment_type_title <- format_treatment_for_caption(treatment_type)
```

```{r}
#| output: false
mitigator_summary_table <- readxl::read_excel("summary_mitigators_table.xlsx") |>
  dplyr::mutate(mechanism = snakecase::to_snake_case(mechanism))

mechanisms <- mitigator_summary_table |> 
  dplyr::pull(mechanism) |> 
  unique()

england_age_sex_standardised_rates_episodes <- tar_read(england_age_sex_standardised_rates_episodes) |>
  filter(cohorts == cohort)

england_age_sex_standardised_rates_beddays <- tar_read(england_age_sex_standardised_rates_beddays) |>
  filter(cohorts == cohort)

total_beddays_admissions <- targets::tar_read(total_beddays_admissions)

icb_23_shp <- sf::st_read("https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/Integrated_Care_Boards_April_2023_EN_BGC/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson") |>
  janitor::clean_names() |>
  dplyr::mutate(icb23nm = simplify_icb_name(icb23nm))
```

```{r including_activity_types}
include_admissions <- check_include_admissions(cohort, mitigator_summary_table)
include_beddays <- check_include_beddays(cohort)
include_admissions_and_beddays <- include_admissions & include_beddays
```

This analysis includes mitigators where the mechanism of action is through Redirection/Substitution of activity. This means that some of the admissions in this group could be avoided by greater use of other services/provisions in the community (either existing or new).

The 16 mitigators included in this analysis are:

-   Ambulatory Care Sensitive Admissions: Acute Conditions / Chronic Conditions / Vaccine Preventable

-   End of Life Care Admissions: died within 2 days / died within 3-14 days

-   Falls Related Admissions

-   Frail Elderly Admissions: High Frailty Risk / Intermediate Frailty Risk

-   Medicines Related Admissions: Explicit / Implicit - Anti-Diabetics / Implicit - Benzodiazepines / Implicit - Diuretics / Implicit - NSAIDs

-   Emergency Readmissions Within 28 Days

-   Admission With No Overnight Stay and No Procedure: Adults / Children

```{r}
targets::tar_read(mitigator_totals) |>
  get_mitigators_in_a_mechanism_table(cohort)
```

## Descriptive Analysis of Mitigable Activity

```{r}
#| output: asis
knitr::knit_child(
  input = "child-dir/_child-descriptive_overview.qmd",
  envir = environment(),
  quiet = TRUE
  ) |>
  cat(sep = '\n')
```

### Patient Characteristics

::: panel-tabset
#### Age

```{r}
patient_characteristic <- "age"
patient_characteristic_col_name <- "age_range"
```

```{r}
#| output: asis
knitr::knit_child(
  input = "child-dir/_child-descriptive_patient-characteristics.qmd",
  envir = environment(),
  quiet = TRUE
  ) |>
  cat(sep = '\n')
```

#### Ethnicity

```{r}
patient_characteristic <- "ethnicity"
patient_characteristic_col_name <- "Ethnic_Category"
```

```{r}
#| output: asis
knitr::knit_child(
  input = "child-dir/_child-descriptive_patient-characteristics.qmd",
  envir = environment(),
  quiet = TRUE
  ) |>
  cat(sep = '\n')
```

#### IMD Decile

```{r}
patient_characteristic <- "imd"
patient_characteristic_col_name <- "imd19_decile"
```

```{r}
#| output: asis
knitr::knit_child(
  input = "child-dir/_child-descriptive_patient-characteristics.qmd",
  envir = environment(),
  quiet = TRUE
  ) |>
  cat(sep = '\n')
```

#### Sex

```{r}
patient_characteristic <- "sex"
patient_characteristic_col_name <- "sex"
```

```{r}
#| output: asis
knitr::knit_child(
  input = "child-dir/_child-descriptive_patient-characteristics.qmd",
  envir = environment(),
  quiet = TRUE
  ) |>
  cat(sep = '\n')
```
:::

### Admission Characteristics

```{r}
#| output: asis
knitr::knit_child(
  input = "child-dir/_child-descriptive_admission-characteristics.qmd",
  envir = environment(),
  quiet = TRUE
  ) |>
  cat(sep = '\n')
```

## Cohort overlap

Many admissions meet the criteria to be included in more than one mitigator cohort. Since these potential mitigator cohorts are not mutually exclusive there is a need to understand which cohorts overlap and the degree of overlap between the cohorts.

### Number and proportion within multiple other cohorts

For the Redirection/Substitution mechanism group we show how much of the activity is included in other Redirection/Substitution mitgators cohorts.

```{r}
overlap_numbers <- targets::tar_read(cohort_overlap_numbers_redirection)
```

```{r}
#| output: asis
knitr::knit_child(
  input = "child-dir/_child-overlap_number-within-others.qmd",
  envir = environment(),
  quiet = TRUE
  ) |>
  cat(sep = '\n')
```

### Most common cohort overlaps

Often overlap between a small number of groups can be visualised using Venn diagram. However, due to the large number of mitigator cohorts and therefore high numbers of potential combinations of overlaps we have used upset plots to show the largest overlaps between cohorts.

The 15 most common mitigator cohort combinations within the Redirection/Substitution mechanism group are shown.

```{r}
#| output: asis
knitr::knit_child(
  input = "child-dir/_child-overlap_most-common.qmd",
  envir = environment(),
  quiet = TRUE
  ) |>
  cat(sep = '\n')
```

## Comparative Analysis

### Integrated Care Board

```{r}
#| output: asis
knitr::knit_child(
                  input = "child-dir/_child-comparative_icb.qmd",
                  envir = environment(),
                  quiet = TRUE
                ) |>
                  cat(sep = '\n')
```

### Local Authority

```{r}
#| output: asis
knitr::knit_child(
                  input = "child-dir/_child-comparative_local-authority.qmd",
                  envir = environment(),
                  quiet = TRUE
                ) |>
                  cat(sep = '\n')
```

## Trend Analysis

We aim to understand whether there have been decreases, or increases, in potentially mitigable Redirection and Substitution activity over time. We have considered Redirection and Substitution admissions and beddays over the past 9 years in England as a whole and for each ICB, including:

a\) the absolute number of Redirection and Substitution admissions/beddays,

b\) these admissions/beddays as a proportion of total admissions,

c\) the age and sex standardised rates of these admissions/beddays using the England 2021 census population.

To help understand the variability between ICBs we have calculated for each ICB the percentage change in proportion of emergency admissions and in standardised rates between 2018/19 and 2023/24.

### England

```{r}
#| output: asis
knitr::knit_child(
  input = "child-dir/_child-trends_england.qmd",
  envir = environment(),
  quiet = TRUE
  ) |>
  cat(sep = '\n')
```

### Integrated Care Board

Note: Low numbers of admissions/beddays for Frimley ICB in 2022/23 reflect an issue with data submissions for this period.

```{r}
#| output: asis
knitr::knit_child(
  input = "child-dir/_child-trends_icb.qmd",
  envir = environment(),
  quiet = TRUE
  ) |>
  cat(sep = '\n')
```

### Local Authority

Age and sex standardised rates of activity per 100,000 population for local authority areas.

```{r}
#| output: asis
knitr::knit_child(
  input = "child-dir/_child-trends_local-authority.qmd",
  envir = environment(),
  quiet = TRUE
  ) |>
  cat(sep = '\n')
```
